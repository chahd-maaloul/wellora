{# templates/doctor/clinical-notes.html.twig #}
{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Notes Cliniques'|trans }} - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/analytics.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #dbeafe;
            --secondary: #059669;
            --secondary-light: #d1fae5;
            --accent: #7c3aed;
            --accent-light: #ede9fe;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --soap-s: #3b82f6;
            --soap-o: #10b981;
            --soap-a: #f59e0b;
            --soap-p: #ef4444;
            --soap-s-bg: #eff6ff;
            --soap-o-bg: #ecfdf5;
            --soap-a-bg: #fffbeb;
            --soap-p-bg: #fef2f2;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: var(--gray-800);
            min-height: 100vh;
            padding: 20px;
        }

        /* Dark mode styles */
        .dark body {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: #e5e7eb;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
        }

        .left-column { display: flex; flex-direction: column; gap: 24px; }

        .patient-card {
            background: white; border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-200);
        }

        /* Dark mode cards */
        .dark .patient-card {
            background: #1f2937;
            border-color: #374151;
        }

        .patient-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .patient-avatar {
            width: 72px; height: 72px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; font-weight: 600;
        }

        .patient-info h2 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
        .dark .patient-info h2 { color: #f3f4f6; }
        .patient-id { color: var(--gray-500); font-size: 14px; margin-bottom: 8px; }
        .status-badge {
            display: inline-flex; align-items: center; padding: 6px 12px;
            background: var(--secondary-light); color: var(--secondary);
            border-radius: 20px; font-size: 12px; font-weight: 600;
        }

        .notes-history {
            background: white; border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-200);
            max-height: 400px; overflow-y: auto;
        }

        .dark .notes-history {
            background: #1f2937;
            border-color: #374151;
        }

        .notes-history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 600; color: var(--gray-800); padding-bottom: 8px; }
        .dark .section-title { color: #f3f4f6; }
        
        .clear-history-btn {
            background: var(--danger-light); color: var(--danger); border: 1px solid var(--danger);
            border-radius: 8px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .clear-history-btn:hover { background: var(--danger); color: white; }

        .notes-list { display: flex; flex-direction: column; gap: 12px; }
        .note-item {
            padding: 16px; background: var(--gray-50); border-radius: 12px;
            border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s; position: relative;
        }
        .dark .note-item {
            background: #374151;
            border-color: #4b5563;
        }
        .note-item:hover { background: var(--gray-100); border-color: var(--gray-300); }
        .dark .note-item:hover { background: #4b5563; border-color: #6b7280; }
        .note-item.active { background: var(--primary-light); border-color: var(--primary); }
        .dark .note-item.active { background: #1e3a5f; border-color: #3b82f6; }
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .note-date { font-size: 12px; color: var(--gray-500); }
        .dark .note-date { color: #9ca3af; }
        
        /* Style de la croix de suppression */
        .note-delete-btn {
            background: none; border: none; color: var(--danger); cursor: pointer;
            padding: 4px; width: 24px; height: 24px; display: flex; align-items: center;
            justify-content: center; border-radius: 4px; opacity: 0; transition: all 0.2s;
        }
        .note-item:hover .note-delete-btn { opacity: 1; }
        .note-delete-btn:hover { background: var(--danger-light); }
        
        .note-title { font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
        .dark .note-title { color: #f3f4f6; }
        .note-summary { font-size: 12px; color: var(--gray-600); line-height: 1.4; }
        .dark .note-summary { color: #9ca3af; }

        .quick-actions {
            background: white; border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-200);
        }
        .dark .quick-actions {
            background: #1f2937;
            border-color: #374151;
        }
        .quick-actions-list { display: flex; flex-direction: column; gap: 12px; }
        .quick-action-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            background: var(--gray-50); border-radius: 12px; text-decoration: none;
            color: var(--gray-700); font-weight: 500; transition: all 0.2s;
            cursor: pointer; border: none; width: 100%; font-size: 14px;
        }
        .dark .quick-action-btn {
            background: #374151;
            color: #e5e7eb;
        }
        .quick-action-btn:hover { background: var(--gray-100); transform: translateY(-1px); }
        .dark .quick-action-btn:hover { background: #4b5563; }
        .quick-action-btn i { color: var(--primary); font-size: 18px; }

        .chatbot-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-200);
        }
        .dark .chatbot-card {
            background: #1f2937;
            border-color: #374151;
        }
        .chatbot-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 12px; }
        .chatbot-subtitle { font-size: 12px; color: var(--gray-500); }
        .dark .chatbot-subtitle { color: #9ca3af; }
        .chatbot-messages {
            max-height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px; padding: 12px;
        }
        .dark .chatbot-messages {
            background: #374151;
            border-color: #4b5563;
        }
        .chatbot-msg { font-size: 13px; line-height: 1.4; padding: 10px 12px; border-radius: 10px; max-width: 92%; }
        .chatbot-msg.bot { background: white; border: 1px solid var(--gray-200); color: var(--gray-800); align-self: flex-start; }
        .dark .chatbot-msg.bot { background: #1f2937; border-color: #4b5563; color: #e5e7eb; }
        .chatbot-msg.user { background: var(--primary-light); color: var(--primary); align-self: flex-end; }
        .dark .chatbot-msg.user { background: #1e3a5f; color: #bfdbfe; }
        .chatbot-choices { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .chatbot-chip {
            background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300);
            border-radius: 999px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s;
        }
        .dark .chatbot-chip { background: #374151; color: #e5e7eb; border-color: #4b5563; }
        .chatbot-chip:hover { background: var(--gray-200); }
        .dark .chatbot-chip:hover { background: #4b5563; }
        .chatbot-input { display: flex; gap: 8px; margin-top: 12px; }
        .chatbot-input input {
            flex: 1; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 10px;
            background: white; font-size: 13px;
        }
        .dark .chatbot-input input { background: #1f2937; border-color: #4b5563; color: #e5e7eb; }
        .chatbot-input button {
            padding: 10px 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600;
            cursor: pointer;
        }
        .chatbot-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
        .chatbot-reset {
            background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300);
            border-radius: 10px; padding: 8px 12px; font-size: 12px; cursor: pointer;
        }
        .dark .chatbot-reset { background: #374151; color: #e5e7eb; border-color: #4b5563; }
        .triage-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
        .triage-vert { background: var(--secondary-light); color: var(--secondary); }
        .triage-orange { background: var(--warning-light); color: var(--warning); }
        .triage-rouge { background: var(--danger-light); color: var(--danger); }
        .chatbot-disclaimer {
            margin-top: 10px; font-size: 11px; color: var(--gray-500);
        }
        .dark .chatbot-disclaimer { color: #9ca3af; }

        .right-column {
            background: white; border-radius: 16px; padding: 32px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); border: 1px solid var(--gray-200);
            max-height: calc(100vh - 100px); overflow-y: auto; scroll-behavior: smooth;
        }

        .dark .right-column {
            background: #1f2937;
            border-color: #374151;
        }

        .editor-header { margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--gray-200); }
        .dark .editor-header { border-bottom-color: #374151; }
        .editor-title { font-size: 24px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; }
        .dark .editor-title { color: #f3f4f6; }
        .editor-meta { color: var(--gray-500); font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .editor-meta::before { content: "‚Ä¢"; color: var(--gray-400); }

        .soap-section { margin-bottom: 32px; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .section-badge {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: 700;
            font-size: 16px; color: white; flex-shrink: 0;
        }
        .badge-s { background: var(--soap-s); }
        .badge-o { background: var(--soap-o); }
        .badge-a { background: var(--soap-a); }
        .badge-p { background: var(--soap-p); }
        .section-label { font-size: 18px; font-weight: 600; color: var(--gray-900); }
        .dark .section-label { color: #f3f4f6; }

        .form-group { margin-bottom: 24px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700); font-size: 14px; }
        .dark .form-label { color: #d1d5db; }
        .form-control {
            width: 100%; padding: 14px 16px; border: 2px solid var(--gray-300);
            border-radius: 12px; font-size: 15px; transition: all 0.2s; background: var(--gray-50);
        }
        .dark .form-control {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; }
        .dark .form-control:focus { background: #4b5563; border-color: #3b82f6; }
        .form-control::placeholder { color: var(--gray-400); }
        .dark .form-control::placeholder { color: #9ca3af; }
        textarea.form-control { min-height: 120px; resize: vertical; line-height: 1.6; }

        .chief-complaint-section .form-control { border-color: var(--gray-400); background: var(--gray-100); font-size: 16px; padding: 16px; }
        .dark .chief-complaint-section .form-control { background: #374151; border-color: #4b5563; }

        .vitals-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .vital-input label { display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px; font-weight: 500; }
        .dark .vital-input label { color: #9ca3af; }
        .bp-input-group { display: flex; align-items: center; gap: 8px; }
        .bp-input { flex: 1; }
        .bp-separator { color: var(--gray-400); font-weight: 500; }
        .dark .bp-separator { color: #9ca3af; }

        .diagnoses-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .diagnosis-tag {
            display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px;
            background: var(--soap-a-bg); color: var(--soap-a); border-radius: 20px;
            font-size: 13px; font-weight: 500; border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .dark .diagnosis-tag {
            background: #78350f;
            color: #fcd34d;
            border-color: rgba(245, 158, 11, 0.3);
        }
        .diagnosis-tag button { background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; }
        .diagnosis-input-group { display: flex; gap: 12px; }
        .diagnosis-input { flex: 1; }
        .btn-add { background: var(--soap-a); color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: 600; cursor: pointer; }

        .section-title-large { font-size: 20px; font-weight: 700; color: var(--gray-900); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .dark .section-title-large { color: #f3f4f6; }
        .btn-add-large {
            background: var(--soap-p); color: white; border: none; border-radius: 12px;
            padding: 12px 24px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px;
        }

        .medication-card, .exam-card {
            background: var(--soap-p-bg); border: 2px solid rgba(239, 68, 68, 0.2);
            border-radius: 16px; padding: 24px; margin-bottom: 20px;
        }
        .dark .medication-card, .dark .exam-card {
            background: #450a0a;
            border-color: rgba(239, 68, 68, 0.3);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--soap-p); }
        .dark .card-title { color: #fca5a5; }
        .btn-delete { background: var(--danger); color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-grid-full { grid-column: span 2; }
        .example-text { font-size: 12px; color: var(--gray-500); margin-top: 4px; }
        .dark .example-text { color: #9ca3af; }

        .followup-section { background: var(--gray-50); border: 2px solid var(--gray-300); border-radius: 16px; padding: 24px; margin-bottom: 32px; }
        .dark .followup-section { background: #374151; border-color: #4b5563; }
        .followup-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

        .empty-state { text-align: center; padding: 40px 20px; background: var(--gray-100); border: 2px dashed var(--gray-300); border-radius: 16px; color: var(--gray-500); }
        .dark .empty-state { background: #374151; border-color: #4b5563; color: #9ca3af; }
        
        .action-buttons { display: flex; gap: 12px; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--gray-200); }
        .dark .action-buttons { border-top-color: #374151; }
        .btn { padding: 14px 28px; border-radius: 12px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .dark .btn-secondary { background: #374151; color: #e5e7eb; }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px;
            color: white; font-weight: 500; z-index: 1000; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); animation: slideIn 0.3s ease;
        }
        .notification-success { background: var(--secondary); }
        .notification-error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .highlight-section { animation: highlight 1.5s ease; border-color: var(--primary) !important; }
        @keyframes highlight { 0% { box-shadow: 0 0 0 0 rgba(30, 64, 175, 0.4); } 100% { box-shadow: 0 0 0 0 rgba(30, 64, 175, 0); } }

        .confirmation-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .confirmation-content { background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; }
        .dark .confirmation-content { background: #1f2937; }

        /* Select dropdown - remove default arrow */
        select.form-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none;
            padding-right: 16px;
        }

        /* Scrollbar dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container">
    <!-- Left Column -->
    <div class="left-column">
        <div class="patient-card">
            <div class="patient-header">
                <div class="patient-avatar" id="patientAvatar">
                    {% if patientData is defined and patientData %}
                        {{ patientData.name|slice(0, 2)|upper }}
                    {% else %}
                        JD
                    {% endif %}
                </div>
                <div class="patient-info">
                    <h2 id="patientName">
                        {% if patientData is defined and patientData %}
                            {{ patientData.name }}
                        {% else %}
                            S√©lectionner un patient
                        {% endif %}
                    </h2>
                    <p class="patient-id" id="patientId">
                        {% if patientData is defined and patientData %}
                            {{ patientData.id|slice(0, 8)|upper }}
                        {% else %}
                            --
                        {% endif %}
                    </p>
                    <span class="status-badge">Actif</span>
                </div>
            </div>
            <div class="form-group chief-complaint-section">
                <label class="form-label">Motif de consultation</label>
                <input type="text" class="form-control" id="chiefComplaint" placeholder="Motif principal...">
            </div>
        </div>

        <div class="notes-history">
            <div class="notes-history-header">
                <h3 class="section-title">Historique des notes</h3>
                <button class="clear-history-btn" onclick="clearAllHistory()"><i class="fas fa-trash"></i> Tout effacer</button>
            </div>
            <div class="notes-list" id="notesList">
                <!-- Les notes seront inject√©es ici par le script -->
            </div>
            <div id="emptyNotes" class="empty-state" style="display: none;">
                <i class="fas fa-notes-medical"></i>
                <p>Aucune note dans l'historique</p>
            </div>
        </div>

        <div class="quick-actions">
            <h3 class="section-title">Actions rapides</h3>
            <div class="quick-actions-list">
                <button class="quick-action-btn" onclick="resetForm()">
                    <i class="fas fa-plus"></i><span>Nouvelle note</span>
                </button>
                <button class="quick-action-btn" onclick="scrollToMedications()">
                    <i class="fas fa-prescription"></i><span>Nouvelle ordonnance</span>
                </button>
            </div>
        </div>

        <div class="chatbot-card" id="preconsultChatbot">
            <div class="chatbot-header">
                <h3 class="section-title">Pr√©consultation</h3>
                <span class="chatbot-subtitle">Orientation rapide</span>
            </div>
            <div class="chatbot-messages" id="chatbotMessages" aria-live="polite"></div>
            <div class="chatbot-choices" id="chatbotChoices"></div>
            <div class="chatbot-actions">
                <button class="chatbot-reset" onclick="resetChatbot()">Recommencer</button>
            </div>
            <div class="chatbot-disclaimer">
                Cet outil ne remplace pas un avis m√É¬©dical. En cas de doute ou d'urgence, contactez les services d'urgence.
            </div>
        </div>
    </div>

    <!-- Right Column - Editor -->
    <div class="right-column" id="editorContainer">
        <div class="editor-header">
            <h1 class="editor-title" id="mainEditorTitle">Nouvelle Note SOAP</h1>
            <div class="editor-meta">
                <span>{{ "now"|date("d/m/Y") }}</span>
                <span>‚Ä¢ Dr. {{ app.user.firstName }} {{ app.user.lastName }}</span>
            </div>
        </div>

        <!-- Subjective (S) -->
        <div class="soap-section">
            <div class="section-header">
                <div class="section-badge badge-s">S</div>
                <h2 class="section-label">Subjectif</h2>
            </div>
            <textarea class="form-control" id="subjective" placeholder="Sympt√¥mes rapport√©s..."></textarea>
        </div>

        <!-- Objective (O) -->
        <div class="soap-section">
            <div class="section-header">
                <div class="section-badge badge-o">O</div>
                <h2 class="section-label">Objectif</h2>
            </div>
            <div class="vitals-grid">
                <div class="vital-input">
                    <label>Tension (mmHg)</label>
                    <div class="bp-input-group">
                        <input type="text" class="form-control bp-input" id="bpSystolic" value="120">
                        <span class="bp-separator">/</span>
                        <input type="text" class="form-control bp-input" id="bpDiastolic" value="80">
                    </div>
                </div>
                <div class="vital-input"><label>Pouls (bpm)</label><input type="text" class="form-control" id="pulse" value="72"></div>
                <div class="vital-input"><label>Temp√©rature (¬∞C)</label><input type="text" class="form-control" id="temperature" value="37"></div>
                <div class="vital-input"><label>SpO2 (%)</label><input type="text" class="form-control" id="spo2" value="99"></div>
            </div>
            <textarea class="form-control" id="objective" placeholder="Examen physique..."></textarea>
        </div>

        <!-- Assessment (A) -->
        <div class="soap-section">
            <div class="section-header">
                <div class="section-badge badge-a">A</div>
                <h2 class="section-label">√âvaluation</h2>
            </div>
            <div class="diagnoses-section">
                <label class="form-label">Diagnostics (CIM-10)</label>
                <div class="diagnoses-tags" id="diagnosesTags"></div>
                <div class="diagnosis-input-group">
                    <input type="text" class="form-control diagnosis-input" id="newDiagnosis" placeholder="Code CIM-10...">
                    <button class="btn-add" onclick="addDiagnosis()">Ajouter</button>
                </div>
            </div>
            <textarea class="form-control" id="assessment" placeholder="Interpr√©tation..."></textarea>
        </div>

        <!-- Plan (P) -->
        <div class="soap-section">
            <div class="section-header">
                <div class="section-badge badge-p">P</div>
                <h2 class="section-label">Plan</h2>
            </div>

            <!-- Medications -->
            <div class="medications-section" id="medicationsSection">
                <h3 class="section-title-large"><i class="fas fa-prescription"></i> Ordonnance M√©dicamenteuse</h3>
                <button class="btn-add-large" onclick="addMedicationCard(true)"><i class="fas fa-plus"></i> Ajouter un m√©dicament</button>
                <div id="medicationsContainer"></div>
                <div id="emptyMedications" class="empty-state" style="display: block;">
                    <i class="fas fa-prescription-bottle-alt"></i><p>Aucun m√©dicament prescrit</p>
                </div>
            </div>

            <!-- Lab Tests -->
            <div class="lab-tests-section" id="examsSection">
                <h3 class="section-title-large"><i class="fas fa-flask"></i> Examens Compl√©mentaires</h3>
                <button class="btn-add-large" onclick="addExamCard(true)"><i class="fas fa-plus"></i> Ajouter un examen</button>
                <div id="examsContainer"></div>
                <div id="emptyExams" class="empty-state" style="display: block;">
                    <i class="fas fa-flask"></i><p>Aucun examen demand√©</p>
                </div>
            </div>

            <div class="treatment-plan-section">
                <label class="form-label">Plan de traitement g√©n√©ral</label>
                <textarea class="form-control" id="plan" placeholder="Recommandations..."></textarea>
            </div>

            <div class="followup-section">
                <h3>Prochain rendez-vous</h3>
                <div class="followup-grid">
                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-control" id="followUpDate"></div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-control" id="followUpType">
                            <option value="consultation">Consultation</option>
                            <option value="control" selected>Contr√¥le</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <select class="form-control" id="followUpPriority">
                            <option value="routine">Routine</option>
                            <option value="urgent" selected>Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveNoteToServer()">
                <i class="fas fa-save"></i> <span id="saveBtnText">Enregistrer</span>
            </button>
            <button class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-redo"></i> R√©initialiser
            </button>
        </div>
    </div>
</div>

<script>
    // √âTAT GLOBAL
    let currentEditingId = null; 
    let medCounter = 0;
    let examCounter = 0;
    
    // Donn√©es du patient
    const patientData = {{ patientData|default(null)|json_encode|raw }};
    
    // Historique depuis la base
    let notesData = {{ historyData|default([])|json_encode|raw }};

    const currentNote = {{ currentNoteData|default(null)|json_encode|raw }};

    document.addEventListener('DOMContentLoaded', () => {
        // Afficher les informations du patient si disponibles
        if (patientData && patientData.name) {
            document.getElementById('patientName').textContent = patientData.name;
            document.getElementById('patientAvatar').textContent = patientData.name.substring(0, 2).toUpperCase();
            if (patientData.id) {
                document.getElementById('patientId').textContent = patientData.id.substring(0, 8).toUpperCase();
            }
        }
        
        renderHistory();
        updateDiagnosisSelects();
        
        // Charger les donn√©es de la note existante
        if (currentNote && currentNote.id) {
            console.log('Loading current note:', currentNote);
            currentEditingId = currentNote.id;
            document.getElementById('mainEditorTitle').textContent = `Modifier la Note #${currentNote.id}`;
            document.getElementById('saveBtnText').textContent = "Mettre √† jour";
            
            // Remplir le formulaire avec les donn√©es existantes
            document.getElementById('chiefComplaint').value = currentNote.chiefComplaint || '';
            document.getElementById('subjective').value = currentNote.subjective || '';
            document.getElementById('objective').value = currentNote.objective || '';
            document.getElementById('assessment').value = currentNote.assessment || '';
            document.getElementById('plan').value = currentNote.plan || '';
            
            // Remplir les signes vitaux
            const vitals = currentNote.vitals || {};
            const bp = vitals.bloodPressure || {};
            document.getElementById('bpSystolic').value = bp.systolic ?? vitals.bloodPressureSystolic ?? '';
            document.getElementById('bpDiastolic').value = bp.diastolic ?? vitals.bloodPressureDiastolic ?? '';
            document.getElementById('pulse').value = vitals.pulse ?? vitals.heartRate ?? '';
            document.getElementById('temperature').value = vitals.temperature ?? '';
            document.getElementById('spo2').value = vitals.spo2 ?? vitals.oxygenSaturation ?? '';
            
            // Remplir les diagnostics
            if (currentNote.diagnoses && currentNote.diagnoses.length > 0) {
                currentNote.diagnoses.forEach(dx => addDiagnosis(dx));
            }
            
            // Remplir les m√©dicaments
            if (currentNote.medications && currentNote.medications.length > 0) {
                document.getElementById('emptyMedications').style.display = 'none';
                currentNote.medications.forEach(m => {
                    addMedicationCard();
                    const last = document.querySelector('#medicationsContainer .medication-card:last-child');
                    if (last) {
                        last.querySelector('.medication-name').value = m.name || '';
                        last.querySelector('.medication-dosage').value = m.dosage || '';
                        last.querySelector('.medication-form').value = m.form || '';
                        last.querySelector('.medication-frequency').value = m.frequency || '';
                        last.querySelector('.medication-duration').value = m.duration || '';
                        last.querySelector('.medication-instructions').value = m.instructions || '';
                        last.querySelector('.medication-diagnosis').value = m.associatedDiagnosis || '';
                    }
                });
            }
            
            // Remplir les examens
            if (currentNote.labTests && currentNote.labTests.length > 0) {
                document.getElementById('emptyExams').style.display = 'none';
                currentNote.labTests.forEach(e => {
                    addExamCard();
                    const last = document.querySelector('#examsContainer .exam-card:last-child');
                    if (last) {
                        last.querySelector('.exam-type').value = e.type || '';
                        last.querySelector('.exam-name').value = e.name || '';
                        last.querySelector('.exam-requested-date').value = e.requestedDate || '';
                        last.querySelector('.exam-status').value = e.status || '';
                        last.querySelector('.exam-notes').value = e.notes || '';
                    }
                });
            }
            
            // Remplir le suivi
            if (currentNote.followUp) {
                document.getElementById('followUpDate').value = currentNote.followUp.date || '';
                document.getElementById('followUpType').value = currentNote.followUp.type || 'control';
                document.getElementById('followUpPriority').value = currentNote.followUp.priority || 'routine';
            }
        }
    });

    // --- MISE √Ä JOUR (UPDATE) ---
    function selectNote(id) {
        const note = notesData.find(n => n.id === id);
        if (!note) return;

        currentEditingId = id;
        
        document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
        const activeItem = document.querySelector(`[data-note-id="${id}"]`);
        if(activeItem) activeItem.classList.add('active');
        
        document.getElementById('mainEditorTitle').textContent = `Modifier la Note #${id}`;
        document.getElementById('saveBtnText').textContent = "Mettre √† jour";

        fillFormWithData(note.data);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function fillFormWithData(data) {
        document.getElementById('diagnosesTags').innerHTML = '';
        document.getElementById('medicationsContainer').innerHTML = '';
        document.getElementById('examsContainer').innerHTML = '';

        document.getElementById('chiefComplaint').value = data.consultation.chiefComplaint || '';
        document.getElementById('subjective').value = data.consultation.subjective || '';
        document.getElementById('objective').value = data.consultation.objective || '';
        document.getElementById('assessment').value = data.consultation.assessment || '';
        document.getElementById('plan').value = data.consultation.plan || '';

        const vitals = data.consultation.vitals || {};
        const bp = vitals.bloodPressure || {};
        document.getElementById('bpSystolic').value = bp.systolic ?? vitals.bloodPressureSystolic ?? '';
        document.getElementById('bpDiastolic').value = bp.diastolic ?? vitals.bloodPressureDiastolic ?? '';
        document.getElementById('pulse').value = vitals.pulse ?? vitals.heartRate ?? '';
        document.getElementById('temperature').value = vitals.temperature ?? '';
        document.getElementById('spo2').value = vitals.spo2 ?? vitals.oxygenSaturation ?? '';

        if (data.diagnoses) data.diagnoses.forEach(dx => addDiagnosis(dx));

        if (data.medications && data.medications.length > 0) {
            document.getElementById('emptyMedications').style.display = 'none';
            data.medications.forEach(m => {
                addMedicationCard();
                const last = document.querySelector('#medicationsContainer .medication-card:last-child');
                last.querySelector('.medication-name').value = m.name;
                last.querySelector('.medication-dosage').value = m.dosage;
                last.querySelector('.medication-form').value = m.form;
                last.querySelector('.medication-frequency').value = m.frequency;
                last.querySelector('.medication-duration').value = m.duration;
                last.querySelector('.medication-instructions').value = m.instructions;
                last.querySelector('.medication-diagnosis').value = m.associatedDiagnosis || '';
            });
        } else { document.getElementById('emptyMedications').style.display = 'block'; }

        if (data.labTests && data.labTests.length > 0) {
            document.getElementById('emptyExams').style.display = 'none';
            data.labTests.forEach(e => {
                addExamCard();
                const last = document.querySelector('#examsContainer .exam-card:last-child');
                last.querySelector('.exam-type').value = e.type;
                last.querySelector('.exam-name').value = e.name;
                last.querySelector('.exam-requested-date').value = e.requestedDate || '';
                last.querySelector('.exam-status').value = e.status;
                last.querySelector('.exam-notes').value = e.notes || '';
            });
        } else { document.getElementById('emptyExams').style.display = 'block'; }

        if (data.followUp) {
            document.getElementById('followUpDate').value = data.followUp.date;
            document.getElementById('followUpType').value = data.followUp.type;
            document.getElementById('followUpPriority').value = data.followUp.priority;
        }
        updateDiagnosisSelects();
    }

    // --- ENREGISTREMENT ---
    async function saveNoteToServer() {
        const data = generateJSON();
        // Use the actual patient ID from patientData if available
        if (patientData && patientData.id) {
            data.patientId = patientData.id;
        }

        if (currentEditingId) data.noteId = currentEditingId;

        try {
            showNotification('Sauvegarde...', 'info');
            // On utilise l'URL en dur ou une variable globale si path() √©choue dynamiquement en JS
            const url = currentEditingId ? '{{ path("doctor_update_clinical_note") }}' : '{{ path("doctor_save_clinical_note") }}';
            const method = currentEditingId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                showNotification('Succ√®s !', 'success');
                if (!currentEditingId) {
                    notesData.unshift({ id: result.consultationId, date: new Date().toLocaleDateString(), title: "Note SOAP", summary: data.consultation.chiefComplaint, data: data });
                } else {
                    const idx = notesData.findIndex(n => n.id === currentEditingId);
                    if(idx !== -1) notesData[idx].data = data;
                }
                renderHistory();
                resetForm();
            } else {
                showNotification('Erreur: ' + result.message, 'error');
            }
        } catch (e) {
            showNotification('Erreur de connexion', 'error');
        }
    }

    // --- SUPPRESSION ---
    async function deleteNote(event, id) {
        event.stopPropagation(); // √âvite de s√©lectionner la note en cliquant sur le X
        if (!confirm('Supprimer cette note de la base de donn√©es ?')) return;

        try {
            const deleteUrlBase = '{{ path('api_clinical_note_delete', {'id': 0}) }}';
            const response = await fetch(deleteUrlBase.replace('0', id), { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                showNotification('Note supprim√©e', 'success');
                notesData = notesData.filter(n => n.id !== id);
                if (currentEditingId === id) resetForm();
                renderHistory();
            } else {
                showNotification('Erreur: ' + result.message, 'error');
            }
        } catch (e) {
            showNotification('Erreur serveur', 'error');
        }
    }

    // --- STRUCTURES DYNAMIQUES ---
    function renderHistory() {
        const list = document.getElementById('notesList');
        list.innerHTML = '';
        if (notesData.length === 0) {
            document.getElementById('emptyNotes').style.display = 'block';
            return;
        }
        document.getElementById('emptyNotes').style.display = 'none';
        notesData.forEach(note => {
            const item = document.createElement('div');
            item.className = `note-item ${currentEditingId === note.id ? 'active' : ''}`;
            item.setAttribute('data-note-id', note.id);
            item.innerHTML = `
                <div class="note-header">
                    <div class="note-date">${note.date}</div>
                    <button class="note-delete-btn" onclick="deleteNote(event, ${note.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="note-title">${note.title}</div>
                <div class="note-summary">${note.summary}</div>
            `;
            item.onclick = () => selectNote(note.id);
            list.appendChild(item);
        });
    }

    function addMedicationCard(scroll = false) {
        document.getElementById('emptyMedications').style.display = 'none';
        medCounter++;
        const card = document.createElement('div');
        card.className = 'medication-card';
        card.innerHTML = `
            <div class="card-header"><h4 class="card-title">M√©dicament</h4><button class="btn-delete" onclick="removeMedication(this)"><i class="fas fa-trash"></i> Supprimer</button></div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Diagnostic associ√©</label><select class="form-control medication-diagnosis"><option value="">S√©lectionner</option></select></div>
                <div class="form-group"><label class="form-label">Nom du m√©dicament</label><input type="text" class="form-control medication-name"></div>
                <div class="form-group"><label class="form-label">Dosage</label><input type="text" class="form-control medication-dosage"></div>
                <div class="form-group"><label class="form-label">Forme</label><select class="form-control medication-form"><option value="comprim√©">Comprim√©</option><option value="g√©lule">G√©lule</option></select></div>
                <div class="form-group"><label class="form-label">Fr√©quence</label><select class="form-control medication-frequency"><option value="1x/jour">1x/jour</option><option value="2x/jour">2x/jour</option></select></div>
                <div class="form-group"><label class="form-label">Dur√©e</label><input type="text" class="form-control medication-duration"></div>
                <div class="form-group form-grid-full"><label class="form-label">Instructions</label><textarea class="form-control medication-instructions"></textarea></div>
            </div>`;
        document.getElementById('medicationsContainer').appendChild(card);
        updateDiagnosisSelects();
        if(scroll) card.scrollIntoView({behavior:'smooth'});
    }

    function addExamCard(scroll = false) {
        document.getElementById('emptyExams').style.display = 'none';
        examCounter++;
        const card = document.createElement('div');
        card.className = 'exam-card';
        card.innerHTML = `
            <div class="card-header"><h4 class="card-title">Examen</h4><button class="btn-delete" onclick="removeExam(this)"><i class="fas fa-trash"></i> Supprimer</button></div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Type</label><select class="form-control exam-type" onchange="updateExamNameFromType(this)">
                    <optgroup label="üß¨ Examens biologiques">
                        <option value="nfs">NFS (Num√©ration Formule Sanguine)</option>
                        <option value="bilan_lipidique">Bilan lipidique (Cholest√©rol, Triglyc√©rides)</option>
                        <option value="bilan_hepatique">Bilan h√©patique (Transaminases, Gamma GT)</option>
                        <option value="bilan_renal">Bilan r√©nal (Cr√©atinine, Ur√©e)</option>
                        <option value="glycemie_hba1c">Glyc√©mie, HbA1c (Diab√®te)</option>
                        <option value="serologies">S√©rologies (VIH, H√©patites)</option>
                        <option value="ecbu">Examens urinaires (ECBU)</option>
                        <option value="hormones">Hormones (TSH, cortisol)</option>
                    </optgroup>
                    <optgroup label="üß† Examens d'imagerie m√©dicale">
                        <option value="irm">IRM (avec compte-rendu texte + images)</option>
                        <option value="scanner">Scanner (TDM)</option>
                        <option value="radiographie">Radiographie (Rayons X)</option>
                        <option value="echographie">√âchographie (Abdominale, pelvienne, obst√©tricale)</option>
                        <option value="mammographie">Mammographie</option>
                        <option value="osteodensitometrie">Ost√©odensitom√©trie (densit√© osseuse)</option>
                    </optgroup>
                    <optgroup label="‚ù§Ô∏è Examens cardiovasculaires">
                        <option value="ecg">√âlectrocardiogramme (ECG)</option>
                        <option value="holter">Holter (rythme cardiaque sur 24h)</option>
                        <option value="echocardiographie">√âchocardiographie</option>
                        <option value="epreuve_effort">√âpreuve d'effort</option>
                        <option value="coronarographie">Coronarographie</option>
                    </optgroup>
                </select></div>
                <div class="form-group"><label class="form-label">Nom / D√©tails</label><input type="text" class="form-control exam-name" placeholder="Pr√©cisions suppl√©mentaires..."></div>
                <div class="form-group"><label class="form-label">Date demand√©e</label><input type="date" class="form-control exam-requested-date"></div>
                <div class="form-group"><label class="form-label">Statut</label><select class="form-control exam-status"><option value="prescrit">Prescrit</option><option value="realise">R√©alis√©</option></select></div>
                <div class="form-group form-grid-full"><label class="form-label">Notes</label><textarea class="form-control exam-notes"></textarea></div>
            </div>`;
        document.getElementById('examsContainer').appendChild(card);
        if(scroll) card.scrollIntoView({behavior:'smooth'});
    }

    function updateExamNameFromType(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const card = selectElement.closest('.exam-card');
        const nameInput = card.querySelector('.exam-name');
        // Auto-fill the name with the selected exam type text if name is empty
        if (nameInput && !nameInput.value) {
            nameInput.value = selectedOption.text;
        }
    }

    function removeMedication(btn) { btn.closest('.medication-card').remove(); if(!document.querySelector('.medication-card')) document.getElementById('emptyMedications').style.display='block'; }
    function removeExam(btn) { btn.closest('.exam-card').remove(); if(!document.querySelector('.exam-card')) document.getElementById('emptyExams').style.display='block'; }

    function addDiagnosis(val = null) {
        const input = document.getElementById('newDiagnosis');
        const text = val || input.value.trim();
        if (!text) return;
        const tag = document.createElement('div');
        tag.className = 'diagnosis-tag';
        tag.innerHTML = `${text} <button onclick="this.parentElement.remove(); updateDiagnosisSelects();">√ó</button>`;
        document.getElementById('diagnosesTags').appendChild(tag);
        input.value = '';
        updateDiagnosisSelects();
    }

    function updateDiagnosisSelects() {
        const dxs = Array.from(document.querySelectorAll('.diagnosis-tag')).map(t => t.innerText.replace('√ó','').trim());
        document.querySelectorAll('.medication-diagnosis').forEach(sel => {
            const current = sel.value;
            sel.innerHTML = '<option value="">S√©lectionner</option>' + dxs.map(d => `<option value="${d}">${d}</option>`).join('');
            sel.value = current;
        });
    }

    function resetForm() {
        currentEditingId = null;
        document.getElementById('mainEditorTitle').textContent = "Nouvelle Note SOAP";
        document.getElementById('saveBtnText').textContent = "Enregistrer";
        document.querySelectorAll('input:not(.bp-input), textarea').forEach(i => i.value = '');
        document.getElementById('bpSystolic').value = '120';
        document.getElementById('bpDiastolic').value = '80';
        document.getElementById('pulse').value = '72';
        document.getElementById('temperature').value = '37';
        document.getElementById('spo2').value = '99';
        document.getElementById('diagnosesTags').innerHTML = '';
        document.getElementById('medicationsContainer').innerHTML = '';
        document.getElementById('examsContainer').innerHTML = '';
        document.getElementById('emptyMedications').style.display = 'block';
        document.getElementById('emptyExams').style.display = 'block';
        document.querySelectorAll('.note-item').forEach(n => n.classList.remove('active'));
    }

    function generateJSON() {
        return {
            consultation: {
                chiefComplaint: document.getElementById('chiefComplaint').value,
                subjective: document.getElementById('subjective').value,
                objective: document.getElementById('objective').value,
                assessment: document.getElementById('assessment').value,
                plan: document.getElementById('plan').value,
                vitals: {
                    bloodPressure: { systolic: document.getElementById('bpSystolic').value, diastolic: document.getElementById('bpDiastolic').value },
                    pulse: document.getElementById('pulse').value, temperature: document.getElementById('temperature').value, spo2: document.getElementById('spo2').value
                }
            },
            diagnoses: Array.from(document.querySelectorAll('.diagnosis-tag')).map(t => t.innerText.replace('√ó','').trim()),
            medications: Array.from(document.querySelectorAll('.medication-card')).map(c => ({
                associatedDiagnosis: c.querySelector('.medication-diagnosis').value,
                name: c.querySelector('.medication-name').value,
                dosage: c.querySelector('.medication-dosage').value,
                form: c.querySelector('.medication-form').value,
                frequency: c.querySelector('.medication-frequency').value,
                duration: c.querySelector('.medication-duration').value,
                instructions: c.querySelector('.medication-instructions').value
            })),
            labTests: Array.from(document.querySelectorAll('.exam-card')).map(c => ({
                type: c.querySelector('.exam-type').value, name: c.querySelector('.exam-name').value,
                requestedDate: c.querySelector('.exam-requested-date').value, status: c.querySelector('.exam-status').value, notes: c.querySelector('.exam-notes').value
            })),
            followUp: {
                date: document.getElementById('followUpDate').value,
                type: document.getElementById('followUpType').value,
                priority: document.getElementById('followUpPriority').value
            }
        };
    }

    function showNotification(m, t) {
        const n = document.createElement('div'); n.className = `notification notification-${t}`;
        n.innerHTML = `<i class="fas fa-info-circle"></i> ${m}`; document.body.appendChild(n);
        setTimeout(() => n.remove(), 3000);
    }
    function scrollToMedications() { document.getElementById('medicationsSection').scrollIntoView({behavior:'smooth'}); }
</script>
{% endblock %}

