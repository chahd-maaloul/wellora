{% extends 'layouts/app.html.twig' %}

{% block title %}Planificateur de repas - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('nutrition-css') }}
{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900{% endblock %}

{% block body %}
<div class="min-h-screen py-8">
    <div class="px-4 mx-auto max-w-7xl">
        {# Header #}
        <div class="flex flex-col gap-4 mb-8 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    <i class="mr-2 text-wellcare-500 fas fa-calendar-alt"></i>
                    Planificateur de repas
                </h1>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Planifiez et suivez vos repas hebdomadaire</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="{{ path('nutrition_dashboard') }}" 
                   class="inline-flex items-center px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i class="mr-2 fas fa-arrow-left"></i>
                    Retour
                </a>
            </div>
        </div>

        {# Flash Messages #}
        {% for message in app.flashes('success') %}
            <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <i class="mr-2 fas fa-check-circle"></i>{{ message }}
            </div>
        {% endfor %}

        {# Quick Actions #}
        <div class="flex flex-wrap gap-3 mb-6">
            <a href="{{ path('nutrition_ai_assistant') }}" 
               class="inline-flex items-center px-4 py-2 font-medium text-white transition-colors rounded-lg bg-purple-500 hover:bg-purple-600 shadow-md">
                <i class="mr-2 fas fa-robot"></i>Assistant AI
            </a>
            <a href="{{ path('nutrition_quick_log') }}" 
               class="inline-flex items-center px-4 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600 shadow-md">
                <i class="mr-2 fas fa-plus"></i>Ajouter un repas
            </a>
            <a href="{{ path('nutrition_nutrition_recipes') }}" 
               class="inline-flex items-center px-4 py-2 font-medium text-white transition-colors bg-green-500 rounded-lg hover:bg-green-600 shadow-md">
                <i class="mr-2 fas fa-book"></i>Recettes
            </a>
            <a href="{{ path('nutrition_grocery_list') }}" 
               class="inline-flex items-center px-4 py-2 font-medium text-white transition-colors bg-blue-500 rounded-lg hover:bg-blue-600 shadow-md">
                <i class="mr-2 fas fa-shopping-cart"></i>Liste de courses
            </a>
        </div>

        {# Week Navigation #}
        <div class="flex items-center justify-between mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md">
            <a href="{{ path('nutrition_meal_planner_week', {offset: offset|default(0) - 1}) }}" 
               class="inline-flex items-center px-4 py-2 text-gray-700 border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                <i class="mr-2 fas fa-chevron-left"></i>Semaine précédente
            </a>
            <div class="text-center">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                    {% if weekStart|default(null) %}
                        {{ weekStart|date('d') }} - {{ weekEnd|date('d M') }}
                    {% else %}
                        Cette semaine
                    {% endif %}
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {% if offset|default(0) == 0 %}
                        Semaine en cours
                    {% elseif offset|default(0) < 0 %}
                        Il y a {{ (-offset|default(0)) }} semaine(s)
                    {% else %}
                        Dans {{ offset|default(0) }} semaine(s)
                    {% endif %}
                </p>
            </div>
            <a href="{{ path('nutrition_meal_planner_week', {offset: offset|default(0) + 1}) }}" 
               class="inline-flex items-center px-4 py-2 text-gray-700 border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                Semaine suivante<i class="ml-2 fas fa-chevron-right"></i>
            </a>
        </div>

        {# Weekly Stats #}
        {% if weeklyStats|default(null) and weeklyStats.totalMeals > 0 %}
        <div class="mb-6 p-6 bg-gradient-to-r from-wellcare-500 to-wellcare-600 rounded-xl shadow-lg text-white">
            <h2 class="mb-4 text-lg font-semibold">
                <i class="mr-2 fas fa-chart-bar"></i>
                Statistiques de la semaine
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <p class="text-3xl font-bold">{{ weeklyStats.totalCalories }}</p>
                    <p class="text-sm text-white/80">Calories</p>
                </div>
                <div class="text-center p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <p class="text-3xl font-bold">{{ weeklyStats.totalProtein }}g</p>
                    <p class="text-sm text-white/80">Protéines</p>
                </div>
                <div class="text-center p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <p class="text-3xl font-bold">{{ weeklyStats.totalCarbs }}g</p>
                    <p class="text-sm text-white/80">Glucides</p>
                </div>
                <div class="text-center p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <p class="text-3xl font-bold">{{ weeklyStats.totalFats }}g</p>
                    <p class="text-sm text-white/80">Lipides</p>
                </div>
                <div class="text-center p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <p class="text-3xl font-bold">{{ weeklyStats.totalMeals }}</p>
                    <p class="text-sm text-white/80">Repas</p>
                </div>
            </div>
        </div>
        {% endif %}

        {# Week Days Grid #}
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7">
            {# Day Cards #}
            {% set dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
            {% set dayLabels = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'] %}
            
            {% for i in 0..6 %}
            {% set dayKey = dayNames[i] %}
            {% set dayLabel = dayLabels[i] %}
            {% set dayMeals = attribute(days, dayKey)|default([]) %}
            {% set todayDay = "now"|date('l') %}
            {% set isToday = dayKey == todayDay and offset|default(0) == 0 %}
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-2 {% if isToday %}border-wellcare-500{% else %}border-transparent{% endif %}">
                {# Day Header #}
                <div class="p-3 {% if isToday %}bg-wellcare-500{% else %}bg-gray-100 dark:bg-gray-700{% endif %}">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold {% if isToday %}text-white{% else %}text-gray-900 dark:text-white{% endif %}">
                            {{ dayLabel }}
                        </h3>
                        {% if isToday %}
                        <span class="px-2 py-0.5 text-xs font-medium bg-white text-wellcare-500 rounded-full">Aujourd'hui</span>
                        {% endif %}
                    </div>
                    {% if attribute(days, dayKey)|default([])|length > 0 %}
                    <p class="text-xs {% if isToday %}text-white/70{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                        {% set dayCalories = 0 %}
                        {% for meal in attribute(days, dayKey)|default([]) %}
                            {% set dayCalories = dayCalories + meal.calories %}
                        {% endfor %}
                        {{ dayCalories }} kcal
                    </p>
                    {% endif %}
                </div>
                
                {# Meals List #}
                <div class="p-3 space-y-2 min-h-[200px]">
                    {# Breakfast #}
                    {% set breakfastMeals = dayMeals|filter(m => m.mealType == 'breakfast') %}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="font-medium text-orange-600 dark:text-orange-400">
                                <i class="fas fa-coffee mr-1"></i>Petit-déj
                            </span>
                            <a href="{{ path('nutrition_food_add', {meal: 'breakfast'}) }}" class="text-gray-400 hover:text-orange-500">
                                <i class="fas fa-plus-circle"></i>
                            </a>
                        </div>
                        {% for meal in breakfastMeals %}
                        <div class="group relative p-2 bg-orange-50 dark:bg-orange-900/20 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors {% if meal.isCompleted %}line-through opacity-60{% endif %}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-gray-900 dark:text-white truncate">{{ meal.name }}</p>
                                    <p class="text-xs text-gray-500">{{ meal.calories }} kcal</p>
                                </div>
                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="{{ path('nutrition_meal_plan_toggle', {id: meal.id}) }}" class="p-1 text-green-500 hover:text-green-700" title="Marquer comme mangé">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    <a href="{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}" class="p-1 text-red-500 hover:text-red-700" title="Supprimer" onclick="showDeleteModal(event, '{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}', '{{ meal.name|escape('js') }}')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {# Lunch #}
                    {% set lunchMeals = dayMeals|filter(m => m.mealType == 'lunch') %}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="font-medium text-yellow-600 dark:text-yellow-400">
                                <i class="fas fa-utensils mr-1"></i>Déjeuner
                            </span>
                            <a href="{{ path('nutrition_food_add', {meal: 'lunch'}) }}" class="text-gray-400 hover:text-yellow-500">
                                <i class="fas fa-plus-circle"></i>
                            </a>
                        </div>
                        {% for meal in lunchMeals %}
                        <div class="group relative p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition-colors {% if meal.isCompleted %}line-through opacity-60{% endif %}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-gray-900 dark:text-white truncate">{{ meal.name }}</p>
                                    <p class="text-xs text-gray-500">{{ meal.calories }} kcal</p>
                                </div>
                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="{{ path('nutrition_meal_plan_toggle', {id: meal.id}) }}" class="p-1 text-green-500 hover:text-green-700" title="Marquer comme mangé">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    <a href="{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}" class="p-1 text-red-500 hover:text-red-700" title="Supprimer" onclick="showDeleteModal(event, '{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}', '{{ meal.name|escape('js') }}')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {# Dinner #}
                    {% set dinnerMeals = dayMeals|filter(m => m.mealType == 'dinner') %}
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs">
                            <span class="font-medium text-indigo-600 dark:text-indigo-400">
                                <i class="fas fa-moon mr-1"></i>Dîner
                            </span>
                            <a href="{{ path('nutrition_food_add', {meal: 'dinner'}) }}" class="text-gray-400 hover:text-indigo-500">
                                <i class="fas fa-plus-circle"></i>
                            </a>
                        </div>
                        {% for meal in dinnerMeals %}
                        <div class="group relative p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors {% if meal.isCompleted %}line-through opacity-60{% endif %}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-gray-900 dark:text-white truncate">{{ meal.name }}</p>
                                    <p class="text-xs text-gray-500">{{ meal.calories }} kcal</p>
                                </div>
                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="{{ path('nutrition_meal_plan_toggle', {id: meal.id}) }}" class="p-1 text-green-500 hover:text-green-700" title="Marquer comme mangé">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    <a href="{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}" class="p-1 text-red-500 hover:text-red-700" title="Supprimer" onclick="showDeleteModal(event, '{{ path('nutrition_meal_plan_delete', {id: meal.id}) }}', '{{ meal.name|escape('js') }}')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {# Empty state #}
                    {% if dayMeals|length == 0 %}
                    <div class="text-center py-4 text-gray-400 dark:text-gray-500">
                        <i class="fas fa-utensils text-2xl mb-1 opacity-50"></i>
                        <p class="text-xs">Aucun repas</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {# Recent AI Meals #}
        {% if recentMeals|default([])|length > 0 %}
        <div class="mt-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">
                <i class="mr-2 text-wellcare-500 fas fa-history"></i>
                Repas récents générés par l'AI
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {% for meal in recentMeals|slice(0, 8) %}
                <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 dark:text-white truncate">{{ meal.name }}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <span class="inline-block px-2 py-0.5 rounded-full text-xs {% if meal.mealType == 'breakfast' %}bg-orange-100 text-orange-700{% elseif meal.mealType == 'lunch' %}bg-yellow-100 text-yellow-700{% else %}bg-indigo-100 text-indigo-700{% endif %}">
                                    {{ meal.mealType }}
                                </span>
                                {{ meal.date|date('d/m') }}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-wellcare-600 dark:text-wellcare-400">{{ meal.calories }}</p>
                            <p class="text-xs text-gray-400">kcal</p>
                        </div>
                    </div>
                    <div class="mt-2 flex gap-2 text-xs text-gray-500">
                        <span class="bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded">P: {{ meal.protein }}g</span>
                        <span class="bg-yellow-50 dark:bg-yellow-900/20 px-2 py-0.5 rounded">G: {{ meal.carbs }}g</span>
                        <span class="bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded">L: {{ meal.fats }}g</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 text-center">
                <a href="{{ path('nutrition_ai_assistant') }}" class="inline-flex items-center px-4 py-2 text-wellcare-600 dark:text-wellcare-400 hover:underline">
                    <i class="mr-2 fas fa-robot"></i>
                    Générer de nouveaux repas avec l'AI
                </a>
            </div>
        </div>
        {% endif %}

        {# Tips Section #}
        <div class="mt-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">
                <i class="mr-2 text-wellcare-500 fas fa-lightbulb"></i>
                Conseils pour une alimentation équilibrée
            </h2>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-900/10 rounded-lg">
                    <h3 class="font-semibold text-green-700 dark:text-green-400 mb-2">
                        <i class="mr-2 fas fa-carrot"></i>Fibres
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Includez des légumes et des féculents complets dans chaque repas pour une bonne digestion.
                    </p>
                </div>
                <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-900/10 rounded-lg">
                    <h3 class="font-semibold text-blue-700 dark:text-blue-400 mb-2">
                        <i class="mr-2 fas fa-glass-water"></i>Hydratation
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Buvez au moins 8 verres d'eau par jour, de préférence entre les repas.
                    </p>
                </div>
                <div class="p-4 bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-900/10 rounded-lg">
                    <h3 class="font-semibold text-amber-700 dark:text-amber-400 mb-2">
                        <i class="mr-2 fas fa-clock"></i>Horaire
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Essayez de manger à des heures régulières pour maintenir votre métabolisme actif.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{# Delete Confirmation Modal #}
<div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="hideDeleteModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Confirmer la suppression</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="delete-modal-message">
                    Êtes-vous sûr de vouloir supprimer cet élément? Cette action est irréversible.
                </p>
                <div class="flex gap-3 justify-center">
                    <button onclick="hideDeleteModal()" 
                        class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium">
                        Annuler
                    </button>
                    <a href="#" id="delete-modal-confirm" 
                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        Supprimer
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDeleteModal(event, url, itemName) {
    event.preventDefault();
    const modal = document.getElementById('delete-modal');
    const message = document.getElementById('delete-modal-message');
    const confirmBtn = document.getElementById('delete-modal-confirm');
    
    if (itemName) {
        message.textContent = 'Êtes-vous sûr de vouloir supprimer "' + itemName + '"? Cette action est irréversible.';
    }
    
    confirmBtn.href = url;
    modal.classList.remove('hidden');
}

function hideDeleteModal() {
    const modal = document.getElementById('delete-modal');
    modal.classList.add('hidden');
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideDeleteModal();
    }
});
</script>

{# Floating AI Chat Button #}
{% include 'nutrition/_ai-floating-button.html.twig' %}
{% endblock %}
