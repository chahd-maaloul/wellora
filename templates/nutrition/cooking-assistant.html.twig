{% extends 'layouts/app.html.twig' %}

{% block title %}Assistant de cuisine - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/nutrition-css.css') }}">
{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900{% endblock %}

{% block body %}
<div class="min-h-screen py-8">
    <div class="max-w-6xl px-4 mx-auto">
        {# Header #}
        <div class="flex flex-col gap-4 mb-8 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Assistant de cuisine</h1>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Suivez vos recettes étape par étape</p>
            </div>
            <div class="flex items-center gap-3">
                <button @click="toggleVoice()" class="px-4 py-2 transition-colors rounded-lg"
                        :class="voiceEnabled ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'">
                    <i class="mr-2 fas fa-microphone"></i><span x-text="voiceEnabled ? 'Voix activée' : 'Activer la voix'"></span>
                </button>
                <button @click="toggleFullscreen()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="mr-2 fas fa-expand"></i>Plein écran
                </button>
            </div>
        </div>

        {# Recipe Selection #}
        <div x-show="!activeRecipe" class="p-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
            <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">Choisir une recette</h2>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                <template x-for="recipe in recentRecipes" :key="recipe.id">
                    <div class="p-4 transition-colors cursor-pointer bg-gray-50 dark:bg-gray-700/50 rounded-xl hover:bg-wellcare-50 dark:hover:bg-wellcare-900/20"
                         @click="selectRecipe(recipe)">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-wellcare-100 dark:bg-wellcare-900/30">
                                <i :class="recipe.icon + ' text-wellcare-500'"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white" x-text="recipe.name"></h3>
                                <p class="text-sm text-gray-500"><span x-text="recipe.time"></span> min • <span x-text="recipe.steps.length"></span> étapes</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        {# Active Cooking Mode #}
        <div x-show="activeRecipe" class="overflow-hidden bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
            {# Recipe Header #}
            <div class="p-6 text-white bg-gradient-to-r from-wellcare-500 to-wellcare-600">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-2xl font-bold" x-text="activeRecipe.name"></h2>
                        <p class="mt-1 text-white/80" x-text="activeRecipe.description"></p>
                        <div class="flex items-center gap-4 mt-3 text-sm">
                            <span><i class="mr-1 fas fa-clock"></i><span x-text="activeRecipe.time"></span> min</span>
                            <span><i class="mr-1 fas fa-utensils"></i><span x-text="activeRecipe.servings"></span> portions</span>
                            <span><i class="mr-1 fas fa-fire"></i><span x-text="activeRecipe.calories"></span> kcal</span>
                        </div>
                    </div>
                    <button @click="closeRecipe()" class="p-2 transition-colors rounded-lg bg-white/20 hover:bg-white/30">
                        <i class="text-white fas fa-times"></i>
                    </button>
                </div>
            </div>

            {# Progress Bar #}
            <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700/50">
                <div class="flex items-center justify-between mb-2 text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Progression</span>
                    <span class="font-medium text-gray-900 dark:text-white"><span x-text="currentStep + 1"></span> / <span x-text="activeRecipe.steps.length"></span></span>
                </div>
                <div class="h-2 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-full transition-all duration-500 rounded-full bg-gradient-to-r from-wellcare-400 to-wellcare-600"
                         :style="'width: ' + ((currentStep + 1) / activeRecipe.steps.length * 100) + '%'"></div>
                </div>
            </div>

            {# Step Navigation #}
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <button @click="previousStep()" :disabled="currentStep === 0" 
                            class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 disabled:opacity-50 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="mr-2 fas fa-chevron-left"></i>Précédent
                    </button>
                    <div class="flex items-center gap-2">
                        <template x-for="(step, index) in activeRecipe.steps" :key="index">
                            <div class="flex items-center justify-center w-8 h-8 text-sm font-medium transition-colors rounded-full cursor-pointer"
                                 :class="index === currentStep ? 'bg-wellcare-500 text-white' : (index < currentStep ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500')"
                                 @click="goToStep(index)"
                                 :title="'Étape ' + (index + 1)">
                                <template x-if="index < currentStep"><i class="fas fa-check"></i></template>
                                <template x-if="index === currentStep"><span x-text="index + 1"></span></template>
                                <template x-if="index > currentStep"><span x-text="index + 1"></span></template>
                            </div>
                        </template>
                    </div>
                    <button @click="nextStep()" :disabled="currentStep === activeRecipe.steps.length - 1"
                            class="px-4 py-2 text-white transition-colors rounded-lg bg-wellcare-500 disabled:opacity-50 hover:bg-wellcare-600">
                        Suivant<i class="ml-2 fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            {# Current Step #}
            <div class="p-6">
                <div class="flex items-start gap-6">
                    {# Step Content #}
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-wellcare-100 dark:bg-wellcare-900/30">
                                <span class="text-2xl font-bold text-wellcare-500" x-text="currentStep + 1"></span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" x-text="activeRecipe.steps[currentStep].title"></h3>
                                <p class="text-gray-500 dark:text-gray-400" x-text="activeRecipe.steps[currentStep].duration + ' min'"></p>
                            </div>
                        </div>
                        <p class="mb-6 text-lg leading-relaxed text-gray-700 dark:text-gray-300" x-text="activeRecipe.steps[currentStep].instruction"></p>

                        {# Tips #}
                        <div x-show="activeRecipe.steps[currentStep].tips" class="p-4 mb-6 border border-blue-200 bg-blue-50 dark:bg-blue-900/20 dark:border-blue-800 rounded-xl">
                            <div class="flex items-start gap-3">
                                <i class="mt-1 text-blue-500 fas fa-lightbulb"></i>
                                <div>
                                    <h4 class="mb-1 font-semibold text-blue-800 dark:text-blue-200">Astuce</h4>
                                    <p class="text-blue-700 dark:text-blue-300" x-text="activeRecipe.steps[currentStep].tips"></p>
                                </div>
                            </div>
                        </div>

                        {# Ingredients for this step #}
                        <div x-show="activeRecipe.steps[currentStep].ingredients" class="mb-6">
                            <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Ingrédients pour cette étape:</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="ingredient in activeRecipe.steps[currentStep].ingredients" :key="ingredient">
                                    <span class="px-3 py-1 text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-300" x-text="ingredient"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    {# Sidebar #}
                    <div class="w-64 space-y-4">
                        {# Timer #}
                        <div class="p-4 text-center bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                            <div class="mb-2 text-4xl font-bold text-gray-900 dark:text-white" 
                                 x-text="formatTime(remainingTime)"
                                 :class="{'text-red-500': remainingTime < 60 && remainingTime > 0}"></div>
                            <p class="mb-3 text-sm text-gray-500 dark:text-gray-400">Temps restant</p>
                            <div class="flex justify-center gap-2">
                                <button @click="startTimer()" x-show="!timerRunning" class="px-4 py-2 text-white transition-colors bg-green-500 rounded-lg hover:bg-green-600">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button @click="pauseTimer()" x-show="timerRunning" class="px-4 py-2 text-white transition-colors rounded-lg bg-amber-500 hover:bg-amber-600">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button @click="resetTimer()" class="px-4 py-2 text-gray-700 transition-colors bg-gray-300 rounded-lg dark:bg-gray-600 dark:text-gray-300 hover:bg-gray-400 dark:hover:bg-gray-500">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                        </div>

                        {# Checklist #}
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                            <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Vérifications</h4>
                            <div class="space-y-2">
                                <template x-for="check in activeRecipe.steps[currentStep].checklist" :key="check">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" x-model="check.checked" class="w-5 h-5 border-gray-300 rounded text-wellcare-500 focus:ring-wellcare-500">
                                        <span class="text-gray-700 dark:text-gray-300" :class="{'line-through opacity-50': check.checked}" x-text="check.task"></span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        {# Nutrition Preview #}
                        <div class="p-4 bg-wellcare-50 dark:bg-wellcare-900/20 rounded-xl">
                            <h4 class="mb-3 font-semibold text-wellcare-800 dark:text-wellcare-200">Nutrition</h4>
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-wellcare-500" x-text="activeRecipe.nutrition.perServing.calories"></p>
                                    <p class="text-xs text-gray-500">kcal</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-blue-500" x-text="activeRecipe.nutrition.perServing.protein + 'g'"></p>
                                    <p class="text-xs text-gray-500">protéines</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-amber-500" x-text="activeRecipe.nutrition.perServing.carbs + 'g'"></p>
                                    <p class="text-xs text-gray-500">glucides</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-red-500" x-text="activeRecipe.nutrition.perServing.fats + 'g'"></p>
                                    <p class="text-xs text-gray-500">lipides</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Completion #}
            <div x-show="currentStep === activeRecipe.steps.length - 1" class="p-6 border-t border-green-200 bg-green-50 dark:bg-green-900/20 dark:border-green-800">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center w-16 h-16 bg-green-500 rounded-full">
                            <i class="text-2xl text-white fas fa-check"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-green-800 dark:text-green-200">Félicitations !</h3>
                            <p class="text-green-700 dark:text-green-300">Votre <span x-text="activeRecipe.name"></span> est prêt</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button @click="saveToDiary()" class="px-6 py-3 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                            <i class="mr-2 fas fa-save"></i>Enregistrer
                        </button>
                        <button @click="shareRecipe()" class="px-6 py-3 font-medium text-green-600 transition-colors border border-green-500 rounded-lg dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/30">
                            <i class="mr-2 fas fa-share-alt"></i>Partager
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {# Voice Instructions #}
        <div x-show="voiceEnabled && activeRecipe" class="fixed z-50 bottom-6 right-6">
            <div class="flex items-center gap-4 p-4 bg-white shadow-2xl dark:bg-gray-800 rounded-2xl">
                <div class="w-3 h-3 rounded-full animate-pulse" :class="isListening ? 'bg-red-500' : 'bg-gray-300'"></div>
                <span class="text-sm text-gray-600 dark:text-gray-400" x-text="voiceStatus"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('build/meal-planner.js') }}"></script>
{% endblock %}
