{% extends 'layouts/app.html.twig' %}

{% block title %}Liste de courses - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/nutrition-css.css') }}">
{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900{% endblock %}

{% block body %}
<div class="min-h-screen py-8" x-data="groceryList()" x-init="init()">
    <div class="max-w-5xl px-4 mx-auto">
        {# Header #}
        <div class="flex flex-col gap-4 mb-8 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Liste de courses</h1>
                <p class="mt-1 text-gray-500 dark:text-gray-400" x-text="weekLabel"></p>
            </div>
            <div class="flex items-center gap-3">
                <select x-model="selectedWeek" @change="loadWeek()" class="px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    <option value="current">Cette semaine</option>
                    <option value="next">Semaine prochaine</option>
                    <option value="custom">Personnalisé</option>
                </select>
                <button @click="generateFromMealPlan()" class="px-4 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                    <i class="mr-2 fas fa-sync-alt"></i>Générer
                </button>
                <button @click="printList()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="mr-2 fas fa-print"></i>Imprimer
                </button>
            </div>
        </div>

        {# Budget & Stats #}
        <div class="grid grid-cols-1 gap-4 mb-6 md:grid-cols-4">
            <div class="p-4 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Articles</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white" x-text="totalItems"></span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-600" x-text="checkedItems + ' achetés'"></span>
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600" x-text="remainingItems + ' restants'"></span>
                </div>
            </div>
            <div class="p-4 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Estimé</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white" x-text="estimatedCost.toFixed(2) + ' €'"></span>
                </div>
                <div class="w-full h-2 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-full rounded-full bg-wellcare-500" :style="'width: ' + (checkedCost / estimatedCost * 100) + '%'"></div>
                </div>
                <p class="mt-1 text-xs text-gray-500" x-text="'Acheté: ' + checkedCost.toFixed(2) + ' €'"></p>
            </div>
            <div class="p-4 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Catégories</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white" x-text="Object.keys(itemsByCategory).length"></span>
                </div>
                <p class="text-xs text-gray-500">Articles répartis dans <span x-text="Object.keys(itemsByCategory).length"></span> catégories</p>
            </div>
            <div class="p-4 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Progression</span>
                    <span class="text-2xl font-bold text-wellcare-500" x-text="Math.round(checkedItems / totalItems * 100) + '%'"></span>
                </div>
                <div class="w-full h-2 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-full transition-all rounded-full bg-gradient-to-r from-wellcare-400 to-wellcare-600" 
                         :style="'width: ' + (checkedItems / totalItems * 100) + '%'"></div>
                </div>
            </div>
        </div>

        {# Quick Actions #}
        <div class="flex flex-wrap gap-3 mb-6">
            <button @click="checkAll()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="mr-2 fas fa-check-double"></i>Tout cocher
            </button>
            <button @click="uncheckAll()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="mr-2 fas fa-undo"></i>Tout décocher
            </button>
            <button @click="clearChecked()" class="px-4 py-2 text-red-600 transition-colors border border-red-300 rounded-lg dark:border-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                <i class="mr-2 fas fa-trash"></i>Supprimer cochés
            </button>
            <button @click="addCustomItem()" class="px-4 py-2 text-white transition-colors bg-blue-500 rounded-lg hover:bg-blue-600">
                <i class="mr-2 fas fa-plus"></i>Ajouter article
            </button>
        </div>

        {# Categories Grid #}
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            <template x-for="(items, category) in itemsByCategory" :key="category">
                <div class="overflow-hidden bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                    {# Category Header #}
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-700/50">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center w-10 h-10 rounded-lg" :class="getCategoryClass(category)">
                                <i :class="getCategoryIcon(category) + ' text-white'"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white" x-text="getCategoryName(category)"></h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    <span x-text="items.filter(i => i.checked).length"></span>/<span x-text="items.length"></span> articles
                                </p>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300" 
                              x-text="getCategoryTotal(items)"></span>
                    </div>
                    
                    {# Items List #}
                    <div class="p-4 space-y-2">
                        <template x-for="item in items" :key="item.id">
                            <div class="flex items-center gap-3 p-2 transition-colors rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50"
                                 :class="{'opacity-50': item.checked}">
                                <input type="checkbox" x-model="item.checked" @change="toggleItem(item)"
                                       class="w-5 h-5 border-gray-300 rounded cursor-pointer text-wellcare-500 focus:ring-wellcare-500">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-900 dark:text-white" 
                                       :class="{'line-through': item.checked}"
                                       x-text="item.name"></p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="item.quantity + ' ' + item.unit"></p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-gray-900 dark:text-white" x-text="item.estimatedPrice.toFixed(2) + ' €'"></p>
                                    <p x-show="item.brand" class="text-xs text-gray-500 truncate max-w-[100px]" x-text="item.brand"></p>
                                </div>
                                <button @click="removeItem(item)" class="p-1 text-gray-400 transition-colors hover:text-red-500">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>
                        
                        {# Add Item to Category #}
                        <button @click="addItemToCategory(category)" 
                                class="w-full py-2 mt-2 text-gray-500 transition-colors border-2 border-gray-300 border-dashed rounded-lg dark:border-gray-600 hover:text-wellcare-500 hover:border-wellcare-500">
                            <i class="mr-1 fas fa-plus"></i> Ajouter un article
                        </button>
                    </div>
                </div>
            </template>
        </div>

        {# Add Item Modal #}
        <div x-show="showAddModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black/50" @click="showAddModal = false"></div>
                <div class="relative z-10 w-full max-w-md p-6 bg-white shadow-xl dark:bg-gray-800 rounded-2xl">
                    <h3 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">Ajouter un article</h3>
                    <form @submit.prevent="saveItem()" class="space-y-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Nom</label>
                            <input type="text" x-model="newItem.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Quantité</label>
                                <input type="number" x-model="newItem.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Unité</label>
                                <select x-model="newItem.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                                    <option value="pcs">Pièces</option>
                                    <option value="kg">Kg</option>
                                    <option value="g">g</option>
                                    <option value="L">L</option>
                                    <option value="ml">ml</option>
                                    <option value="bouteille">Bouteille</option>
                                    <option value="paquet">Paquet</option>
                                    <option value="boîte">Boîte</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Catégorie</label>
                            <select x-model="newItem.category" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                                <option value="produce">Fruits & Légumes</option>
                                <option value="dairy">Produits laitiers</option>
                                <option value="meat">Viandes & Poissons</option>
                                <option value="bakery">Boulangerie</option>
                                <option value="frozen">Surgelés</option>
                                <option value="pantry">Épicerie</option>
                                <option value="beverages">Boissons</option>
                                <option value="snacks">Snacks</option>
                                <option value="condiments">Condiments</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Prix estimé (€)</label>
                            <input type="number" x-model="newItem.estimatedPrice" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div class="flex gap-3">
                            <button type="button" @click="showAddModal = false" class="flex-1 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Annuler</button>
                            <button type="submit" class="flex-1 py-2 text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600">Ajouter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('build/meal-planner.js') }}"></script>
{% endblock %}
