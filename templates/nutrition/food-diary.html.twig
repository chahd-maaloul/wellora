{% extends 'layouts/app.html.twig' %}

{% block title %}Journal Alimentaire - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('nutrition-css') }}
{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    {# Page Header #}
    <div class="bg-white border-b border-gray-200 shadow-sm dark:bg-gray-800 dark:border-gray-700">
        <div class="px-4 py-6 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="flex items-center gap-3 text-2xl font-bold text-gray-900 dark:text-white">
                        <i class="text-3xl fas fa-book-open text-wellcare-500"></i>
                        Journal Alimentaire
                    </h1>
                    <p class="mt-1 text-gray-600 dark:text-gray-400">Suivez et analysez votre alimentation quotidienne</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="{{ path('nutrition_food_diary', { date: 'yesterday' }) }}" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <span class="px-4 py-2 text-gray-900 bg-white border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        21/02/2026
                    </span>
                    <a href="{{ path('nutrition_food_diary', { date: 'tomorrow' }) }}" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <main class="px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8">
        {# Daily Summary #}
        <div class="grid grid-cols-1 gap-6 mb-8 md:grid-cols-4">
            <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Calories totales</p>
                <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">{{ dailySummary.calories|default(0) }} <span class="text-sm font-normal text-gray-500">kcal</span></p>
                <div class="w-full h-2 mt-3 bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-2 rounded-full bg-wellcare-500" style="width: {{ min(((dailySummary.calories|default(0) / dailySummary.calorieTarget|default(2000)) * 100), 100) }}%"></div>
                </div>
            </div>
            <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Protéines</p>
                <p class="mt-1 text-2xl font-bold text-amber-600">{{ dailySummary.proteins|default(0) }} <span class="text-sm font-normal text-gray-500">g</span></p>
                <div class="w-full h-2 mt-3 bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-2 rounded-full bg-amber-500" style="width: {{ min(((dailySummary.proteins|default(0) / dailySummary.proteinTarget|default(100)) * 100), 100) }}%"></div>
                </div>
            </div>
            <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Glucides</p>
                <p class="mt-1 text-2xl font-bold text-green-600">{{ dailySummary.carbs|default(0) }} <span class="text-sm font-normal text-gray-500">g</span></p>
                <div class="w-full h-2 mt-3 bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-2 bg-green-500 rounded-full" style="width: {{ min(((dailySummary.carbs|default(0) / dailySummary.carbTarget|default(250)) * 100), 100) }}%"></div>
                </div>
            </div>
            <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Lipides</p>
                <p class="mt-1 text-2xl font-bold text-purple-600">{{ dailySummary.fats|default(0) }} <span class="text-sm font-normal text-gray-500">g</span></p>
                <div class="w-full h-2 mt-3 bg-gray-200 rounded-full dark:bg-gray-700">
                    <div class="h-2 bg-purple-500 rounded-full" style="width: {{ min(((dailySummary.fats|default(0) / dailySummary.fatTarget|default(70)) * 100), 100) }}%"></div>
                </div>
            </div>
        </div>

        {# Meals Timeline #}
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            {# Left Column - Meals #}
            <div class="space-y-6">
                {% for mealType, mealData in {
                    'breakfast': { icon: 'fa-mug-hot', color: 'orange', label: 'Petit-déjeuner', time: '07:00 - 09:00' },
                    'lunch': { icon: 'fa-sun', color: 'yellow', label: 'Déjeuner', time: '12:00 - 14:00' },
                    'dinner': { icon: 'fa-moon', color: 'indigo', label: 'Dîner', time: '19:00 - 21:00' },
                    'snacks': { icon: 'fa-cookie-bite', color: 'pink', label: 'Colations', time: 'Tout au long de la journée' }
                } %}
                <div class="overflow-hidden bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <div class="p-4 bg-{{ mealData.color }}-50 dark:bg-{{ mealData.color }}-900/20 border-b border-{{ mealData.color }}-100 dark:border-{{ mealData.color }}-800/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-{{ mealData.color }}-100 dark:bg-{{ mealData.color }}-900/50 flex items-center justify-center">
                                    <i class="fas {{ mealData.icon }} text-{{ mealData.color }}-500"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">{{ mealData.label }}</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ mealData.time }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ meals[mealType].calories|default(0) }} kcal</p>
                                <button @click="$dispatch('add-meal', { meal: '{{ mealType }}' })" 
                                        class="text-xs text-wellcare-600 dark:text-wellcare-400 hover:text-wellcare-700">
                                    <i class="mr-1 fas fa-plus"></i>Ajouter
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        {% if meals[mealType].items|default|length > 0 %}
                        <div class="space-y-3">
                            {% for item in meals[mealType].items|default([]) %}
                            <div class="flex items-center justify-between p-3 transition-colors rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center justify-center w-8 h-8 bg-gray-100 rounded-lg dark:bg-gray-700">
                                        <i class="text-sm text-gray-400 fas fa-utensils"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ item.name }}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ item.quantity }} portion(s)</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ item.calories }} kcal</p>
                                        <p class="text-xs text-gray-500">P: {{ item.proteins|default(0) }}g | G: {{ item.carbs|default(0) }}g | L: {{ item.fats|default(0) }}g</p>
                                    </div>
                                    <button @click="removeFood('{{ mealType }}', {{ loop.index0 }})" 
                                            class="text-red-500 transition-colors hover:text-red-600">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="py-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="mb-3 text-3xl opacity-50 fas fa-utensils"></i>
                            <p class="text-sm">Aucun aliment enregistré</p>
                            <button @click="$dispatch('add-meal', { meal: '{{ mealType }}' })" 
                                    class="mt-2 text-sm text-wellcare-600 dark:text-wellcare-400 hover:text-wellcare-700">
                                Ajouter un aliment
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {# Right Column - Analysis #}
            <div class="space-y-6">
                {# Macro Distribution Chart #}
                <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <h3 class="mb-4 font-semibold text-gray-900 dark:text-white">Répartition des macronutriments</h3>
                    <div class="h-64">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>

                {# Food Group Distribution #}
                <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <h3 class="mb-4 font-semibold text-gray-900 dark:text-white">Groupes alimentaires</h3>
                    <div class="space-y-4">
                        {% for group, data in foodGroups %}
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm text-gray-700 dark:text-gray-300">{{ group }}</span>
                                <span class="text-xs text-gray-500">{{ data.percentage }}%</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 rounded-full dark:bg-gray-700">
                                <div class="h-2 rounded-full {{ data.color }}" style="width: {{ data.percentage }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {# Nutrition Alerts #}
                <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <h3 class="mb-4 font-semibold text-gray-900 dark:text-white">
                        <i class="mr-2 fas fa-exclamation-triangle text-amber-500"></i>
                        Alertes nutritionnelles
                    </h3>
                    <div class="space-y-3">
                        {% for alert in nutritionAlerts %}
                        <div class="p-3 rounded-lg {{ alert.type == 'warning' ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800' : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800' }}">
                            <div class="flex items-start gap-3">
                                <i class="fas {{ alert.icon }} mt-0.5 {{ alert.type == 'warning' ? 'text-amber-500' : 'text-red-500' }}"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ alert.message }}</p>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ alert.recommendation }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {# Water Intake #}
                <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <h3 class="mb-4 font-semibold text-gray-900 dark:text-white">Hydratation</h3>
                    <div class="flex items-center justify-center mb-4">
                        <div class="relative w-32 h-32">
                            <svg class="w-32 h-32 transform -rotate-90">
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="12" fill="none" class="text-gray-200 dark:text-gray-700"/>
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="12" fill="none" 
                                        stroke-dasharray="{{ (water.intake|default(0) / water.target|default(8) * 351.86) ~ ' 351.86' }}"
                                        class="text-blue-500"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-2xl font-bold text-gray-900 dark:text-white">{{ water.intake|default(0) }}</span>
                                <span class="text-xs text-gray-500">/ {{ water.target|default(8) }} verres</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center gap-2">
                        {% for i in 1..(water.target|default(8)) %}
                        <button @click="toggleWater({{ i }})" 
                                class="w-10 h-10 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center transition-all hover:scale-110 shadow-sm
                                       {{ i <= water.intake|default(0) ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-400' }}">
                            <i class="text-sm fas fa-check"></i>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    {# Quick Log Modal #}
    {% include 'nutrition/partials/quick-log-modal.html.twig' %}
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('foodDiary', () => ({
        selectedDate: new Date().toISOString().split('T')[0],
        showQuickLog: false,
        
        init() {
            this.initCharts();
        },

        toggleWater(level) {
            console.log('Toggle water:', level);
        },

        removeFood(mealType, index) {
            console.log('Remove food:', mealType, index);
        },

        initCharts() {
            // Macro Doughnut Chart
            const macroCtx = document.getElementById('macroChart');
            if (macroCtx) {
                new Chart(macroCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Protéines', 'Glucides', 'Lipides'],
                        datasets: [{
                            data: [{{ macros.proteins|default(0) }}, {{ macros.carbs|default(0) }}, {{ macros.fats|default(0) }}],
                            backgroundColor: ['#f59e0b', '#22c55e', '#a855f7'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        cutout: '60%'
                    }
                });
            }
        }
    }));
});
</script>

{# Floating AI Chat Button #}
{% include 'nutrition/_ai-floating-button.html.twig' %}
{% endblock %}
