{# templates/analytics/quality-metrics.html.twig #}
{# Quality Metrics Analytics Dashboard #}

{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Indicateurs de Qualité'|trans }} - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/analytics.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
{% endblock %}

{% block body %}
<div class="min-h-screen p-6 bg-gray-50 dark:bg-gray-950" x-data="qualityMetricsAnalytics()" x-init="init()">
    
    {# Header #}
    <div class="mx-auto mb-6 max-w-7xl">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <i class="mr-2 fa-solid fa-award text-wellcare-500"></i>
                    {{ "Indicateurs de Qualité"|trans }}
                </h1>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    {{ "Métriques de qualité des soins"|trans }}
                </p>
            </div>
            
            <div class="flex items-center gap-3">
                <select 
                    x-model="period"
                    @change="loadData()"
                    class="px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                >
                    <option value="month">{{ "Ce Mois"|trans }}</option>
                    <option value="quarter">{{ "Ce Trimestre"|trans }}</option>
                    <option value="year">{{ "Cette Année"|trans }}</option>
                </select>
                
                <button 
                    @click="generateQualityReport()"
                    class="px-4 py-2 text-sm font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600"
                >
                    <i class="mr-2 fa-solid fa-file-medical-alt"></i>
                    {{ "Rapport Qualité"|trans }}
                </button>
            </div>
        </div>
    </div>
    
    {# Quality Score Cards #}
    <div class="grid grid-cols-1 gap-6 mx-auto mb-6 max-w-7xl md:grid-cols-2 lg:grid-cols-4">
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ "Score de Qualité Global"|trans }}</p>
                    <p class="mt-1 text-3xl font-bold text-gray-900 dark:text-white" x-text="globalScore + '/100'"></p>
                </div>
                <div class="relative w-16 h-16">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle 
                            cx="32" cy="32" r="28" 
                            stroke="#e5e7eb" 
                            stroke-width="4" 
                            fill="none"
                        />
                        <circle 
                            cx="32" cy="32" r="28" 
                            :stroke="scoreColor(globalScore)"
                            stroke-width="4" 
                            fill="none"
                            :stroke-dasharray="globalScore * 1.76"
                            stroke-linecap="round"
                        />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold" :class="scoreTextColor(globalScore)" x-text="globalScore"></span>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <span 
                    class="text-xs font-medium"
                    :class="scoreTrend >= 0 ? 'text-emerald-600' : 'text-red-600'"
                >
                    <i :class="scoreTrend >= 0 ? 'fa-solid fa-arrow-up' : 'fa-solid fa-arrow-down'"></i>
                    <span x-text="Math.abs(scoreTrend) + '%'"></span>
                </span>
                <span class="text-xs text-gray-500"> vs trimestre dernier</span>
            </div>
        </div>
        
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ "Satisfaction Patients"|trans }}</p>
                    <p class="mt-1 text-3xl font-bold text-gray-900 dark:text-white" x-text="satisfactionScore + '%'"></p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl">
                    <i class="text-xl text-blue-600 fa-solid fa-smile dark:text-blue-400"></i>
                </div>
            </div>
            <div class="flex items-center gap-1 mt-4">
                <template x-for="i in 5" :key="i">
                    <i 
                        class="text-sm fa-solid fa-star"
                        :class="i <= Math.round(satisfactionScore / 20) ? 'text-amber-400' : 'text-gray-300'"
                    ></i>
                </template>
                <span class="ml-1 text-xs text-gray-500" x-text="'(' + totalReviews + ' avis)'"></span>
            </div>
        </div>
        
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ "Taux de Réadmission"|trans }}</p>
                    <p class="mt-1 text-3xl font-bold text-gray-900 dark:text-white" x-text="readmissionRate + '%'"></p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-xl">
                    <i class="text-xl fa-solid fa-undo text-amber-600 dark:text-amber-400"></i>
                </div>
            </div>
            <div class="mt-4">
                <span class="text-xs text-gray-500">{{ "Cible: < 10%"|trans }}</span>
                <div class="h-2 mt-1 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                    <div 
                        class="h-full rounded-full"
                        :class="readmissionRate <= 10 ? 'bg-emerald-500' : readmissionRate <= 15 ? 'bg-amber-500' : 'bg-red-500'"
                        :style="{ width: Math.min(readmissionRate * 6.67, 100) + '%' }"
                    ></div>
                </div>
            </div>
        </div>
        
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ "Suivis Effectués"|trans }}</p>
                    <p class="mt-1 text-3xl font-bold text-gray-900 dark:text-white" x-text="followUpRate + '%'"></p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl">
                    <i class="text-xl fa-solid fa-calendar-check text-emerald-600 dark:text-emerald-400"></i>
                </div>
            </div>
            <div class="mt-4">
                <span class="text-xs text-gray-500">{{ "Cible: > 80%"|trans }}</span>
                <div class="h-2 mt-1 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                    <div 
                        class="h-full rounded-full"
                        :class="followUpRate >= 80 ? 'bg-emerald-500' : followUpRate >= 60 ? 'bg-amber-500' : 'bg-red-500'"
                        :style="{ width: followUpRate + '%' }"
                    ></div>
                </div>
            </div>
        </div>
    </div>
    
    {# Quality Domains #}
    <div class="grid grid-cols-1 gap-6 mx-auto mb-6 max-w-7xl lg:grid-cols-2">
        
        {# Quality Radar Chart #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Domaines de Qualité"|trans }}</h2>
            <canvas id="qualityRadarChart" class="w-full h-64"></canvas>
        </div>
        
        {# Patient Satisfaction Details #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Satisfaction par Critère"|trans }}</h2>
            <div class="space-y-4">
                <template x-for="criterion in satisfactionCriteria" :key="criterion.name">
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="criterion.name"></span>
                            <span class="text-sm font-bold" :class="scoreTextColor(criterion.score)" x-text="criterion.score + '%'"></span>
                        </div>
                        <div class="h-3 overflow-hidden bg-gray-100 rounded-full dark:bg-gray-800">
                            <div 
                                class="h-full transition-all duration-500 rounded-full"
                                :class="scoreBgColor(criterion.score)"
                                :style="{ width: criterion.score + '%' }"
                            ></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    {# Clinical Quality Metrics #}
    <div class="mx-auto mb-6 max-w-7xl">
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-gray-900 dark:text-white">{{ "Indicateurs de Qualité Clinique"|trans }}</h2>
                <div class="flex items-center gap-2">
                    <span class="flex items-center gap-1 text-xs text-gray-500">
                        <span class="w-3 h-3 rounded-full bg-emerald-500"></span> {{ "Atteint"|trans }}
                    </span>
                    <span class="flex items-center gap-1 text-xs text-gray-500">
                        <span class="w-3 h-3 rounded-full bg-amber-500"></span> {{ "En progrès"|trans }}
                    </span>
                    <span class="flex items-center gap-1 text-xs text-gray-500">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span> {{ "Non atteint"|trans }}
                    </span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                <template x-for="indicator in clinicalIndicators" :key="indicator.id">
                    <div 
                        class="p-4 transition-colors border rounded-xl"
                        :class="{
                            'border-emerald-200 dark:border-emerald-800 bg-emerald-50/50 dark:bg-emerald-900/10': indicator.status === 'achieved',
                            'border-amber-200 dark:border-amber-800 bg-amber-50/50 dark:bg-amber-900/10': indicator.status === 'progress',
                            'border-red-200 dark:border-red-800 bg-red-50/50 dark:bg-red-900/10': indicator.status === 'missed'
                        }"
                    >
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="indicator.name"></p>
                                <p class="text-xs text-gray-500 mt-0.5" x-text="indicator.description"></p>
                            </div>
                            <span 
                                class="flex items-center justify-center w-6 h-6 rounded-full"
                                :class="{
                                    'bg-emerald-500 text-white': indicator.status === 'achieved',
                                    'bg-amber-500 text-white': indicator.status === 'progress',
                                    'bg-red-500 text-white': indicator.status === 'missed'
                                }"
                            >
                                <i class="text-xs fa-solid fa-check" x-show="indicator.status === 'achieved'"></i>
                                <i class="text-xs fa-solid fa-minus" x-show="indicator.status === 'progress'"></i>
                                <i class="text-xs fa-solid fa-times" x-show="indicator.status === 'missed'"></i>
                            </span>
                        </div>
                        <div class="flex items-end justify-between">
                            <div class="flex-1">
                                <div class="h-2 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                                    <div 
                                        class="h-full rounded-full"
                                        :class="{
                                            'bg-emerald-500': indicator.status === 'achieved',
                                            'bg-amber-500': indicator.status === 'progress',
                                            'bg-red-500': indicator.status === 'missed'
                                        }"
                                        :style="{ width: indicator.progress + '%' }"
                                    ></div>
                                </div>
                            </div>
                            <div class="ml-3 text-right">
                                <span class="text-sm font-bold" :class="scoreTextColor(indicator.currentValue)" x-text="indicator.currentValue"></span>
                                <span class="text-xs text-gray-500"> / <span x-text="indicator.targetValue"></span></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    {# Feedback & Improvements #}
    <div class="grid grid-cols-1 gap-6 mx-auto max-w-7xl lg:grid-cols-2">
        
        {# Recent Feedback #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Retours Récents"|trans }}</h2>
            <div class="space-y-4">
                <template x-for="feedback in recentFeedback" :key="feedback.id">
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <img 
                                    :src="'https://ui-avatars.com/api/?name=' + feedback.patientName + '&background=random'" 
                                    class="w-8 h-8 rounded-full"
                                >
                                <span class="text-sm font-medium text-gray-900 dark:text-white" x-text="feedback.patientName"></span>
                            </div>
                            <div class="flex items-center gap-1">
                                <template x-for="i in 5" :key="i">
                                    <i 
                                        class="text-xs fa-solid fa-star"
                                        :class="i <= feedback.rating ? 'text-amber-400' : 'text-gray-300'"
                                    ></i>
                                </template>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300" x-text="feedback.comment"></p>
                        <p class="mt-2 text-xs text-gray-500" x-text="feedback.date"></p>
                    </div>
                </template>
            </div>
        </div>
        
        {# Improvement Actions #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-gray-900 dark:text-white">{{ "Actions d'Amélioration"|trans }}</h2>
                <button 
                    @click="addAction()"
                    class="px-3 py-1 text-sm font-medium border rounded-lg text-wellcare-600 dark:text-wellcare-400 border-wellcare-200 dark:border-wellcare-800 hover:bg-wellcare-50 dark:hover:bg-wellcare-900/20"
                >
                    <i class="mr-1 fa-solid fa-plus"></i>
                    {{ "Ajouter"|trans }}
                </button>
            </div>
            
            <div class="space-y-3">
                <template x-for="action in improvementActions" :key="action.id">
                    <div class="p-4 transition-colors border border-gray-200 cursor-pointer dark:border-gray-700 rounded-xl hover:border-wellcare-500">
                        <div class="flex items-center gap-3">
                            <div 
                                class="flex items-center justify-center w-8 h-8 rounded-full"
                                :class="{
                                    'bg-emerald-100 text-emerald-600': action.status === 'completed',
                                    'bg-blue-100 text-blue-600': action.status === 'in-progress',
                                    'bg-amber-100 text-amber-600': action.status === 'pending',
                                    'bg-gray-100 text-gray-600': action.status === 'delayed'
                                }"
                            >
                                <i 
                                    class="fa-solid"
                                    :class="{
                                        'fa-check': action.status === 'completed',
                                        'fa-spinner': action.status === 'in-progress',
                                        'fa-clock': action.status === 'pending',
                                        'fa-exclamation': action.status === 'delayed'
                                    }"
                                ></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="action.title"></p>
                                <p class="text-xs text-gray-500" x-text="action.responsible"></p>
                            </div>
                            <span 
                                class="px-2 py-1 text-xs rounded-full"
                                :class="{
                                    'bg-emerald-100 text-emerald-700': action.status === 'completed',
                                    'bg-blue-100 text-blue-700': action.status === 'in-progress',
                                    'bg-amber-100 text-amber-700': action.status === 'pending',
                                    'bg-red-100 text-red-700': action.status === 'delayed'
                                }"
                                x-text="action.status === 'completed' ? '{{ 'Terminé'|trans }}' : action.status === 'in-progress' ? '{{ 'En cours'|trans }}' : action.status === 'pending' ? '{{ 'En attente'|trans }}' : '{{ 'Retard'|trans }}'"
                            ></span>
                        </div>
                        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                            <span><i class="mr-1 fa-solid fa-calendar"></i><span x-text="action.deadline"></span></span>
                            <span x-text="action.progress + '%'"></span>
                        </div>
                        <div class="h-1 mt-1 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                            <div 
                                class="h-full rounded-full bg-wellcare-500"
                                :style="{ width: action.progress + '%' }"
                            ></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ asset('build/analytics.js') }}"></script>
{% endblock %}
