{# templates/analytics/clinic-performance.html.twig #}
{# Clinic Performance Analytics Dashboard #}

{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Performance de la Clinique'|trans }} - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/analytics.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
{% endblock %}

{% block body %}
<div class="min-h-screen p-6 bg-gray-50 dark:bg-gray-950" x-data="clinicPerformanceAnalytics()" x-init="init()">
    
    {# Header #}
    <div class="mx-auto mb-6 max-w-7xl">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <i class="mr-2 fa-solid fa-building text-wellcare-500"></i>
                    {{ "Performance de la Clinique"|trans }}
                </h1>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    {{ "Métriques de performance opérationnelle"|trans }}
                </p>
            </div>
            
            <div class="flex items-center gap-3">
                <select 
                    x-model="period"
                    @change="loadData()"
                    class="px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                >
                    <option value="daily">{{ "Aujourd'hui"|trans }}</option>
                    <option value="weekly">{{ "Cette Semaine"|trans }}</option>
                    <option value="monthly">{{ "Ce Mois"|trans }}</option>
                    <option value="quarterly">{{ "Ce Trimestre"|trans }}</option>
                    <option value="yearly">{{ "Cette Année"|trans }}</option>
                </select>
                
                <select 
                    x-model="clinicId"
                    @change="loadData()"
                    class="px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                >
                    <option value="all">{{ "Toutes les Cliniques"|trans }}</option>
                    <option value="clinic-1">Cabinet Principal</option>
                    <option value="clinic-2">Clinique Sud</option>
                </select>
                
                <button 
                    @click="generateReport()"
                    class="px-4 py-2 text-sm font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600"
                >
                    <i class="mr-2 fa-solid fa-file-alt"></i>
                    {{ "Générer Rapport"|trans }}
                </button>
            </div>
        </div>
    </div>
    
    {# KPI Cards #}
    <div class="grid grid-cols-1 gap-4 mx-auto mb-6 max-w-7xl md:grid-cols-2 lg:grid-cols-5">
        <div class="p-4 bg-white border border-gray-200 dark:bg-gray-900 rounded-xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500">{{ "Taux d'Occupation"|trans }}</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white" x-text="kpis.occupancyRate + '%'"></p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-lg"
                     :class="kpis.occupancyRate >= 80 ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'">
                    <i class="fa-solid fa-percentage"></i>
                </div>
            </div>
            <div class="mt-2">
                <span 
                    class="text-xs font-medium"
                    :class="kpis.occupancyTrend >= 0 ? 'text-emerald-600' : 'text-red-600'"
                    x-text="kpis.occupancyTrend >= 0 ? '+' + kpis.occupancyTrend + '%' : kpis.occupancyTrend + '%'"
                ></span>
                <span class="text-xs text-gray-500"> vs sem. dernière</span>
            </div>
        </div>
        
        <div class="p-4 bg-white border border-gray-200 dark:bg-gray-900 rounded-xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500">{{ "Patients/Jour"|trans }}</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white" x-text="kpis.patientsPerDay"></p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 text-blue-600 bg-blue-100 rounded-lg">
                    <i class="fa-solid fa-users"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs font-medium text-emerald-600">+<span x-text="kpis.patientsTrend"></span>%</span>
                <span class="text-xs text-gray-500"> vs sem. dernière</span>
            </div>
        </div>
        
        <div class="p-4 bg-white border border-gray-200 dark:bg-gray-900 rounded-xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500">{{ "Temps d'Attente"|trans }}</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white" x-text="kpis.avgWaitTime + ' min'"></p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-lg"
                     :class="kpis.avgWaitTime <= 15 ? 'bg-emerald-100 text-emerald-600' : kpis.avgWaitTime <= 30 ? 'bg-amber-100 text-amber-600' : 'bg-red-100 text-red-600'">
                    <i class="fa-solid fa-clock"></i>
                </div>
            </div>
            <div class="mt-2">
                <span 
                    class="text-xs font-medium"
                    :class="kpis.waitTimeTrend <= 0 ? 'text-emerald-600' : 'text-red-600'"
                    x-text="kpis.waitTimeTrend <= 0 ? kpis.waitTimeTrend + '%' : '+' + kpis.waitTimeTrend + '%'"
                ></span>
                <span class="text-xs text-gray-500"> vs sem. dernière</span>
            </div>
        </div>
        
        <div class="p-4 bg-white border border-gray-200 dark:bg-gray-900 rounded-xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500">{{ "Satisfaction"|trans }}</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white" x-text="kpis.satisfactionScore + '/5'"></p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 text-purple-600 bg-purple-100 rounded-lg">
                    <i class="fa-solid fa-star"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs font-medium text-emerald-600">+<span x-text="kpis.satisfactionTrend"></span>%</span>
                <span class="text-xs text-gray-500"> ce mois</span>
            </div>
        </div>
        
        <div class="p-4 bg-white border border-gray-200 dark:bg-gray-900 rounded-xl dark:border-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500">{{ "Revenus/Jour"|trans }}</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900 dark:text-white" x-text="'€' + kpis.revenuePerDay.toLocaleString()"></p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600">
                    <i class="fa-solid fa-euro-sign"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs font-medium text-emerald-600">+<span x-text="kpis.revenueTrend"></span>%</span>
                <span class="text-xs text-gray-500"> vs sem. dernière</span>
            </div>
        </div>
    </div>
    
    {# Main Charts #}
    <div class="grid grid-cols-1 gap-6 mx-auto mb-6 max-w-7xl lg:grid-cols-2">
        
        {# Patient Flow Funnel #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Flux de Patients"|trans }}</h2>
            <div class="space-y-3">
                <template x-for="(stage, index) in patientFlow" :key="stage.name">
                    <div class="relative">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="stage.name"></span>
                            <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="stage.count.toLocaleString()"></span>
                        </div>
                        <div class="h-10 overflow-hidden bg-gray-100 rounded-lg dark:bg-gray-800">
                            <div 
                                class="h-full transition-all duration-500 rounded-lg"
                                :class="stageColors[index]"
                                :style="{ width: (stage.count / patientFlow[0].count * 100) + '%' }"
                            ></div>
                        </div>
                        <div class="absolute transform -translate-y-1/2 top-1/2 right-2">
                            <span 
                                class="text-xs font-medium"
                                :class="index > 0 ? 'text-gray-600 dark:text-gray-400' : 'text-transparent'"
                            >
                                <template x-if="index > 0">
                                    <span>-<span x-text="Math.round((1 - stage.count / patientFlow[index-1].count) * 100) + '%'"></span></span>
                                </template>
                            </span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        {# Resource Utilization #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Utilisation des Ressources"|trans }}</h2>
            <div class="grid grid-cols-2 gap-4">
                <template x-for="resource in resourceUtilization" :key="resource.name">
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" x-text="resource.name"></span>
                            <span 
                                class="text-xs font-medium"
                                :class="resource.rate >= 80 ? 'text-emerald-600' : resource.rate >= 50 ? 'text-amber-600' : 'text-red-600'"
                                x-text="resource.rate + '%'"
                            ></span>
                        </div>
                        <div class="h-3 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                            <div 
                                class="h-full transition-all duration-500 rounded-full"
                                :class="resource.rate >= 80 ? 'bg-emerald-500' : resource.rate >= 50 ? 'bg-amber-500' : 'bg-red-500'"
                                :style="{ width: resource.rate + '%' }"
                            ></div>
                        </div>
                        <p class="mt-1 text-xs text-gray-500" x-text="resource.details"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    {# Detailed Analysis #}
    <div class="grid grid-cols-1 gap-6 mx-auto mb-6 max-w-7xl lg:grid-cols-3">
        
        {# Doctor Productivity #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Productivité des Médecins"|trans }}</h2>
            <div class="space-y-4">
                <template x-for="doctor in doctorProductivity" :key="doctor.id">
                    <div class="flex items-center gap-4">
                        <img 
                            :src="'https://ui-avatars.com/api/?name=' + doctor.name + '&background=random'" 
                            class="w-10 h-10 rounded-full"
                        >
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="doctor.name"></p>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                    <div 
                                        class="h-full rounded-full bg-wellcare-500"
                                        :style="{ width: (doctor.productivity / 100 * 100) + '%' }"
                                    ></div>
                                </div>
                                <span class="text-xs text-gray-500" x-text="doctor.productivity + '%'"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white" x-text="doctor.patients"></p>
                            <p class="text-xs text-gray-500">{{ "patients"|trans }}</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        {# Room Utilization #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Utilisation des Salles"|trans }}</h2>
            <div class="space-y-3">
                <template x-for="room in roomUtilization" :key="room.name">
                    <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-900 dark:text-white" x-text="room.name"></span>
                            <span 
                                class="px-2 py-0.5 text-xs rounded-full"
                                :class="room.status === 'available' ? 'bg-emerald-100 text-emerald-700' : room.status === 'busy' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'"
                                x-text="room.status === 'available' ? '{{ 'Disponible'|trans }}' : room.status === 'busy' ? '{{ 'Occupée'|trans }}' : '{{ 'Maintenance'|trans }}'"
                            ></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 overflow-hidden bg-gray-200 rounded-full dark:bg-gray-700">
                                <div 
                                    class="h-full rounded-full bg-wellcare-500"
                                    :style="{ width: room.utilization + '%' }"
                                ></div>
                            </div>
                            <span class="text-xs text-gray-500" x-text="room.utilization + '%'"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        {# Peak Hours Analysis #}
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <h2 class="mb-4 font-semibold text-gray-900 dark:text-white">{{ "Heures de Pointe"|trans }}</h2>
            <div class="space-y-2">
                <template x-for="(peak, index) in peakHours" :key="peak.hour">
                    <div class="flex items-center gap-3">
                        <span class="w-8 text-sm font-medium text-gray-500" x-text="peak.hour + 'h'"></span>
                        <div class="flex-1 h-4 overflow-hidden bg-gray-100 rounded-full dark:bg-gray-800">
                            <div 
                                class="h-full transition-all duration-500 rounded-full"
                                :class="peakColors[index]"
                                :style="{ width: (peak.intensity / 100 * 100) + '%' }"
                            ></div>
                        </div>
                        <span class="w-12 text-sm font-medium text-right text-gray-900 dark:text-white" x-text="peak.patients"></span>
                    </div>
                </template>
            </div>
            <div class="p-3 mt-4 rounded-lg bg-wellcare-50 dark:bg-wellcare-900/20">
                <p class="text-sm text-wellcare-700 dark:text-wellcare-300">
                    <i class="mr-1 fa-solid fa-lightbulb"></i>
                    {{ "Recommandation:" |trans }} <span x-text="recommendation"></span>
                </p>
            </div>
        </div>
    </div>
    
    {# Bottleneck Analysis #}
    <div class="mx-auto max-w-7xl">
        <div class="p-6 bg-white border border-gray-200 dark:bg-gray-900 rounded-2xl dark:border-gray-800">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-gray-900 dark:text-white">{{ "Analyse des Goulots d'Étranglement"|trans }}</h2>
                <button 
                    @click="runAnalysis()"
                    class="px-3 py-1 text-sm font-medium border rounded-lg text-wellcare-600 dark:text-wellcare-400 border-wellcare-200 dark:border-wellcare-800 hover:bg-wellcare-50 dark:hover:bg-wellcare-900/20"
                >
                    <i class="mr-1 fa-solid fa-refresh"></i>
                    {{ "Actualiser"|trans }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
                <template x-for="bottleneck in bottlenecks" :key="bottleneck.id">
                    <div 
                        class="p-4 transition-colors border rounded-xl"
                        :class="bottleneck.severity === 'high' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : bottleneck.severity === 'medium' ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800' : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700'"
                    >
                        <div class="flex items-center gap-2 mb-2">
                            <i 
                                class="fa-solid"
                                :class="bottleneck.icon"
                                :class="bottleneck.severity === 'high' ? 'text-red-500' : bottleneck.severity === 'medium' ? 'text-amber-500' : 'text-gray-500'"
                            ></i>
                            <span class="font-medium text-gray-900 dark:text-white" x-text="bottleneck.name"></span>
                        </div>
                        <p class="mb-2 text-sm text-gray-600 dark:text-gray-300" x-text="bottleneck.description"></p>
                        <div class="flex items-center justify-between">
                            <span 
                                class="text-xs font-medium"
                                :class="bottleneck.severity === 'high' ? 'text-red-600' : bottleneck.severity === 'medium' ? 'text-amber-600' : 'text-gray-600'"
                                x-text="bottleneck.impact"
                            ></span>
                            <button 
                                @click="viewSolution(bottleneck)"
                                class="text-xs text-wellcare-600 dark:text-wellcare-400 hover:underline"
                            >
                                {{ "Voir solution"|trans }}
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ asset('build/analytics.js') }}"></script>
{% endblock %}
