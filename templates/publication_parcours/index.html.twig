{% extends 'layouts/app.html.twig' %}

{% block title %}Community Publications - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('trail-css') }}
    {{ encore_entry_link_tags('trail-community-css') }}
{% endblock %}

{% block body %}
{% set current_page = app.request.query.getInt('page', 1) %}
<div class="py-4 mb-4 -mx-4 -mt-4 bg-gradient-to-r from-wellcare-dark-500 to-wellcare-500">
    <div class="px-4 mx-auto">
        <h1 class="text-xl font-bold text-white font-display">
            <i class="mr-2 fa-solid fa-users"></i>Community Publications
        </h1>
        <p class="text-sm text-white/80">Discover trail experiences from the community</p>
    </div>
</div>

<div class="px-4 mx-auto">
    <div class="grid grid-cols-1 gap-4 lg:grid-cols-4">
        <div class="space-y-4 lg:col-span-3">
            <div class="flex flex-wrap items-center justify-between gap-2 p-3 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <div>
                    {% if selected_parcours %}
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Showing publications for <span class="font-semibold text-gray-900 dark:text-white">{{ selected_parcours.nomParcours }}</span>
                        </p>
                    {% else %}
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            All community publications
                        </p>
                    {% endif %}
                    {% if selected_hashtag %}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Active hashtag: <span class="font-semibold text-wellcare-600 dark:text-wellcare-400">#{{ selected_hashtag }}</span>
                        </p>
                    {% endif %}
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <form method="get" action="{{ path('app_publication_parcours_index') }}" class="flex items-center gap-2">
                        {% if selected_parcours %}
                            <input type="hidden" name="parcoursId" value="{{ selected_parcours.id }}">
                        {% endif %}
                        <select name="experience" class="px-3 py-2 text-xs border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="">All experiences</option>
                            {% for label, value in experience_filters %}
                                <option value="{{ value }}" {{ selected_experience == value ? 'selected' : '' }}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <select name="typePublication" class="px-3 py-2 text-xs border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="">All types</option>
                            {% for label, value in type_publication_filters %}
                                <option value="{{ value }}" {{ selected_type_publication == value ? 'selected' : '' }}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <input
                            type="text"
                            name="hashtag"
                            value="{{ selected_hashtag ? '#' ~ selected_hashtag : '' }}"
                            placeholder="#hashtag"
                            class="w-32 px-3 py-2 text-xs border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white"
                        >
                        <select name="sortDate" class="px-3 py-2 text-xs border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="HOT" {{ selected_sort_date == 'HOT' ? 'selected' : '' }}>Hot publications</option>
                            <option value="DESC" {{ selected_sort_date == 'DESC' ? 'selected' : '' }}>Newest pub</option>
                            <option value="ASC" {{ selected_sort_date == 'ASC' ? 'selected' : '' }}>Oldest pub</option>
                        </select>
                        <button type="submit" class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600" title="Filter" aria-label="Filter">
                            <i class="fa-solid fa-filter"></i>
                        </button>
                        {% if selected_experience or selected_type_publication or selected_sort_date != 'DESC' or selected_hashtag %}
                            <a href="{{ path('app_publication_parcours_index', selected_parcours ? {'parcoursId': selected_parcours.id} : {}) }}" class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 dark:text-gray-200 dark:bg-gray-800 dark:border-gray-600 dark:hover:bg-gray-700" title="Reset" aria-label="Reset">
                                <i class="fa-solid fa-rotate-right"></i>
                            </a>
                        {% endif %}
                    </form>
                    <a href="{{ selected_parcours ? path('app_publication_parcours_new', {'parcoursId': selected_parcours.id}) : path('app_parcours_de_sante_index') }}" class="inline-flex items-center justify-center w-9 h-9 text-xs font-medium text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600" title="Add publication" aria-label="Add publication">
                        <i class="fa-solid fa-plus"></i>
                    </a>
                </div>
            </div>

            {% for publication_parcour in publication_parcours %}
                {% set image = publication_parcour.imagePublication %}
                {% set image_src = image %}
                {% set experience_value = publication_parcour.experience|default('N/A') %}
                {% set experience_key = experience_value|lower %}
                {% set experience_icon = experience_key == 'bad' ? 'fa-face-frown' : (experience_key == 'excellent' ? 'fa-face-laugh-beam' : (experience_key == 'good' ? 'fa-face-smile' : 'fa-face-meh')) %}
                {% set experience_color = experience_key == 'bad' ? 'text-red-600 dark:text-red-400' : (experience_key == 'excellent' ? 'text-emerald-600 dark:text-emerald-400' : (experience_key == 'good' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400')) %}
                {% set type_value = publication_parcour.typePublication|default('opinion') %}
                {% set type_label = type_value == 'event' ? 'Event' : 'Opinion' %}
                {% set hot_metrics = publication_hot_metrics[publication_parcour.id]|default({'hotScore': 0, 'commentCount': 0, 'ageDays': 0}) %}
                {% set publication_tags = publication_hashtags[publication_parcour.id]|default([]) %}
                {% if image %}
                    {% if image starts with 'http://' or image starts with 'https://' %}
                        {% set image_src = image %}
                    {% else %}
                        {% set image_path = image starts with '/' ? image : (image starts with 'uploads/' ? '/' ~ image : '/uploads/parcours/' ~ image) %}
                        {% set image_src = image_path|imagine_filter('publication_original') %}
                    {% endif %}
                {% endif %}

                <article class="overflow-hidden bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <div class="p-4">
                        {% set owner_first_initial = publication_parcour.ownerPatient and publication_parcour.ownerPatient.firstName ? publication_parcour.ownerPatient.firstName|trim|slice(0, 1)|upper : '' %}
                        {% set owner_last_initial = publication_parcour.ownerPatient and publication_parcour.ownerPatient.lastName ? publication_parcour.ownerPatient.lastName|trim|slice(0, 1)|upper : '' %}
                        {% set publication_avatar_initial = (owner_first_initial ~ owner_last_initial)|trim %}
                        {% if publication_avatar_initial == '' %}
                            {% set publication_avatar_initial = publication_parcour.parcoursDeSante ? publication_parcour.parcoursDeSante.nomParcours|slice(0, 1)|upper : 'P' %}
                        {% endif %}
                        <div class="flex items-start gap-3">
                            <div class="flex items-center justify-center w-10 h-10 text-sm font-semibold text-white rounded-full bg-wellcare-500">
                                {{ publication_avatar_initial }}
                            </div>

                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-gray-900 dark:text-white">
                                            {{ publication_parcour.ownerPatient ? publication_parcour.ownerPatient.fullName : (publication_parcour.parcoursDeSante ? publication_parcour.parcoursDeSante.nomParcours : 'Unknown user') }}
                                        </p>
                                        <p class="text-xs text-gray-500" title="{{ publication_parcour.datePublication ? publication_parcour.datePublication|date('M d, Y') : '-' }}">
                                            {{ publication_parcour.datePublication ? publication_parcour.datePublication|time_diff : 'No date' }}
                                        </p>
                                    </div>
                                    {% if is_granted('EDIT', publication_parcour) or is_granted('DELETE', publication_parcour) %}
                                        <div class="flex items-center gap-2">
                                            {% if is_granted('EDIT', publication_parcour) %}
                                                <a href="{{ path('app_publication_parcours_edit', {'id': publication_parcour.id}) }}" class="flex items-center justify-center w-8 h-8 transition rounded-full bg-white/90 hover:bg-white" title="Edit publication" aria-label="Edit publication">
                                                    <i class="text-blue-500 fa-solid fa-pen-to-square"></i>
                                                </a>
                                            {% endif %}
                                            {% if is_granted('DELETE', publication_parcour) %}
                                                <form method="post" action="{{ path('app_publication_parcours_delete', {'id': publication_parcour.id}) }}" onsubmit="return confirm('Are you sure you want to delete this publication?');">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ publication_parcour.id) }}">
                                                    <button type="submit" class="flex items-center justify-center w-8 h-8 transition rounded-full bg-white/90 hover:bg-white" title="Delete publication" aria-label="Delete publication">
                                                        <i class="text-red-500 fa-solid fa-trash"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="flex items-center gap-4 my-2 text-xs">
                                    <span class="flex items-center text-amber-500">
                                        <i class="mr-1 fa-solid fa-star"></i>{{ publication_parcour.ambiance }}/5 ambiance
                                    </span>
                                    <span class="flex items-center text-blue-900 dark:text-blue-300">
                                        <i class="mr-1 fa-solid fa-shield-halved"></i>{{ publication_parcour.securite }}/5 safety
                                    </span>
                                    <span class="flex items-center {{ experience_color }}">
                                        <i class="mr-1 fa-solid {{ experience_icon }}"></i>{{ experience_value }}
                                    </span>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200">
                                        {{ type_label }}
                                    </span>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300" title="{{ hot_metrics.commentCount }} comments, {{ hot_metrics.ageDays }} day(s) old">
                                        <i class="mr-1 fa-solid fa-fire"></i>{{ hot_metrics.hotScore }}
                                    </span>
                                    {% if publication_tags is not empty %}
                                        <span class="inline-flex items-center gap-2">
                                            {% for hashtag in publication_tags %}
                                                <a
                                                    href="{{ path('app_publication_parcours_index', {'hashtag': hashtag, 'sortDate': selected_sort_date}) }}"
                                                    class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full bg-wellcare-50 text-wellcare-700 hover:bg-wellcare-100 dark:bg-wellcare-900/30 dark:text-wellcare-300"
                                                >
                                                    #{{ hashtag }}
                                                </a>
                                            {% endfor %}
                                        </span>
                                    {% endif %}
                                </div>

                                <p class="mb-3 text-sm text-gray-700 dark:text-gray-300">
                                    {{ publication_parcour.textPublication }}
                                </p>

                                {% if image_src %}
                                    <div class="mb-3">
                                        <img src="{{ image_src }}" alt="Publication image {{ publication_parcour.id }}" class="object-cover w-full border border-gray-100 rounded-lg max-h-80 dark:border-gray-700">
                                    </div>
                                {% endif %}

                                <div class="flex items-center gap-4 pt-3 text-xs border-t border-gray-100 dark:border-gray-700">
                                    {% set comments_link_params = {'id': publication_parcour.id, 'sortDate': selected_sort_date, 'page': current_page} %}
                                    {% if selected_parcours %}
                                        {% set comments_link_params = comments_link_params|merge({'parcoursId': selected_parcours.id}) %}
                                    {% endif %}
                                    {% if selected_experience %}
                                        {% set comments_link_params = comments_link_params|merge({'experience': selected_experience}) %}
                                    {% endif %}
                                    {% if selected_type_publication %}
                                        {% set comments_link_params = comments_link_params|merge({'typePublication': selected_type_publication}) %}
                                    {% endif %}
                                    {% if selected_hashtag %}
                                        {% set comments_link_params = comments_link_params|merge({'hashtag': selected_hashtag}) %}
                                    {% endif %}
                                    <a href="{{ path('app_publication_parcours_comments', comments_link_params) }}" class="flex items-center gap-1 text-gray-500 hover:text-wellcare-500">
                                        <i class="fa-regular fa-comment"></i>{{ publication_parcour.commentairePublications|length }} comments
                                    </a>
                                </div>

                                <div class="pt-3 mt-3 border-t border-gray-100 dark:border-gray-700">
                                    <div class="space-y-2">
                                        {% for commentaire in publication_parcour.commentairePublications %}
                                            <div class="p-2 rounded-lg bg-gray-50 dark:bg-gray-700/40">
                                                <p class="text-[11px] font-medium text-gray-600 dark:text-gray-300">
                                                    {{ commentaire.ownerPatient ? commentaire.ownerPatient.fullName : 'Unknown user' }}
                                                </p>
                                                <div class="flex items-start justify-end gap-2">
                                                    {% if is_granted('EDIT', commentaire) or is_granted('DELETE', commentaire) %}
                                                        <div class="flex items-center gap-2">
                                                            {% if is_granted('EDIT', commentaire) %}
                                                                <button
                                                                    type="button"
                                                                    class="text-[11px] font-medium text-blue-600 hover:text-blue-700 dark:text-blue-300 dark:hover:text-blue-200"
                                                                    onclick="document.getElementById('edit-comment-form-{{ commentaire.id }}').classList.toggle('hidden')"
                                                                >
                                                                    Edit
                                                                </button>
                                                            {% endif %}
                                                            {% if is_granted('DELETE', commentaire) %}
                                                                <form method="post" action="{{ path('app_publication_parcours_comment_delete', {'id': publication_parcour.id, 'commentId': commentaire.id}) }}" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_comment' ~ commentaire.id) }}">
                                                                    {% if selected_parcours %}
                                                                        <input type="hidden" name="parcoursId" value="{{ selected_parcours.id }}">
                                                                    {% endif %}
                                                                    {% if selected_experience %}
                                                                        <input type="hidden" name="experience" value="{{ selected_experience }}">
                                                                    {% endif %}
                                                                    {% if selected_type_publication %}
                                                                        <input type="hidden" name="typePublication" value="{{ selected_type_publication }}">
                                                                    {% endif %}
                                                                    {% if selected_hashtag %}
                                                                        <input type="hidden" name="hashtag" value="{{ selected_hashtag }}">
                                                                    {% endif %}
                                                                    <input type="hidden" name="sortDate" value="{{ selected_sort_date }}">
                                                                    <input type="hidden" name="page" value="{{ current_page }}">
                                                                    <button
                                                                        type="submit"
                                                                        class="text-[11px] font-medium text-red-600 hover:text-red-700 dark:text-red-300 dark:hover:text-red-200"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                </form>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <p class="mt-1 text-xs text-gray-700 dark:text-gray-200">
                                                    {{ commentaire.commentaire }}
                                                </p>
                                                {% if is_granted('EDIT', commentaire) %}
                                                    <form
                                                        id="edit-comment-form-{{ commentaire.id }}"
                                                        method="post"
                                                        action="{{ path('app_publication_parcours_comment_edit', {'id': publication_parcour.id, 'commentId': commentaire.id}) }}"
                                                        class="hidden flex items-start gap-2 mt-2"
                                                        novalidate
                                                    >
                                                        <input type="hidden" name="_token" value="{{ csrf_token('edit_comment' ~ commentaire.id) }}">
                                                        {% if selected_parcours %}
                                                            <input type="hidden" name="parcoursId" value="{{ selected_parcours.id }}">
                                                        {% endif %}
                                                        {% if selected_experience %}
                                                            <input type="hidden" name="experience" value="{{ selected_experience }}">
                                                        {% endif %}
                                                        {% if selected_type_publication %}
                                                            <input type="hidden" name="typePublication" value="{{ selected_type_publication }}">
                                                        {% endif %}
                                                        {% if selected_hashtag %}
                                                            <input type="hidden" name="hashtag" value="{{ selected_hashtag }}">
                                                        {% endif %}
                                                        <input type="hidden" name="sortDate" value="{{ selected_sort_date }}">
                                                        <input type="hidden" name="page" value="{{ current_page }}">
                                                        <textarea
                                                            name="commentaire"
                                                            required
                                                            rows="2"
                                                            class="flex-1 px-3 py-2 text-xs border border-gray-200 rounded-lg resize-none dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent"
                                                        >{{ commentaire.commentaire }}</textarea>
                                                        <button
                                                            type="submit"
                                                            class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600"
                                                        >
                                                            Save
                                                        </button>
                                                        <button
                                                            type="button"
                                                            class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 dark:text-gray-200 dark:bg-gray-800 dark:border-gray-600 dark:hover:bg-gray-700"
                                                            onclick="document.getElementById('edit-comment-form-{{ commentaire.id }}').classList.add('hidden')"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400">No comments yet. Be the first to comment.</p>
                                        {% endfor %}
                                    </div>

                                    <form method="post" action="{{ path('app_publication_parcours_comment_add', {'id': publication_parcour.id}) }}" class="flex items-start gap-2 mt-3" novalidate>
                                        <input type="hidden" name="_token" value="{{ csrf_token('add_comment' ~ publication_parcour.id) }}">
                                        {% if selected_parcours %}
                                            <input type="hidden" name="parcoursId" value="{{ selected_parcours.id }}">
                                        {% endif %}
                                        {% if selected_experience %}
                                            <input type="hidden" name="experience" value="{{ selected_experience }}">
                                        {% endif %}
                                        {% if selected_type_publication %}
                                            <input type="hidden" name="typePublication" value="{{ selected_type_publication }}">
                                        {% endif %}
                                        {% if selected_hashtag %}
                                            <input type="hidden" name="hashtag" value="{{ selected_hashtag }}">
                                        {% endif %}
                                        <input type="hidden" name="sortDate" value="{{ selected_sort_date }}">
                                        <input type="hidden" name="page" value="{{ current_page }}">

                                        <textarea
                                            name="commentaire"
                                            required
                                            rows="2"
                                            placeholder="Write a comment..."
                                            class="flex-1 px-3 py-2 text-xs border border-gray-200 rounded-lg resize-none dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent"
                                        ></textarea>
                                        <button type="submit" class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                                            Post
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            {% else %}
                <div class="p-6 text-center bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                    <p class="text-sm text-gray-600 dark:text-gray-300">No publications found.</p>
                    <a href="{{ selected_parcours ? path('app_publication_parcours_new', {'parcoursId': selected_parcours.id}) : path('app_parcours_de_sante_index') }}" class="inline-flex items-center gap-2 px-4 py-2 mt-3 text-sm text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                        <i class="fa-solid fa-plus"></i>Create the first publication
                    </a>
                </div>
            {% endfor %}

            <div class="mt-4">
                {{ knp_pagination_render(publication_parcours) }}
            </div>
        </div>

        <aside class="space-y-4">
            <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <h3 class="mb-3 font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fa-solid fa-pen text-wellcare-500"></i>Share Your Experience
                </h3>
                <a href="{{ selected_parcours ? path('app_publication_parcours_new', {'parcoursId': selected_parcours.id}) : path('app_parcours_de_sante_index') }}" class="flex items-center justify-center gap-2 px-4 py-2 text-sm text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                    <i class="fa-solid fa-camera"></i> Write a Publication
                </a>
            </div>

            <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                <h3 class="mb-3 font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 text-orange-500 fa-solid fa-fire"></i>Quick Links
                </h3>
                <div class="space-y-2">
                    <a href="{{ path('app_publication_parcours_index') }}" class="block p-2 text-xs rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        Trail publication feed
                    </a>
                    <a href="{{ path('app_parcours_de_sante_index') }}" class="block p-2 text-xs rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        Back to trails
                    </a>
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}


