{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Workout Planner - WellCare Connect' }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('fitness') }}
    <style>
        .calendar-container {
            transition: all 0.3s ease;
        }
        .calendar-day-cell {
            min-height: 120px;
            position: relative;
        }
        .calendar-week-cell {
            min-height: 80px;
        }
        .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .calendar-toolbar {
            transition: all 0.3s ease;
        }
        .month-view .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
        }
        .week-view .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
        }
        .day-view .calendar-grid {
            grid-template-columns: 1fr;
        }
        .time-slots {
            border-right: 1px solid #e5e7eb;
        }
        @media (prefers-color-scheme: dark) {
            .time-slots {
                border-right-color: #4b5563;
            }
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('fitness') }}
{% endblock %}

{% block body %}
<div x-data="workoutPlanner()" class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm dark:bg-gray-800 dark:border-gray-700">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{{ path('fitness_dashboard') }}" class="p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="text-gray-600 fas fa-arrow-left dark:text-gray-400"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="mr-2 fas fa-calendar-alt text-wellcare-500"></i>
                            {{ 'Workout Planner' }}
                        </h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ 'Plan and schedule your weekly workouts' }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    
                    <div class="flex items-center gap-2">
                        <button @click="previousPeriod()" class="p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="text-gray-600 fas fa-chevron-left dark:text-gray-400"></i>
                        </button>
                        <button @click="nextPeriod()" class="p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="text-gray-600 fas fa-chevron-right dark:text-gray-400"></i>
                        </button>
                        <button @click="goToToday()" class="px-3 py-1 text-sm font-medium transition-colors rounded-lg text-wellcare-600 dark:text-wellcare-400 hover:bg-wellcare-50 dark:hover:bg-wellcare-900/30">
                            {{ 'Today' }}
                        </button>
                        <button @click="toggleView()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <i class="fas" :class="calendarView === 'month' ? 'fa-calendar-week' : (calendarView === 'week' ? 'fa-calendar-day' : 'fa-calendar')"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="p-6">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
            <!-- Main Calendar -->
            <div class="lg:col-span-3">
                <div class="p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700 calendar-container" :class="calendarView + '-view'">
                    <!-- Calendar Header -->
                    <div class="flex items-center justify-between mb-6 calendar-toolbar">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white" x-text="currentPeriodTitle"></h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <select x-model="selectedView" @change="changeView()" class="px-3 py-1 text-sm text-gray-700 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-gray-300 focus:ring-wellcare-500 focus:border-wellcare-500">
                                <option value="month">{{ 'Month' }}</option>
                                <option value="week">{{ 'Week' }}</option>
                                <option value="day">{{ 'Day' }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Month View -->
                    <template x-if="calendarView === 'month'">
                        <div>
                            <!-- Day headers -->
                            <div class="grid grid-cols-7 gap-1 mb-2">
                                {% for day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] %}
                                <div class="py-2 text-sm font-medium text-center text-gray-500 dark:text-gray-400">{{ day }}</div>
                                {% endfor %}
                            </div>
                            
                            <!-- Days grid -->
                            <div class="grid grid-cols-7 gap-1">
                                <template x-for="(day, index) in monthDays" :key="index">
                                    <div 
                                        @click="selectDay(day)"
                                        class="p-2 transition-all duration-200 border rounded-lg cursor-pointer calendar-day-cell"
                                        :class="{
                                            'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-wellcare-500': !day.isCurrentMonth,
                                            'bg-wellcare-50 dark:bg-wellcare-900/20 border-wellcare-500 dark:border-wellcare-500': day.isToday,
                                            'bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600': day.isSelected
                                        }">
                                        <div class="flex items-center justify-between mb-1">
                                            <span 
                                                class="text-sm font-medium"
                                                :class="{
                                                    'text-gray-400 dark:text-gray-500': !day.isCurrentMonth,
                                                    'text-wellcare-600 dark:text-wellcare-400 font-bold': day.isToday,
                                                    'text-gray-900 dark:text-white': day.isCurrentMonth && !day.isToday
                                                }"
                                                x-text="day.date.getDate()"></span>
                                            <span 
                                                class="flex items-center justify-center w-6 h-6 text-xs rounded-full"
                                                :class="{
                                                    'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400': day.workoutsCompleted > 0,
                                                    'bg-wellcare-100 dark:bg-wellcare-900/30 text-wellcare-600 dark:text-wellcare-400': day.workoutsCompleted === 0 && day.hasWorkout,
                                                    'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400': day.isRestDay
                                                }"
                                                x-show="day.hasWorkout || day.isRestDay"
                                                x-text="day.workoutsCompleted > 0 ? day.workoutsCompleted : ''">
                                            </span>
                                        </div>
                                        <div class="space-y-1">
                                            <template x-for="plan in day.plans.slice(0, 2)">
                                                <div 
                                                    class="p-1 text-xs truncate rounded"
                                                    :class="{
                                                        'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400': plan.status === 'completed',
                                                        'bg-wellcare-100 dark:bg-wellcare-900/30 text-wellcare-700 dark:text-wellcare-400': plan.status === 'scheduled' || plan.status === 'planned',
                                                        'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': plan.status === 'in_progress',
                                                        'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': plan.isRestDay
                                                    }"
                                                    x-text="plan.title">
                                                </div>
                                            </template>
                                            <div x-show="day.plans.length > 2" class="text-xs text-gray-500 dark:text-gray-400">
                                                +<span x-text="day.plans.length - 2"></span> {{ 'more' }}
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Week View - Section corrigée -->
<template x-if="calendarView === 'week'">
    <div>
        
        <!-- Week header -->
        <div class="grid grid-cols-8 gap-1 mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
            <div class="py-2 text-sm font-medium text-center text-gray-500 dark:text-gray-400">{{ 'Time' }}</div>
            <template x-for="(day, index) in weekDays" :key="index">
                <div class="py-2 text-center"
                     :class="{
                         'text-gray-900 dark:text-white': !isToday(day.date),
                         'text-wellcare-600 dark:text-wellcare-400 font-bold': isToday(day.date)
                     }">
                    <div class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        <span x-text="day.date.toLocaleDateString('en-US', { weekday: 'short' })"></span>
                    </div>
                    <div class="flex items-center justify-center w-8 h-8 mx-auto rounded-full"
                         :class="{
                             'bg-gray-100 dark:bg-gray-700': !isToday(day.date),
                             'bg-wellcare-500 text-white': isToday(day.date)
                         }">
                        <span x-text="day.date.getDate()"></span>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Time slots grid -->
        <div class="relative" style="height: 720px;"> <!-- 12 hours * 60px -->
            <!-- Time labels -->
            <div class="absolute left-0 top-0 w-16 h-full border-r border-gray-200 dark:border-gray-700">
                <template x-for="hour in hours" :key="hour">
                    <div class="h-12 flex items-center justify-end pr-3">
                        <span class="text-xs text-gray-500 dark:text-gray-400" 
                              x-text="formatHour(hour)"></span>
                    </div>
                </template>
            </div>
            
            <!-- Days columns -->
            <div class="ml-16 grid grid-cols-7 h-full">
                <template x-for="(day, dayIndex) in weekDays" :key="dayIndex">
                    <div class="border-l border-gray-100 dark:border-gray-800 relative">
                        <!-- Time slots -->
                        <template x-for="hour in hours" :key="hour">
                            <div 
                                @click="openAddModalAtTime(day.date, hour)"
                                class="h-12 border-t border-gray-100 dark:border-gray-800 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 relative"
                                :class="{
                                    'bg-gray-50 dark:bg-gray-800/30': hour % 2 === 0
                                }">
                            </div>
                        </template>
                        
                        <!-- Workout plans -->
                        <template x-for="plan in day.plans" :key="plan.id">
                            <div 
                                @click.stop="editPlan(plan)"
                                class="absolute left-1 right-1 p-2 text-xs rounded-lg shadow-sm border cursor-pointer transition-all hover:shadow-md"
                                :class="{
                                    'bg-green-100 dark:bg-green-900/60 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200': plan.status === 'completed',
                                    'bg-wellcare-100 dark:bg-wellcare-900/60 border-wellcare-200 dark:border-wellcare-800 text-wellcare-800 dark:text-wellcare-200': plan.status === 'scheduled' || plan.status === 'planned',
                                    'bg-yellow-100 dark:bg-yellow-900/60 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200': plan.status === 'in_progress',
                                    'bg-purple-100 dark:bg-purple-900/60 border-purple-200 dark:border-purple-800 text-purple-800 dark:text-purple-200': plan.status === 'rest'
                                }"
                                :style="'top: ' + (getPlanTopPosition(plan)) + 'px; height: ' + (getPlanHeight(plan)) + 'px;'">
                                <div class="font-medium truncate" x-text="plan.title"></div>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="text-xs opacity-75" x-text="plan.duration + ' min'"></span>
                                    <template x-if="plan.exercises > 0">
                                        <span class="text-xs opacity-75" x-text="plan.exercises + ' ex'"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            
            <!-- Current time line (optionnel) -->
            <div x-show="showCurrentTime" class="absolute left-16 right-0 h-0.5 bg-red-500 z-10"
                 :style="'top: ' + currentTimePosition + 'px;'">
                <div class="absolute -left-2 -top-1.5 w-3 h-3 bg-red-500 rounded-full"></div>
            </div>
        </div>
        
        <!-- Légende -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-wrap items-center gap-4 text-xs">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-wellcare-100 dark:bg-wellcare-900/60"></div>
                    <span class="text-gray-600 dark:text-gray-400">Planned</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-green-100 dark:bg-green-900/60"></div>
                    <span class="text-gray-600 dark:text-gray-400">Completed</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-yellow-100 dark:bg-yellow-900/60"></div>
                    <span class="text-gray-600 dark:text-gray-400">In Progress</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-purple-100 dark:bg-purple-900/60"></div>
                    <span class="text-gray-600 dark:text-gray-400">Rest Day</span>
                </div>
            </div>
        </div>
    </div>
</template>
                </div>

                <!-- Weekly Summary -->
                <div class="grid grid-cols-2 gap-4 mt-6 md:grid-cols-4">
                    <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Scheduled' }}</p>
                                <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="weeklyStats.scheduled"></p>
                            </div>
                            <div class="flex items-center justify-center w-10 h-10 bg-blue-100 rounded-full dark:bg-blue-900/30">
                                <i class="text-blue-500 fas fa-calendar-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Completed' }}</p>
                                <p class="text-xl font-bold text-green-500" x-text="weeklyStats.completed"></p>
                            </div>
                            <div class="flex items-center justify-center w-10 h-10 bg-green-100 rounded-full dark:bg-green-900/30">
                                <i class="text-green-500 fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Total Minutes' }}</p>
                                <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="weeklyStats.minutes"></p>
                            </div>
                            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                <i class="fas fa-stopwatch text-wellcare-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Rest Days' }}</p>
                                <p class="text-xl font-bold text-orange-500" x-text="weeklyStats.restDays"></p>
                            </div>
                            <div class="flex items-center justify-center w-10 h-10 bg-orange-100 rounded-full dark:bg-orange-900/30">
                                <i class="text-orange-500 fas fa-bed"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Day Details -->
            <div class="lg:col-span-1">
                <div class="sticky p-6 bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700 top-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900 dark:text-white" x-text="selectedDayLabel"></h3>
                        <button @click="openQuickAdd()" class="text-wellcare-500 hover:text-wellcare-600">
                            <i class="text-xl fas fa-plus-circle"></i>
                        </button>
                    </div>

                    <!-- Day Stats -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Duration' }}</p>
                            <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="selectedDayDetails.duration + ' min'"></p>
                        </div>
                        <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ 'Calories' }}</p>
                            <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="selectedDayDetails.calories"></p>
                        </div>
                    </div>

                    <!-- Workouts List -->
                    <div class="mb-4 space-y-3">
                        <template x-for="plan in selectedDayPlans" :key="plan.id">
                            <div 
                                @click="editPlan(plan)"
                                class="p-3 transition-colors border border-gray-100 rounded-lg cursor-pointer dark:border-gray-700 hover:border-wellcare-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span 
                                        class="px-2 py-1 text-xs font-medium rounded"
                                        :class="{
                                            'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400': plan.status === 'completed',
                                            'bg-wellcare-100 dark:bg-wellcare-900/30 text-wellcare-700 dark:text-wellcare-400': plan.status === 'scheduled' || plan.status === 'planned',
                                            'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400': plan.status === 'in_progress',
                                            'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400': plan.isRestDay
                                        }"
                                        x-text="plan.statusLabel"></span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400" x-text="plan.duration + ' min'"></span>
                                </div>
                                <h4 class="font-medium text-gray-900 dark:text-white" x-text="plan.title"></h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="plan.exercises + ' exercises'"></p>
                                <p class="text-xs text-gray-400 dark:text-gray-500" x-text="plan.notes"></p>
                            </div>
                        </template>
                       
                    </div>

                    <!-- Quick Actions -->
                    <div class="pt-4 space-y-2 border-t border-gray-100 dark:border-gray-700">
                        <button @click="markAllComplete()" class="flex items-center justify-center w-full gap-2 px-4 py-2 font-medium text-white transition-colors bg-green-500 rounded-lg hover:bg-green-600">
                            <i class="fas fa-check-double"></i>
                            {{ 'Mark All Complete' }}
                        </button>
                        
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Workout Modal -->
    <div x-show="showModal" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div @click="showModal = false" class="fixed inset-0 transition-opacity bg-black bg-opacity-50"></div>
            
            <div class="relative z-10 w-full max-w-lg p-6 bg-white shadow-xl dark:bg-gray-800 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white" x-text="modalMode === 'add' ? 'Add Workout' : 'Edit Workout'"></h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="text-xl fas fa-times"></i>
                    </button>
                </div>

                <form @submit.prevent="saveWorkout()" class="space-y-4">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Workout Name *</label>
                        <input type="text" x-model="workoutForm.title" required class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500" placeholder="e.g., Upper Body Strength">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Date *</label>
                            <input type="date" x-model="workoutForm.date" required class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Time</label>
                            <input type="time" x-model="workoutForm.time" class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Duration (min) *</label>
                            <input type="number" x-model="workoutForm.duration" required class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500" placeholder="45">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                            <select x-model="workoutForm.status" class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500">
                                <option value="planned">Planned</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
                        <textarea x-model="workoutForm.notes" rows="3" class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500" placeholder="Any special instructions or notes..."></textarea>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" @click="showModal = false" class="flex-1 px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                            Save Workout
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Emergency Stop Button -->
    <div class="fixed bottom-6 right-6">
        <a href="{{ path('coach_daily_plan_new') }}" class="flex items-center justify-center text-white transition-all duration-200 bg-wellcare-500 rounded-full shadow-lg w-14 h-14 hover:bg-wellcare-600 hover:scale-110">
            <i class="text-xl fas fa-plus"></i>
        </a>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('workoutPlanner', () => ({
        darkMode: false,
        calendarView: 'month',
        selectedView: 'month',
        currentDate: new Date(),
        selectedDay: null,
        showModal: false,
        modalMode: 'add',
        
        // Données réelles de Symfony
        dailyPlans: {{ dailyPlans|default([])|json_encode|raw }},
        weeklyStats: {{ weeklyStats|default({
            scheduled: 0,
            completed: 0,
            minutes: 0,
            restDays: 0,
            calories: 0
        })|json_encode|raw }},
        
        selectedDayDetails: {
            duration: 0,
            calories: 0,
            isRestDay: false
        },

        selectedDayLabel: 'Select a Day',
        selectedDayPlans: [],
        monthDays: [],
        weekDays: [],
        hours: Array.from({length: 12}, (_, i) => i + 7), // 7 AM to 6 PM

        workoutForm: {
            id: null,
            title: '',
            date: '',
            time: '08:00',
            duration: 45,
            notes: '',
            status: 'planned'
        },

        init() {
            this.darkMode = localStorage.getItem('theme') === 'dark';
            this.generateCalendar();
            
            // Set selected day to today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            this.selectedDay = {
                date: today,
                isCurrentMonth: true,
                isToday: true,
                isSelected: true
            };
            
            this.updateSelectedDay();
        },

        // Getters pour les titres de période
        get currentPeriodTitle() {
            if (this.calendarView === 'month') {
                return this.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } else if (this.calendarView === 'week') {
                const startOfWeek = this.getStartOfWeek(this.currentDate);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                return startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
                       ' - ' + 
                       endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else {
                return this.selectedDay.date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }
        },

        // Génération du calendrier
        generateCalendar() {
            if (this.calendarView === 'month') {
                this.generateMonthView();
            } else if (this.calendarView === 'week') {
                this.generateWeekView();
            }
        },

        generateMonthView() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            
            this.monthDays = [];
            
            // Jours du mois précédent
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startPadding - 1; i >= 0; i--) {
                const dayDate = new Date(year, month - 1, prevMonthLastDay - i);
                dayDate.setHours(0, 0, 0, 0);
                this.monthDays.push(this.createDayObject(dayDate, false));
            }
            
            // Jours du mois courant
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayDate = new Date(year, month, i);
                dayDate.setHours(0, 0, 0, 0);
                this.monthDays.push(this.createDayObject(dayDate, true, dayDate.getTime() === today.getTime()));
            }
            
            // Jours du mois suivant
            const remaining = 42 - this.monthDays.length;
            for (let i = 1; i <= remaining; i++) {
                const dayDate = new Date(year, month + 1, i);
                dayDate.setHours(0, 0, 0, 0);
                this.monthDays.push(this.createDayObject(dayDate, false));
            }
        },

        generateWeekView() {
            const startOfWeek = this.getStartOfWeek(this.currentDate);
            this.weekDays = [];
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                dayDate.setHours(0, 0, 0, 0);
                this.weekDays.push({
                    date: dayDate,
                    plans: this.getPlansForDate(dayDate.toISOString().split('T')[0])
                });
            }
        },

        createDayObject(date, isCurrentMonth, isToday = false) {
            const dateStr = date.toISOString().split('T')[0];
            const plans = this.getPlansForDate(dateStr);
            const hasWorkout = plans.length > 0;
            const workoutsCompleted = plans.filter(p => p.status === 'completed').length;
            const isRestDay = !hasWorkout || plans.every(p => p.isRestDay);
            
            return {
                date: date,
                dateStr: dateStr,
                isCurrentMonth: isCurrentMonth,
                isToday: isToday,
                isSelected: false,
                isRestDay: isRestDay,
                hasWorkout: hasWorkout,
                workoutsCompleted: workoutsCompleted,
                plans: plans
            };
        },

        getPlansForDate(dateStr) {
            return this.dailyPlans.filter(plan => plan.date === dateStr).map(plan => ({
                ...plan,
                statusLabel: this.getStatusLabel(plan.status),
                isRestDay: plan.exercises === 0
            }));
        },

        getPlansAtTime(date, hour) {
            const dateStr = date.toISOString().split('T')[0];
            const plans = this.getPlansForDate(dateStr);
            
            // Pour simplifier, nous allons juste retourner les plans du jour
            // Dans une vraie application, vous voudriez filtrer par heure
            return plans;
        },

        getStartOfWeek(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day + (day === 0 ? -6 : 1);
            start.setDate(diff);
            start.setHours(0, 0, 0, 0);
            return start;
        },

        getStatusLabel(status) {
            const labels = {
                'planned': 'Planned',
                'in_progress': 'In Progress',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return labels[status] || status;
        },

        isToday(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            return date.getTime() === today.getTime();
        },

        formatHour(hour) {
            return hour <= 12 ? `${hour} AM` : `${hour - 12} PM`;
        },

        // Navigation
        previousPeriod() {
            if (this.calendarView === 'month') {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            } else if (this.calendarView === 'week') {
                this.currentDate.setDate(this.currentDate.getDate() - 7);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() - 1);
            }
            this.generateCalendar();
        },

        nextPeriod() {
            if (this.calendarView === 'month') {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            } else if (this.calendarView === 'week') {
                this.currentDate.setDate(this.currentDate.getDate() + 7);
            } else {
                this.currentDate.setDate(this.currentDate.getDate() + 1);
            }
            this.generateCalendar();
        },

        goToToday() {
            this.currentDate = new Date();
            this.selectedDay = {
                date: new Date(),
                isCurrentMonth: true,
                isToday: true,
                isSelected: true
            };
            this.generateCalendar();
            this.updateSelectedDay();
        },

        toggleView() {
            const views = ['month', 'week', 'day'];
            const currentIndex = views.indexOf(this.calendarView);
            this.calendarView = views[(currentIndex + 1) % views.length];
            this.selectedView = this.calendarView;
            this.generateCalendar();
        },

        changeView() {
            this.calendarView = this.selectedView;
            this.generateCalendar();
        },

        // Sélection de jour
        selectDay(day) {
            if (this.calendarView === 'month') {
                this.monthDays.forEach(d => d.isSelected = false);
                day.isSelected = true;
            }
            
            this.selectedDay = day;
            this.updateSelectedDay();
        },

        updateSelectedDay() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            this.selectedDayLabel = months[this.selectedDay.date.getMonth()] + ' ' + 
                                   this.selectedDay.date.getDate() + ', ' + 
                                   this.selectedDay.date.getFullYear();
            
            const dateStr = this.selectedDay.date.toISOString().split('T')[0];
            this.selectedDayPlans = this.getPlansForDate(dateStr);
            
            // Calculer les totaux pour la journée
            const totalDuration = this.selectedDayPlans.reduce((sum, plan) => sum + (plan.duration || 0), 0);
            const totalCalories = this.selectedDayPlans.reduce((sum, plan) => sum + (plan.calories || 0), 0);
            
            this.selectedDayDetails = {
                duration: totalDuration,
                calories: totalCalories,
                isRestDay: this.selectedDay.isRestDay
            };
        },

        // Modals
        openQuickAdd() {
            this.modalMode = 'add';
            const today = new Date().toISOString().split('T')[0];
            this.workoutForm = {
                id: null,
                title: '',
                date: this.selectedDay ? this.selectedDay.dateStr : today,
                time: '08:00',
                duration: 45,
                notes: '',
                status: 'planned'
            };
            this.showModal = true;
        },

        openAddModalAtTime(date, hour) {
            this.modalMode = 'add';
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = hour.toString().padStart(2, '0') + ':00';
            
            this.workoutForm = {
                id: null,
                title: '',
                date: dateStr,
                time: timeStr,
                duration: 45,
                notes: '',
                status: 'planned'
            };
            this.showModal = true;
        },

        editPlan(plan) {
            window.location.href = `/coach/daily-plans/${plan.id}/edit`;
        },

        async saveWorkout() {
            try {
                const formData = new FormData();
                formData.append('title', this.workoutForm.title);
                formData.append('date', this.workoutForm.date);
                formData.append('duration', this.workoutForm.duration);
                formData.append('notes', this.workoutForm.notes);
                formData.append('status', this.workoutForm.status);
                
                const url = this.workoutForm.id ? 
                    `/coach/daily-plans/${this.workoutForm.id}/edit` : 
                    '/coach/daily-plan/new';
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving workout plan');
            }
            
            this.showModal = false;
        },

        markAllComplete() {
            if (!this.selectedDayPlans.length) {
                alert('No workouts to mark as complete');
                return;
            }
            
            this.selectedDayPlans.forEach(plan => {
                if (plan.status !== 'completed') {
                    fetch(`/coach/daily-plans/${plan.id}/complete`, {
                        method: 'POST'
                    });
                }
            });
            
            alert('All workouts for this day marked as complete!');
            window.location.reload();
        },

        copyToNextWeek() {
            if (!this.selectedDayPlans.length) {
                alert('No workouts to copy');
                return;
            }
            
            const nextWeekDate = new Date(this.selectedDay.date);
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            const nextWeekDateStr = nextWeekDate.toISOString().split('T')[0];
            
            this.selectedDayPlans.forEach(plan => {
                fetch('/coach/daily-plan/new', {
                    method: 'POST',
                    body: new URLSearchParams({
                        title: plan.title + ' (Copy)',
                        date: nextWeekDateStr,
                        duration: plan.duration,
                        notes: plan.notes,
                        status: 'planned'
                    })
                });
            });
            
            alert('Workouts copied to next week!');
            window.location.reload();
        }
    }));
});
</script>
{% endblock %}