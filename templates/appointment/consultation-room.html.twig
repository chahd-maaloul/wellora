{# templates/appointment/consultation-room.html.twig #}
{# Video Consultation Room for Teleconsultation #}

{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Video Consultation'|trans }} - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="min-h-full" x-data="consultationRoom()" x-init="init()">
    {# Consultation Header #}
    <div class="bg-white border-b border-gray-200 dark:bg-gray-900 dark:border-gray-800">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                        <i class="fa-solid fa-video text-wellcare-600 dark:text-wellcare-400"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900 dark:text-white">
                            {{ 'Video Consultation'|trans }}
                        </h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ 'Appointment ID'|trans }}: #{{ appointmentId }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                {# Connection Status #}
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800">
                    <span class="w-2 h-2 rounded-full" :class="isConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400" x-text="connectionStatus"></span>
                </div>
            </div>
        </div>
    </div>

    {# Main Consultation Area #}
    <div class="flex h-[calc(100vh-64px)]">
        {# Video Container #}
        <div class="relative flex-1 bg-gray-900">
            {# Main Video (Doctor) #}
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                    <div class="flex items-center justify-center w-32 h-32 mx-auto mb-4 bg-gray-800 rounded-full">
                        <i class="text-4xl text-gray-600 fa-solid fa-user-doctor"></i>
                    </div>
                    <p class="text-lg font-medium text-white">{{ 'Waiting for doctor to join...'|trans }}</p>
                    <p class="mt-1 text-sm text-gray-400">{{ 'Dr. Ahmed Ben Ali'|trans }}</p>
                </div>
            </div>

            {# Self Video (Patient) #}
            <div class="absolute w-48 overflow-hidden bg-gray-800 border-2 border-gray-700 rounded-lg shadow-lg bottom-4 right-4 h-36">
                <div class="flex items-center justify-center w-full h-full" x-show="!selfVideoEnabled">
                    <div class="text-center">
                        <i class="text-2xl text-gray-600 fa-solid fa-user"></i>
                        <p class="mt-1 text-xs text-gray-500">{{ 'Camera off'|trans }}</p>
                    </div>
                </div>
                <video x-show="selfVideoEnabled" id="self-video" class="object-cover w-full h-full" autoplay muted playsinline></video>
                
                {# Self Video Controls Overlay #}
                <div class="absolute flex items-center justify-center gap-2 bottom-2 left-2 right-2">
                    <button @click="toggleSelfVideo()" 
                            class="p-2 transition-colors rounded-full"
                            :class="selfVideoEnabled ? 'bg-gray-700 hover:bg-gray-600' : 'bg-red-500 hover:bg-red-600'">
                        <i class="fa-solid" :class="selfVideoEnabled ? 'fa-video' : 'fa-video-slash'"></i>
                    </button>
                </div>
            </div>

            {# Video Controls #}
            <div class="absolute flex items-center gap-3 px-4 py-3 transform -translate-x-1/2 rounded-full bottom-6 left-1/2 bg-gray-800/90 backdrop-blur-sm">
                <button @click="toggleMute()" 
                        class="p-3 transition-colors rounded-full"
                        :class="isMuted ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-700 hover:bg-gray-600'"
                        :title="isMuted ? 'Unmute' : 'Mute'">
                    <i class="fa-solid" :class="isMuted ? 'fa-microphone-slash' : 'fa-microphone'"></i>
                </button>
                
                <button @click="toggleSelfVideo()" 
                        class="p-3 transition-colors rounded-full"
                        :class="selfVideoEnabled ? 'bg-gray-700 hover:bg-gray-600' : 'bg-red-500 hover:bg-red-600'"
                        :title="selfVideoEnabled ? 'Turn off camera' : 'Turn on camera'">
                    <i class="fa-solid" :class="selfVideoEnabled ? 'fa-video' : 'fa-video-slash'"></i>
                </button>
                
                <button @click="toggleChat()" 
                        class="relative p-3 transition-colors rounded-full"
                        :class="chatOpen ? 'bg-wellcare-600 hover:bg-wellcare-700' : 'bg-gray-700 hover:bg-gray-600'">
                    <i class="fa-solid fa-comment"></i>
                    <span x-show="unreadMessages > 0" 
                          class="absolute flex items-center justify-center w-5 h-5 text-xs text-white bg-red-500 rounded-full -top-1 -right-1"
                          x-text="unreadMessages"></span>
                </button>
                
                <button @click="endCall()" 
                        class="p-3 px-6 transition-colors bg-red-500 rounded-full hover:bg-red-600"
                        :title="'End call'">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
        </div>

        {# Chat Sidebar #}
        <div x-show="chatOpen" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="flex flex-col bg-white border-l border-gray-200 w-80 dark:bg-gray-900 dark:border-gray-800"
             style="display: none;">
            {# Chat Header #}
            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-800">
                <h3 class="font-semibold text-gray-900 dark:text-white">{{ 'Chat'|trans }}</h3>
                <button @click="chatOpen = false" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            {# Messages #}
            <div class="flex-1 p-4 space-y-4 overflow-y-auto" x-ref="messagesContainer">
                {# Welcome Message #}
                <div class="text-center">
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        {{ 'Messages are end-to-end encrypted'|trans }}
                    </p>
                </div>
            </div>

            {# Message Input #}
            <div class="p-4 border-t border-gray-200 dark:border-gray-800">
                <form @submit.prevent="sendMessage()" class="flex items-center gap-2">
                    <input type="text" 
                           x-model="newMessage"
                           class="flex-1 input" 
                           :placeholder="'Type a message...'|trans"
                           :disabled="!isConnected">
                    <button type="submit" 
                            class="p-2 btn-primary"
                            :disabled="!newMessage.trim() || !isConnected">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ parent() }}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('consultationRoom', () => ({
        appointmentId: {{ appointmentId }},
        isConnected: false,
        connectionStatus: 'Connecting...',
        isMuted: false,
        selfVideoEnabled: true,
        chatOpen: false,
        unreadMessages: 0,
        newMessage: '',
        messages: [],

        init() {
            this.simulateConnection();
        },

        simulateConnection() {
            // Simulate connection after 2 seconds
            setTimeout(() => {
                this.isConnected = true;
                this.connectionStatus = 'Connected';
            }, 2000);
        },

        toggleMute() {
            this.isMuted = !this.isMuted;
        },

        toggleSelfVideo() {
            this.selfVideoEnabled = !this.selfVideoEnabled;
        },

        toggleChat() {
            this.chatOpen = !this.chatOpen;
            if (this.chatOpen) {
                this.unreadMessages = 0;
            }
        },

        sendMessage() {
            if (!this.newMessage.trim()) return;
            
            this.messages.push({
                text: this.newMessage,
                sender: 'me',
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            
            this.newMessage = '';
            
            // Scroll to bottom
            this.$nextTick(() => {
                this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
            });
        },

        endCall() {
            if (confirm('Are you sure you want to end this consultation?')) {
                window.location.href = '/appointment/dashboard';
            }
        }
    }));
});
</script>
{% endblock %}
