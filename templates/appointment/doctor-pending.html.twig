{# templates/appointment/doctor-pending.html.twig #}
{% extends 'layouts/app.html.twig' %}

{% block title %}Demandes de rendez-vous en attente - WellCare Connect{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-950">
    <div class="px-6 py-4 bg-white border-b border-gray-200 dark:bg-gray-900 dark:border-gray-800">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="mr-2 fa-solid fa-clock text-amber-500"></i>
                Demandes de rendez-vous en attente
            </h1>
            <div class="flex items-center gap-3">
                <span class="px-3 py-1 text-sm font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 rounded-full">
                    <i class="mr-1 fa-solid fa-clock"></i>
                    {{ pendingAppointments|length }} en attente
                </span>
                <a href="{{ path('doctor_schedule_week_view') }}" class="px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                    <i class="mr-2 fa-solid fa-arrow-left"></i>
                    Retour au planning
                </a>
            </div>
        </div>
    </div>

    <div class="p-6">
        {% if pendingAppointments is empty %}
            <div class="flex flex-col items-center justify-center p-12 text-center bg-white rounded-lg shadow dark:bg-gray-900">
                <div class="w-24 h-24 mb-4 text-gray-400">
                    <i class="fa-solid fa-calendar-check fa-4x"></i>
                </div>
                <h3 class="mb-2 text-lg font-medium text-gray-900 dark:text-white">
                    Aucune demande en attente
                </h3>
                <p class="text-gray-500 dark:text-gray-400">
                    Tous les rendez-vous sont traités.
                </p>
                <a href="{{ path('doctor_schedule_week') }}" class="mt-4 px-4 py-2 text-sm font-medium text-white bg-wellcare-500 rounded-lg hover:bg-wellcare-600">
                    <i class="mr-2 fa-solid fa-calendar"></i>
                    Voir mon planning
                </a>
            </div>
        {% else %}
            <div class="grid gap-4">
                {% for appointment in pendingAppointments %}
                    <div class="p-6 bg-white rounded-lg shadow dark:bg-gray-900 border-l-4 border-amber-500" id="appointment-{{ appointment.id }}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/30">
                                        <i class="fa-solid fa-user-clock text-amber-600 dark:text-amber-400"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                            {{ appointment.patient ? appointment.patient.fullName : ('Patient #' ~ appointment.id) }}
                                        </h3>
                                        <span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 rounded-full">
                                            En attente
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 mt-2">
                                        <div class="space-y-2">
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-calendar text-amber-500"></i>
                                                <span class="font-medium">Date:</span> 
                                                {{ appointment.dateConsultation|date('d/m/Y') }}
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-clock text-amber-500"></i>
                                                <span class="font-medium">Heure:</span> 
                                                {{ appointment.timeConsultation|date('H:i') }}
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-hourglass-half text-amber-500"></i>
                                                <span class="font-medium">Durée:</span> 
                                                {{ appointment.duration }} min
                                            </p>
                                        </div>
                                        <div class="space-y-2">
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-tag text-amber-500"></i>
                                                <span class="font-medium">Type:</span> 
                                                {% if appointment.consultationType == 'first-visit' %}
                                                    Première visite
                                                {% elseif appointment.consultationType == 'follow-up' %}
                                                    Suivi
                                                {% elseif appointment.consultationType == 'procedure' %}
                                                    Procédure
                                                {% else %}
                                                    {{ appointment.consultationType }}
                                                {% endif %}
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-video text-amber-500"></i>
                                                <span class="font-medium">Mode:</span> 
                                                {% if appointment.appointmentMode == 'in-person' %}
                                                    Présentiel
                                                {% elseif appointment.appointmentMode == 'video' %}
                                                    Visioconférence
                                                {% elseif appointment.appointmentMode == 'phone' %}
                                                    Téléphone
                                                {% else %}
                                                    {{ appointment.appointmentMode }}
                                                {% endif %}
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                <i class="mr-2 fa-solid fa-location-dot text-amber-500"></i>
                                                <span class="font-medium">Lieu:</span> 
                                                {{ appointment.location }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                            <i class="mr-2 fa-solid fa-notes-medical text-amber-500"></i>
                                            Motif:
                                        </p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                            {{ appointment.reasonForVisit }}
                                        </p>
                                        {% if appointment.symptomsDescription %}
                                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mt-2">
                                                <i class="mr-2 fa-solid fa-thermometer text-amber-500"></i>
                                                Symptômes:
                                            </p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                {{ appointment.symptomsDescription }}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            {# BOUTONS D'ACTION - ACcepTER ET REFUSER #}
                            <div class="flex flex-col gap-2 ml-4">
                                <button 
                                    onclick="acceptAppointment({{ appointment.id }})"
                                    class="px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center min-w-[140px]"
                                >
                                    <i class="mr-2 fa-solid fa-check-circle text-lg"></i>
                                    ✅ Accepter
                                </button>
                                <button 
                                    onclick="rejectAppointment({{ appointment.id }})"
                                    class="px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-red-500 to-red-600 rounded-lg hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center min-w-[140px]"
                                >
                                    <i class="mr-2 fa-solid fa-times-circle text-lg"></i>
                                    ❌ Refuser
                                </button>
                            </div>
                        </div>
                        
                        {# Date de la demande #}
                        <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-xs text-gray-500 dark:text-gray-500">
                                <i class="mr-1 fa-solid fa-clock"></i>
                                Demandé le {{ appointment.createdAt|date('d/m/Y à H:i') }}
                            </span>
                            <span class="text-xs text-amber-600 dark:text-amber-500 font-medium">
                                <i class="mr-1 fa-solid fa-hourglass-half"></i>
                                En attente de validation
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {# Légende #}
            <div class="mt-6 p-4 bg-white dark:bg-gray-900 rounded-lg shadow">
                <div class="flex items-center gap-6 text-sm">
                    <span class="text-gray-600 dark:text-gray-400">
                        <i class="mr-1 fa-solid fa-circle text-green-500"></i>
                        Accepter = Ajoute au planning
                    </span>
                    <span class="text-gray-600 dark:text-gray-400">
                        <i class="mr-1 fa-solid fa-circle text-red-500"></i>
                        Refuser = Demande rejetée
                    </span>
                    <span class="text-gray-600 dark:text-gray-400">
                        <i class="mr-1 fa-solid fa-clock text-amber-500"></i>
                        {{ pendingAppointments|length }} demande(s) en attente
                    </span>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function acceptAppointment(id) {
        if (!confirm('✅ Accepter ce rendez-vous ?\n\nIl sera ajouté à votre planning et le patient sera notifié.')) {
            return;
        }
        
        // Afficher un indicateur de chargement
        const button = event.currentTarget;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="mr-2 fa-solid fa-spinner fa-spin"></i> Acceptation...';
        button.disabled = true;
        
        fetch('/appointment/api/doctor/accept/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur réseau');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Animation de succès
                const element = document.getElementById('appointment-' + id);
                if (element) {
                    element.style.transition = 'all 0.3s ease';
                    element.style.backgroundColor = '#dcfce7';
                    element.style.borderLeftColor = '#22c55e';
                    
                    setTimeout(() => {
                        element.remove();
                        
                        // Afficher un message de succès avec lien vers le planning
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in cursor-pointer';
                        toast.innerHTML = '<i class="mr-2 fa-solid fa-check-circle"></i> Rendez-vous accepté ! <span class="underline ml-2">Aller au planning...</span>';
                        toast.onclick = () => window.location.href = '/doctor/schedule/week';
                        document.body.appendChild(toast);
                        
                        // Redirection automatique après 2 secondes
                        setTimeout(() => {
                            toast.remove();
                            window.location.href = '/doctor/schedule/week';
                        }, 2000);
                        
                        // Recharger si plus de rendez-vous
                        if (document.querySelectorAll('[id^="appointment-"]').length === 0) {
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    }, 300);
                } else {
                    // Si l'élément n'existe pas, rediriger directement vers le planning
                    window.location.href = '/doctor/schedule/week';
                }
            } else {
                alert('❌ Erreur: ' + data.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Erreur lors de l\'acceptation du rendez-vous');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function rejectAppointment(id) {
        const reason = prompt('Veuillez indiquer la raison du refus :', 'Planning non disponible');
        if (reason === null) return;
        
        const button = event.currentTarget;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="mr-2 fa-solid fa-spinner fa-spin"></i> Refus...';
        button.disabled = true;
        
        fetch('/appointment/api/doctor/reject/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ reason: reason || 'Non spécifiée' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const element = document.getElementById('appointment-' + id);
                if (element) {
                    element.style.transition = 'all 0.3s ease';
                    element.style.backgroundColor = '#fee2e2';
                    element.style.borderLeftColor = '#ef4444';
                    
                    setTimeout(() => {
                        element.remove();
                        
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
                        toast.innerHTML = '<i class="mr-2 fa-solid fa-times-circle"></i> Rendez-vous refusé';
                        document.body.appendChild(toast);
                        
                        setTimeout(() => toast.remove(), 3000);
                        
                        if (document.querySelectorAll('[id^="appointment-"]').length === 0) {
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    }, 300);
                }
            } else {
                alert('❌ Erreur: ' + data.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Erreur lors du refus du rendez-vous');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
</script>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .animate-slide-in {
        animation: slideIn 0.3s ease-out;
    }
</style>
{% endblock %}