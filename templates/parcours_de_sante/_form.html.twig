{{ form_start(form, {'attr': {'class': 'space-y-4', 'novalidate': 'novalidate'}}) }}
    <div class="space-y-4">
        <!-- Nom Parcours -->
        <div>
            {{ form_label(form.nomParcours, 'Parcours Name', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
            {{ form_widget(form.nomParcours, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.nomParcours.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200')}}) }}
            {% if form.nomParcours.vars.errors|length > 0 %}
                <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                    {{ form_errors(form.nomParcours) }}
                </div>
            {% endif %}
        </div>

        <!-- Localisation Parcours -->
        <div>
            {{ form_label(form.localisationParcours, 'Location', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
            {{ form_widget(form.localisationParcours, {'attr': {'readonly': true, 'class': 'w-full px-4 py-2.5 border rounded-lg bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.localisationParcours.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200')}}) }}
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Location label is filled from the selected map point.</p>
            {% if form.localisationParcours.vars.errors|length > 0 %}
                <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                    {{ form_errors(form.localisationParcours) }}
                </div>
            {% endif %}
        </div>

        <!-- Map Picker -->
        <div>
            <p class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Pick Location On Map</p>
            <p class="mb-2 text-xs text-gray-500 dark:text-gray-400">Click on the map or drag the marker to set latitude/longitude.</p>
            <div id="parcours-map" class="w-full h-72 rounded-lg border border-gray-200 dark:border-gray-600"></div>
        </div>

        <!-- Latitude / Longitude -->
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
                {{ form_label(form.latitudeParcours, 'Latitude', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
                {{ form_widget(form.latitudeParcours, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.latitudeParcours.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200')}}) }}
                {% if form.latitudeParcours.vars.errors|length > 0 %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                        {{ form_errors(form.latitudeParcours) }}
                    </div>
                {% endif %}
            </div>
            <div>
                {{ form_label(form.longitudeParcours, 'Longitude', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
                {{ form_widget(form.longitudeParcours, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.longitudeParcours.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200')}}) }}
                {% if form.longitudeParcours.vars.errors|length > 0 %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                        {{ form_errors(form.longitudeParcours) }}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Distance Parcours -->
        <div>
            {{ form_label(form.distanceParcours, 'Distance (km)', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
            {{ form_widget(form.distanceParcours, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.distanceParcours.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200'), 'step': '0.1', 'min': '0', 'max': '20'}}) }}
            {% if form.distanceParcours.vars.errors|length > 0 %}
                <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                    {{ form_errors(form.distanceParcours) }}
                </div>
            {% endif %}
        </div>

        <!-- Date Creation -->
        <div>
            {{ form_label(form.dateCreation, 'Creation Date', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
            {{ form_widget(form.dateCreation, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.dateCreation.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200')}}) }}
            {% if form.dateCreation.vars.errors|length > 0 %}
                <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                    {{ form_errors(form.dateCreation) }}
                </div>
            {% endif %}
        </div>

        <!-- Image File -->
        <div>
            {{ form_label(form.imageFile, 'Parcours Image (JPG or PNG)', {'label_attr': {'class': 'block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300'}}) }}
            <p class="mb-2 text-xs text-gray-500 dark:text-gray-400">
                <i class="fa-solid fa-info-circle"></i> Max 10MB, 100x100px minimum, JPG or PNG format
            </p>
            {{ form_widget(form.imageFile, {'attr': {'class': 'w-full px-4 py-2.5 border rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent' ~ (form.imageFile.vars.errors|length > 0 ? ' border-red-500' : ' border-gray-200'), 'accept': 'image/jpeg,image/png'}}) }}
            {% if form.imageFile.vars.errors|length > 0 %}
                <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
                    {{ form_errors(form.imageFile) }}
                </div>
            {% endif %}
        </div>
    </div>

    <div class="flex items-center gap-2">
        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-wellcare-500 rounded-lg hover:bg-wellcare-600">{{ button_label|default('Save') }}</button>
        <a href="{{ path('app_parcours_de_sante_index') }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">Cancel</a>
    </div>
{{ form_end(form) }}

<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
>
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>
<script>
    (() => {
        const mapElement = document.getElementById('parcours-map');
        if (!mapElement || mapElement.dataset.initialized === '1' || typeof L === 'undefined') {
            return;
        }
        mapElement.dataset.initialized = '1';

        const locationInput = document.getElementById('{{ form.localisationParcours.vars.id }}');
        const latitudeInput = document.getElementById('{{ form.latitudeParcours.vars.id }}');
        const longitudeInput = document.getElementById('{{ form.longitudeParcours.vars.id }}');
        if (!latitudeInput || !longitudeInput) {
            return;
        }

        const parsedLatitude = Number.parseFloat(latitudeInput.value);
        const parsedLongitude = Number.parseFloat(longitudeInput.value);
        const hasSavedCoordinates = Number.isFinite(parsedLatitude) && Number.isFinite(parsedLongitude);

        const defaultLatitude = 36.8065;
        const defaultLongitude = 10.1815;
        const initialLatitude = hasSavedCoordinates ? parsedLatitude : defaultLatitude;
        const initialLongitude = hasSavedCoordinates ? parsedLongitude : defaultLongitude;
        const initialZoom = hasSavedCoordinates ? 13 : 6;

        const map = L.map(mapElement).setView([initialLatitude, initialLongitude], initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);

        const marker = L.marker([initialLatitude, initialLongitude], { draggable: true }).addTo(map);

        const updateLocationLabel = async (lat, lng) => {
            if (!locationInput) {
                return;
            }

            const endpoint = new URL('https://nominatim.openstreetmap.org/reverse');
            endpoint.searchParams.set('format', 'jsonv2');
            endpoint.searchParams.set('lat', String(lat));
            endpoint.searchParams.set('lon', String(lng));

            try {
                const response = await fetch(endpoint.toString(), {
                    headers: {
                        Accept: 'application/json',
                    },
                });
                if (!response.ok) {
                    throw new Error('Reverse geocoding failed');
                }

                const payload = await response.json();
                const displayName = (payload.display_name ?? '').trim();
                locationInput.value = displayName !== '' ? displayName.slice(0, 255) : 'Selected map point';
            } catch (error) {
                if ((locationInput.value ?? '').trim() === '') {
                    locationInput.value = 'Selected map point';
                }
            }
        };

        const updateCoordinates = (lat, lng) => {
            const normalizedLat = Number(lat);
            const normalizedLng = Number(lng);

            latitudeInput.value = normalizedLat.toFixed(6);
            longitudeInput.value = normalizedLng.toFixed(6);
            marker.setLatLng([normalizedLat, normalizedLng]);

            updateLocationLabel(normalizedLat, normalizedLng);
        };

        map.on('click', (event) => {
            updateCoordinates(event.latlng.lat, event.latlng.lng);
        });

        marker.on('dragend', () => {
            const markerPosition = marker.getLatLng();
            updateCoordinates(markerPosition.lat, markerPosition.lng);
        });

        if (!hasSavedCoordinates) {
            updateCoordinates(initialLatitude, initialLongitude);
        }
    })();
</script>
