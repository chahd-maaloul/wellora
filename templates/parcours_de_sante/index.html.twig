{% extends 'layouts/app.html.twig' %}

{% block title %}Discover Parcours de Santé - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('trail-css') }}
    <style>
        .distance-range input[type="range"] {
            position: absolute;
            width: 100%;
            height: 2rem;
            margin: 0;
            padding: 0;
            pointer-events: none;
            background: transparent;
            appearance: none;
            -webkit-appearance: none;
        }

        .distance-range input[type="range"]::-webkit-slider-thumb {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #2563eb;
            border-radius: 9999px;
            background: #2563eb;
            box-shadow: 0 0 0 3px #ffffff;
            pointer-events: auto;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .distance-range input[type="range"]::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #2563eb;
            border-radius: 9999px;
            background: #2563eb;
            box-shadow: 0 0 0 3px #ffffff;
            pointer-events: auto;
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block body %}
<!-- Page Header -->
<div class="py-4 mb-4 -mx-4 -mt-4 bg-wellcare-dark-500">
    <div class="px-4 mx-auto">
        <h1 class="mb-1 text-xl font-bold text-white font-display">
            <i class="mr-2 fa-solid fa-route"></i>Discover Parcours de Santé
        </h1>
        <p class="text-sm text-white/80">Find the perfect health-focused route for your wellness journey</p>
    </div>
</div>

<!-- Main Content -->
<div class="px-4 mx-auto" x-data="parcoursDiscovery()">
    <div class="flex flex-col gap-4 lg:flex-row">
        <!-- Filters Sidebar -->
        <div class="flex-shrink-0 lg:w-72">
            <div class="sticky bg-white border border-gray-100 shadow-sm dark:bg-gray-800 rounded-xl dark:border-gray-700 top-4">
                <div class="flex items-center p-3 border-b border-gray-100 dark:border-gray-700">
                    <h2 class="text-sm font-semibold text-gray-900 dark:text-white">
                        <i class="mr-2 fa-solid fa-filter text-wellcare-500"></i>Filters
                    </h2>
                </div>

                <!-- Search -->
                <div class="p-3 border-b border-gray-100 dark:border-gray-700">
                    <form method="get" action="{{ path('app_parcours_de_sante_index') }}" class="space-y-2">
                        <label for="nomParcours" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Parcours Name</label>
                        <input
                            id="nomParcours"
                            type="text"
                            name="nomParcours"
                            value="{{ nomParcours|default('') }}"
                            placeholder="Search by name..."
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent"
                        >

                        <label for="localisation" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Location</label>
                        <input
                            id="localisation"
                            type="text"
                            name="localisation"
                            value="{{ localisation|default('') }}"
                            placeholder="Search by location..."
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent"
                        >

                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Distance (km)</label>
                        <div
                            x-data="distanceRangeFilter({{ minDistance is not null ? minDistance : 0 }}, {{ maxDistance is not null ? maxDistance : 20 }})"
                            class="space-y-2"
                        >
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span x-text="displayKm(minValue)"></span>
                                <span x-text="displayKm(maxValue)"></span>
                            </div>

                            <div class="distance-range relative h-8">
                                <div class="absolute top-1/2 h-2 w-full -translate-y-1/2 rounded-full border border-[#00A790] bg-transparent"></div>
                                <div
                                    class="absolute top-1/2 h-2 -translate-y-1/2 rounded-full bg-[#00A790]"
                                    :style="`left: ${minPercent}%; right: ${100 - maxPercent}%;`"
                                ></div>

                                <input
                                    type="range"
                                    min="0"
                                    max="20"
                                    step="1"
                                    x-model.number="minValue"
                                    @input="onMinInput"
                                    aria-label="Minimum distance"
                                >
                                <input
                                    type="range"
                                    min="0"
                                    max="20"
                                    step="1"
                                    x-model.number="maxValue"
                                    @input="onMaxInput"
                                    aria-label="Maximum distance"
                                >
                            </div>

                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <span>0 km</span>
                                <span>20 km</span>
                            </div>

                            <input type="hidden" id="minDistance" name="minDistance" :value="minValue">
                            <input type="hidden" id="maxDistance" name="maxDistance" :value="maxValue">
                        </div>

                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Number of Publications</label>
                        <div
                            x-data="publicationRangeFilter({{ minPublicationCount is not null ? minPublicationCount : 0 }}, {{ maxPublicationCount is not null ? maxPublicationCount : 200 }})"
                            class="space-y-2"
                        >
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span x-text="displayCount(minValue)"></span>
                                <span x-text="displayCount(maxValue)"></span>
                            </div>

                            <div class="distance-range relative h-8">
                                <div class="absolute top-1/2 h-2 w-full -translate-y-1/2 rounded-full border border-[#00A790] bg-transparent"></div>
                                <div
                                    class="absolute top-1/2 h-2 -translate-y-1/2 rounded-full bg-[#00A790]"
                                    :style="`left: ${minPercent}%; right: ${100 - maxPercent}%;`"
                                ></div>

                                <input
                                    type="range"
                                    min="0"
                                    max="200"
                                    step="1"
                                    x-model.number="minValue"
                                    @input="onMinInput"
                                    aria-label="Minimum number of publications"
                                >
                                <input
                                    type="range"
                                    min="0"
                                    max="200"
                                    step="1"
                                    x-model.number="maxValue"
                                    @input="onMaxInput"
                                    aria-label="Maximum number of publications"
                                >
                            </div>

                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <span>0</span>
                                <span>200</span>
                            </div>

                            <input type="hidden" id="minPublicationCount" name="minPublicationCount" :value="minValue">
                            <input type="hidden" id="maxPublicationCount" name="maxPublicationCount" :value="maxValue">
                        </div>

                        <div class="flex gap-2 pt-1">
                            <button type="submit" class="flex-1 px-3 py-2 text-xs font-medium text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                                Search
                            </button>
                            <a href="{{ path('app_parcours_de_sante_index') }}" class="inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50" title="Refresh filters" aria-label="Refresh filters">
                                <i class="fa-solid fa-rotate-right"></i>
                            </a>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1">
            <!-- View Toggle & Results Count -->
            <div class="flex flex-col gap-3 mb-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-semibold text-gray-900 dark:text-white">{{ parcours_de_santes|length }}</span> parcours available
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex p-1 bg-gray-100 rounded-lg dark:bg-gray-800">
                        <button @click="viewMode = 'grid'" 
                            class="p-1.5 rounded-md transition"
                            :class="viewMode === 'grid' ? 'bg-white dark:bg-gray-700 shadow-sm text-wellcare-500' : 'text-gray-500 hover:text-gray-700'">
                            <i class="fa-solid fa-grid-2"></i>
                        </button>
                        <button @click="viewMode = 'list'" 
                            class="p-1.5 rounded-md transition"
                            :class="viewMode === 'list' ? 'bg-white dark:bg-gray-700 shadow-sm text-wellcare-500' : 'text-gray-500 hover:text-gray-700'">
                            <i class="fa-solid fa-list"></i>
                        </button>
                    </div>
                    <form method="get" action="{{ path('app_parcours_de_sante_index') }}" class="flex items-center gap-2">
                        <input type="hidden" name="nomParcours" value="{{ nomParcours|default('') }}">
                        <input type="hidden" name="localisation" value="{{ localisation|default('') }}">
                        <input type="hidden" name="minDistance" value="{{ minDistance is not null ? minDistance : '' }}">
                        <input type="hidden" name="maxDistance" value="{{ maxDistance is not null ? maxDistance : '' }}">
                        <input type="hidden" name="minPublicationCount" value="{{ minPublicationCount is not null ? minPublicationCount : '' }}">
                        <input type="hidden" name="maxPublicationCount" value="{{ maxPublicationCount is not null ? maxPublicationCount : '' }}">

                        <select
                            name="sortBy"
                            onchange="this.form.submit()"
                            class="py-1.5 px-3 text-sm border border-gray-200 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white"
                        >
                            <option value="date" {{ sortBy == 'date' ? 'selected' : '' }}>Creation Date</option>
                            <option value="name" {{ sortBy == 'name' ? 'selected' : '' }}>Name</option>
                            <option value="distance" {{ sortBy == 'distance' ? 'selected' : '' }}>Distance</option>
                        </select>

                        <input type="hidden" name="sortOrder" id="sortOrderInput" value="{{ sortOrder }}">
                        <div class="inline-flex overflow-hidden border border-gray-200 rounded-lg dark:border-gray-600">
                            <button
                                type="button"
                                title="Sort ascending"
                                aria-label="Sort ascending"
                                onclick="document.getElementById('sortOrderInput').value='ASC'; this.form.submit();"
                                class="px-3 py-1.5 text-sm transition {{ sortOrder == 'ASC' ? 'bg-wellcare-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600' }}"
                            >
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button
                                type="button"
                                title="Sort descending"
                                aria-label="Sort descending"
                                onclick="document.getElementById('sortOrderInput').value='DESC'; this.form.submit();"
                                class="px-3 py-1.5 text-sm transition border-l border-gray-200 dark:border-gray-600 {{ sortOrder == 'DESC' ? 'bg-wellcare-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600' }}"
                            >
                                <i class="fa-solid fa-arrow-down"></i>
                            </button>
                        </div>
                        <a href="{{ path('app_parcours_de_sante_new') }}" class="inline-flex items-center justify-center w-10 h-10 text-white rounded-lg bg-wellcare-500 hover:bg-wellcare-600" title="Add parcours" aria-label="Add parcours">
                            <i class="fa-solid fa-plus"></i>
                        </a>
                    </form>
                </div>
            </div>

            <!-- Grid View -->
            <div x-show="viewMode === 'grid'" class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
                {% for parcours in parcours_de_santes %}
                <div class="overflow-hidden transition bg-white border border-gray-100 shadow-sm cursor-pointer dark:bg-gray-800 rounded-xl dark:border-gray-700 hover:shadow-md" onclick="window.location.href='{{ path('app_parcours_de_sante_show', {'id': parcours.id}) }}'">
                    <div class="relative h-36 bg-gray-200 dark:bg-gray-700">
                        <img src="{{ parcours.imageParcours|default('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=200&fit=crop') }}" alt="{{ parcours.nomParcours }}" class="object-cover w-full h-full">
                        <div class="absolute flex items-center gap-2 top-2 right-2">
                            <a href="{{ path('app_parcours_de_sante_edit', {'id': parcours.id}) }}" onclick="event.stopPropagation();" class="flex items-center justify-center w-8 h-8 transition rounded-full bg-white/90 hover:bg-white">
                                <i class="text-blue-500 fa-solid fa-pen-to-square"></i>
                            </a>
                            <form method="post" action="{{ path('app_parcours_de_sante_delete', {'id': parcours.id}) }}" onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete this parcours?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ parcours.id) }}">
                                <button type="submit" onclick="event.stopPropagation();" class="flex items-center justify-center w-8 h-8 transition rounded-full bg-white/90 hover:bg-white">
                                    <i class="text-red-500 fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="mb-1 font-semibold text-gray-900 dark:text-white">{{ parcours.nomParcours }}</h3>
                        <p class="mb-2 text-xs text-gray-500"><i class="mr-1 fa-solid fa-location-dot"></i>{{ parcours.localisationParcours }}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span><i class="mr-1 fa-solid fa-ruler"></i>{{ parcours.distanceParcours }} km</span>
                                <span title="Publications"><i class="mr-1 fa-solid fa-newspaper"></i>{{ parcours.publicationParcours|length }}</span>
                            </div>
                            <div class="text-xs text-gray-500">{{ parcours.dateCreation|date('M d, Y') }}</div>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-3">
                            <a href="{{ path('app_parcours_de_sante_show', {'id': parcours.id}) }}" onclick="event.stopPropagation();" class="inline-flex items-center justify-center w-7 h-7 text-xs text-white rounded bg-wellcare-500 hover:bg-wellcare-600" title="Details" aria-label="Details">
                                <i class="fa-solid fa-circle-info"></i>
                            </a>
                            <a href="{{ path('app_publication_parcours_index', {'parcoursId': parcours.id}) }}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='{{ path('app_publication_parcours_index', {'parcoursId': parcours.id}) }}';" class="inline-flex items-center justify-center w-7 h-7 text-xs text-white bg-blue-500 rounded hover:bg-blue-600" title="View publications" aria-label="View publications">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="col-span-full text-center text-gray-500">No parcours found. <a href="{{ path('app_parcours_de_sante_new') }}" class="text-wellcare-500 hover:underline">Create one now</a>.</p>
                {% endfor %}
            </div>

            <!-- List View -->
            <div x-show="viewMode === 'list'" class="space-y-2">
                {% for parcours in parcours_de_santes %}
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-lg dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="window.location.href='{{ path('app_parcours_de_sante_show', {'id': parcours.id}) }}'">
                    <img src="{{ parcours.imageParcours|default('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=60&h=60&fit=crop') }}" alt="{{ parcours.nomParcours }}" class="w-12 h-12 rounded-lg object-cover">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 dark:text-white">{{ parcours.nomParcours }}</h3>
                        <p class="text-xs text-gray-500"><i class="mr-1 fa-solid fa-location-dot"></i>{{ parcours.localisationParcours }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ parcours.distanceParcours }} km</p>
                        <p class="text-xs text-gray-500"><i class="mr-1 fa-solid fa-newspaper"></i>{{ parcours.publicationParcours|length }}</p>
                        <p class="text-xs text-gray-500">{{ parcours.dateCreation|date('M d, Y') }}</p>
                    </div>
                    <a href="{{ path('app_publication_parcours_index', {'parcoursId': parcours.id}) }}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='{{ path('app_publication_parcours_index', {'parcoursId': parcours.id}) }}';" class="inline-flex items-center justify-center w-8 h-8 text-white bg-blue-500 rounded hover:bg-blue-600" title="View publications" aria-label="View publications">
                        <i class="fa-solid fa-eye"></i>
                    </a>
                    <a href="{{ path('app_parcours_de_sante_edit', {'id': parcours.id}) }}" onclick="event.stopPropagation();" class="text-gray-400 hover:text-wellcare-500">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                </div>
                {% else %}
                <p class="text-center text-gray-500">No parcours found. <a href="{{ path('app_parcours_de_sante_new') }}" class="text-wellcare-500 hover:underline">Create one now</a>.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function distanceRangeFilter(initialMin, initialMax) {
    const minBound = 0;
    const maxBound = 20;

    const normalizedMin = Number.isFinite(initialMin) ? Math.max(minBound, Math.min(initialMin, maxBound)) : minBound;
    const normalizedMax = Number.isFinite(initialMax) ? Math.max(minBound, Math.min(initialMax, maxBound)) : maxBound;

    return {
        minValue: Math.min(normalizedMin, normalizedMax),
        maxValue: Math.max(normalizedMin, normalizedMax),
        get minPercent() {
            return ((this.minValue - minBound) / (maxBound - minBound)) * 100;
        },
        get maxPercent() {
            return ((this.maxValue - minBound) / (maxBound - minBound)) * 100;
        },
        onMinInput() {
            if (this.minValue > this.maxValue) {
                this.minValue = this.maxValue;
            }
        },
        onMaxInput() {
            if (this.maxValue < this.minValue) {
                this.maxValue = this.minValue;
            }
        },
        displayKm(value) {
            return `${Math.round(value)} km`;
        }
    };
}

function publicationRangeFilter(initialMin, initialMax) {
    const minBound = 0;
    const maxBound = 200;

    const normalizedMin = Number.isFinite(initialMin) ? Math.max(minBound, Math.min(initialMin, maxBound)) : minBound;
    const normalizedMax = Number.isFinite(initialMax) ? Math.max(minBound, Math.min(initialMax, maxBound)) : maxBound;

    return {
        minValue: Math.min(normalizedMin, normalizedMax),
        maxValue: Math.max(normalizedMin, normalizedMax),
        get minPercent() {
            return ((this.minValue - minBound) / (maxBound - minBound)) * 100;
        },
        get maxPercent() {
            return ((this.maxValue - minBound) / (maxBound - minBound)) * 100;
        },
        onMinInput() {
            if (this.minValue > this.maxValue) {
                this.minValue = this.maxValue;
            }
        },
        onMaxInput() {
            if (this.maxValue < this.minValue) {
                this.maxValue = this.minValue;
            }
        },
        displayCount(value) {
            return `${Math.round(value)}`;
        }
    };
}

function parcoursDiscovery() {
    return {
        viewMode: 'grid',
        sortBy: 'recent',
        filters: {
            search: '',
            distance: [0, 20]
        },
        resetFilters() {
            this.filters = {
                search: '',
                distance: [0, 20]
            };
        }
    }
}

</script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}
