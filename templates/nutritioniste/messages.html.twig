{% extends 'base.html.twig' %}

{% block title %}Messages - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/nutrition-css.css') }}">
{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900{% endblock %}

{% block body %}
<div class="min-h-screen py-8">
    <div class="px-4 mx-auto max-w-7xl">
        {# Header #}
        <div class="flex flex-col gap-4 mb-8 lg:flex-row lg:items-center lg:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Messages</h1>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Échangez avec vos patients</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="{{ path('nutrisioniste_dashboard') }}" class="px-4 py-2 font-medium transition-colors rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                    <i class="mr-2 fas fa-arrow-left"></i>Retour au tableau de bord
                </a>
            </div>
        </div>

        {# Stats Cards #}
        {% if stats is defined %}
        <div class="grid grid-cols-1 gap-4 mb-8 md:grid-cols-4">
            <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-wellcare-100 dark:bg-wellcare-900/30">
                        <i class="text-wellcare-500 fas fa-envelope"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total }}</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30">
                        <i class="text-blue-500 fas fa-envelope-open"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Non lus</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.unread }}</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30">
                        <i class="text-red-500 fas fa-exclamation-circle"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Urgents</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.urgent }}</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30">
                        <i class="text-green-500 fas fa-check-circle"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Respondus</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total - stats.unread }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Filter Tabs #}
        <div class="flex flex-wrap gap-2 mb-6">
            <a href="{{ path('nutrisioniste_messages', {filter: 'all'}) }}" 
               class="px-4 py-2 transition-colors rounded-lg {{ (filter is not defined or filter == 'all') ? 'bg-wellcare-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700' }}">
                <i class="mr-2 fas fa-inbox"></i>Tous
            </a>
            <a href="{{ path('nutrisioniste_messages', {filter: 'unread'}) }}" 
               class="px-4 py-2 transition-colors rounded-lg {{ filter == 'unread' ? 'bg-wellcare-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700' }}">
                <i class="mr-2 fas fa-envelope-open"></i>Non lus
                {% if stats is defined and stats.unread > 0 %}
                <span class="ml-2 px-2 py-0.5 rounded-full bg-red-500 text-white text-xs">{{ stats.unread }}</span>
                {% endif %}
            </a>
            <a href="{{ path('nutrisioniste_messages', {filter: 'urgent'}) }}" 
               class="px-4 py-2 transition-colors rounded-lg {{ filter == 'urgent' ? 'bg-wellcare-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700' }}">
                <i class="mr-2 fas fa-exclamation-circle"></i>Urgents
                {% if stats is defined and stats.urgent > 0 %}
                <span class="ml-2 px-2 py-0.5 rounded-full bg-red-500 text-white text-xs">{{ stats.urgent }}</span>
                {% endif %}
            </a>
        </div>

        {# Messages Grid #}
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
            {# Conversations List #}
            <div class="overflow-hidden bg-white shadow-lg lg:col-span-1 dark:bg-gray-800 rounded-2xl">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <form method="get" action="{{ path('nutrisioniste_messages') }}" class="relative">
                        <input type="text" name="search" value="{{ search|default('') }}" placeholder="Rechercher un patient..."
                               class="w-full py-2 pl-10 pr-4 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent">
                        <i class="absolute text-gray-400 transform -translate-y-1/2 fas fa-search left-3 top-1/2"></i>
                    </form>
                </div>
                <div class="overflow-y-auto divide-y divide-gray-100 dark:divide-gray-700 max-h-[600px]">
                    {% if conversations is defined and conversations|length > 0 %}
                        {% for conversation in conversations %}
                            <a href="{{ path('nutrisioniste_message_view', {id: conversation.id}) }}" 
                               class="p-4 transition-colors cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 {{ conversation.unread ? 'bg-wellcare-50 dark:bg-wellcare-900/20' : '' }}">
                                <div class="flex items-start gap-3">
                                    <div class="flex items-center justify-center flex-shrink-0 w-12 h-12 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                        <span class="text-sm font-semibold text-wellcare-600 dark:text-wellcare-400">{{ conversation.avatar }}</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between gap-2">
                                            <h4 class="font-semibold text-gray-900 dark:text-white truncate">
                                                {{ conversation.patientName }}
                                            </h4>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ conversation.time }}</span>
                                        </div>
                                        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400 truncate">
                                            {{ conversation.lastMessage }}
                                        </p>
                                        <div class="flex items-center gap-2 mt-2">
                                            {% if conversation.unread %}
                                                <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-wellcare-100 text-wellcare-700 dark:bg-wellcare-900/30 dark:text-wellcare-400">
                                                    Nouveau
                                                </span>
                                            {% endif %}
                                            {% if conversation.urgent %}
                                                <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                                                    <i class="mr-1 fas fa-exclamation-circle"></i>Urgent
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="p-8 text-center">
                            <i class="text-4xl text-gray-300 dark:text-gray-600 fas fa-envelope-open"></i>
                            <p class="mt-4 text-gray-500 dark:text-gray-400">Aucune conversation</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Message Detail #}
            <div class="lg:col-span-3">
                <div class="overflow-hidden bg-white shadow-lg dark:bg-gray-800 rounded-2xl h-full">
                    {% if selectedConversation is defined %}
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                    <span class="text-sm font-semibold text-wellcare-600 dark:text-wellcare-400">{{ selectedConversation.patient.avatar }}</span>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900 dark:text-white">{{ selectedConversation.patient.name }}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Patient #{{ selectedConversation.patientId }}</p>
                                </div>
                                <a href="{{ path('nutrisioniste_patient_detail', {id: selectedConversation.patientId}) }}" 
                                   class="px-3 py-2 text-sm font-medium text-wellcare-600 bg-wellcare-50 rounded-lg dark:bg-wellcare-900/30 dark:text-wellcare-400 hover:bg-wellcare-100 dark:hover:bg-wellcare-900/50">
                                    <i class="mr-1 fas fa-user"></i>Voir profil
                                </a>
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto p-4 space-y-4 max-h-[400px]" style="height: 400px;">
                            {% for message in selectedConversation.messages %}
                                <div class="flex {{ message.sender == 'nutritionist' ? 'justify-end' : 'justify-start' }}">
                                    <div class="max-w-[70%] {{ message.sender == 'nutritionist' ? 'bg-wellcare-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white' }} rounded-2xl px-4 py-2">
                                        <p>{{ message.text }}</p>
                                        <p class="text-xs mt-1 opacity-70">{{ message.time }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <form method="post" action="{{ path('nutrisioniste_message_send', {id: selectedConversation.id}) }}" class="p-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex gap-2">
                                <input type="text" name="message" required placeholder="Tapez votre message..." 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-wellcare-500 focus:border-transparent">
                                <button type="submit" class="px-6 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                                    <i class="mr-2 fas fa-paper-plane"></i>Envoyer
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="flex flex-col items-center justify-center h-full p-8">
                            <i class="text-6xl text-gray-300 dark:text-gray-600 fas fa-comments"></i>
                            <h3 class="mt-4 text-xl font-semibold text-gray-900 dark:text-white">Sélectionnez une conversation</h3>
                            <p class="mt-2 text-gray-500 dark:text-gray-400">Choisissez une conversation dans la liste pour voir les messages</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Link back to patient messages #}
        <div class="mt-8 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
            <div class="flex items-center gap-3">
                <i class="text-blue-500 fas fa-info-circle"></i>
                <p class="text-sm text-blue-700 dark:text-blue-300">
                    <strong>Lien avec les patients:</strong> Les patients peuvent vous envoyer des messages via 
                    <a href="{{ path('nutrition_messages', {nutritionistId: 1}) }}" class="underline hover:text-blue-900">la page Messages du patient</a>.
                    <br>
                    <a href="{{ path('nutrition_dashboard') }}" class="inline-flex items-center mt-2 px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 dark:bg-blue-800 dark:text-blue-300 dark:hover:bg-blue-700">
                        <i class="mr-1 fas fa-arrow-left"></i>Retour au tableau de bord nutrition patient
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
