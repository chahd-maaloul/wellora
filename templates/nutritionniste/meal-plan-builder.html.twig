{% extends 'layouts/app.html.twig' %}

{% block title %}Création de plan nutritionnel - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/nutrition-css.css') }}">
{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900{% endblock %}

{% block body %}
<div class="min-h-screen py-8" x-data="mealPlanBuilder()" x-init="init()">
    <div class="px-4 mx-auto max-w-7xl">
        {# Header #}
        <div class="flex flex-col gap-4 mb-8 lg:flex-row lg:items-center lg:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Création de plan nutritionnel</h1>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Créez des plans personnalisés pour vos patients</p>
            </div>
            <div class="flex items-center gap-3">
                <button @click="savePlan()" class="px-4 py-2 text-gray-700 transition-colors border border-gray-300 rounded-lg dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="mr-2 fas fa-save"></i>Enregistrer
                </button>
                <button @click="previewPlan()" class="px-4 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                    <i class="mr-2 fas fa-eye"></i>Aperçu
                </button>
            </div>
        </div>

        {# Patient Selection #}
        <div class="p-6 mb-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
            <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white">Patient</h2>
            <div class="flex flex-col gap-4 md:flex-row">
                <div class="flex-1">
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Sélectionner un patient</label>
                    <select x-model="selectedPatientId" class="w-full px-4 py-3 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        <option value="">Choisir un patient...</option>
                        <template x-for="patient in patients" :key="patient.id">
                            <option :value="patient.id" x-text="patient.name + ' - ' + patient.goal"></option>
                        </template>
                    </select>
                </div>
                <div x-show="selectedPatient" class="flex-1 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                            <span class="text-lg font-medium text-wellcare-500" x-text="selectedPatient.initials"></span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-white" x-text="selectedPatient.name"></h3>
                            <p class="text-sm text-gray-500" x-text="'Objectif: ' + selectedPatient.goal"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Plan Settings #}
        <div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-3">
            {# Plan Type #}
            <div class="p-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white">Type de plan</h2>
                <div class="space-y-3">
                    <template x-for="planType in planTypes" :key="planType.id">
                        <label class="flex items-center gap-3 p-3 transition-colors cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50"
                               :class="{'bg-wellcare-50 dark:bg-wellcare-900/20': selectedPlanType === planType.id}">
                            <input type="radio" :value="planType.id" x-model="selectedPlanType" class="w-4 h-4 text-wellcare-500">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white" x-text="planType.name"></p>
                                <p class="text-sm text-gray-500" x-text="planType.description"></p>
                            </div>
                        </label>
                    </template>
                </div>
            </div>

            {# Duration & Frequency #}
            <div class="p-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white">Durée & Fréquence</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Durée du plan</label>
                        <select x-model="planDuration" class="w-full px-4 py-3 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="1">1 semaine</option>
                            <option value="2">2 semaines</option>
                            <option value="4">1 mois</option>
                            <option value="12">3 mois</option>
                            <option value="24">6 mois</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Calories quotidiennes</label>
                        <input type="number" x-model="dailyCalories" class="w-full px-4 py-3 border border-gray-300 rounded-xl dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Répartition des macros</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-500">Protéines</label>
                                <input type="number" x-model="macroSplit.protein" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Glucides</label>
                                <input type="number" x-model="macroSplit.carbs" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Lipides</label>
                                <input type="number" x-model="macroSplit.fats" class="w-full px-3 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Templates #}
            <div class="p-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
                <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white">Modèles prédéfinis</h2>
                <div class="space-y-3">
                    <template x-for="template in templates" :key="template.id">
                        <button @click="applyTemplate(template)" 
                                class="w-full p-4 text-left transition-colors border border-gray-200 rounded-xl dark:border-gray-700 hover:border-wellcare-500 hover:bg-wellcare-50 dark:hover:bg-wellcare-900/20">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium text-gray-900 dark:text-white" x-text="template.name"></h3>
                                <span class="text-xs text-wellcare-500" x-text="template.calories + ' kcal'"></span>
                            </div>
                            <p class="text-sm text-gray-500" x-text="template.description"></p>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        {# Weekly Meal Plan #}
        <div class="p-6 mb-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Plan alimentaire hebdomadaire</h2>
                <div class="flex items-center gap-2">
                    <button @click="clearPlan()" class="px-3 py-1 text-sm text-red-500 transition-colors rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                        <i class="mr-1 fas fa-trash"></i>Tout effacer
                    </button>
                </div>
            </div>

            {# Days Tabs #}
            <div class="flex gap-2 pb-2 mb-6 overflow-x-auto">
                <template x-for="(day, index) in weekDays" :key="index">
                    <button @click="selectedDay = index"
                            class="px-4 py-2 transition-colors rounded-lg whitespace-nowrap"
                            :class="selectedDay === index ? 'bg-wellcare-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                        <span x-text="day"></span>
                    </button>
                </template>
            </div>

            {# Day Meals #}
            <div class="space-y-6">
                {# Meal Types #}
                <template x-for="mealType in mealTypes" :key="mealType.id">
                    <div class="overflow-hidden border border-gray-200 dark:border-gray-700 rounded-xl">
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center justify-center w-10 h-10 rounded-lg" :class="mealType.iconBg">
                                    <i :class="mealType.icon + ' ' + mealType.iconColor"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white" x-text="mealType.name"></h3>
                                    <p class="text-sm text-gray-500" x-text="mealType.calories + ' kcal recommandées'"></p>
                                </div>
                            </div>
                            <button @click="addMeal(mealType.id)" class="px-3 py-1 text-sm text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                                <i class="mr-1 fas fa-plus"></i>Ajouter
                            </button>
                        </div>
                        <div class="p-4 space-y-3">
                            <template x-for="(meal, mealIndex) in getMealsForDay(selectedDay, mealType.id)" :key="mealIndex">
                                <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 dark:text-white" x-text="meal.name"></p>
                                        <p class="text-sm text-gray-500" x-text="meal.calories + ' kcal • ' + meal.protein + 'g prot • ' + meal.carbs + 'g gluc • ' + meal.fats + 'g lip'"></p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click="editMeal(meal)" class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="removeMeal(selectedDay, mealType.id, mealIndex)" class="p-2 text-gray-400 transition-colors hover:text-red-500">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="getMealsForDay(selectedDay, mealType.id).length === 0" class="py-4 text-center text-gray-400">
                                <i class="mb-2 text-2xl fas fa-utensils"></i>
                                <p>Aucun repas prévu</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            {# Daily Summary #}
            <div class="p-4 mt-6 bg-wellcare-50 dark:bg-wellcare-900/20 rounded-xl">
                <h3 class="mb-3 font-semibold text-gray-900 dark:text-white">Résumé nutritionnel - <span x-text="weekDays[selectedDay]"></span></h3>
                <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-wellcare-500" x-text="dailySummary.calories + ' kcal'"></p>
                        <p class="text-sm text-gray-500">Calories</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-500" x-text="dailySummary.protein + 'g'"></p>
                        <p class="text-sm text-gray-500">Protéines</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-amber-500" x-text="dailySummary.carbs + 'g'"></p>
                        <p class="text-sm text-gray-500">Glucides</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-red-500" x-text="dailySummary.fats + 'g'"></p>
                        <p class="text-sm text-gray-500">Lipides</p>
                    </div>
                </div>
            </div>
        </div>

        {# Recipe Library Sidebar #}
        <div class="p-6 bg-white shadow-lg dark:bg-gray-800 rounded-2xl">
            <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white">Bibliothèque de recettes</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" x-model="recipeSearch" placeholder="Rechercher une recette..."
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                <select x-model="recipeCategory" class="px-4 py-2 border border-gray-300 rounded-lg dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    <option value="">Toutes catégories</option>
                    <option value="breakfast">Petit-déjeuner</option>
                    <option value="lunch">Déjeuner</option>
                    <option value="dinner">Dîner</option>
                    <option value="snack">Collation</option>
                </select>
            </div>
            <div class="grid grid-cols-1 gap-3 overflow-y-auto md:grid-cols-2 lg:grid-cols-3 max-h-96">
                <template x-for="recipe in filteredRecipes" :key="recipe.id">
                    <div class="p-3 transition-colors border border-gray-200 rounded-lg cursor-pointer dark:border-gray-700 hover:border-wellcare-500"
                         @click="addRecipeToMeal(recipe)">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-wellcare-100 dark:bg-wellcare-900/30">
                                <i :class="recipe.icon + ' text-wellcare-500'"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="recipe.name"></p>
                                <p class="text-xs text-gray-500" x-text="recipe.calories + ' kcal'"></p>
                            </div>
                            <button class="p-1 text-wellcare-500">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('build/nutrition.js') }}"></script>
{% endblock %}
