{# templates/chat/coach.html.twig #}
{% extends 'layouts/app.html.twig' %}

{% block title %}{{ pageTitle }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('coach') }}
    <style>
        .chat-messages {
            scroll-behavior: smooth;
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        .message-enter {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .conversation-item.active {
            background-color: rgba(37, 99, 235, 0.1);
            border-left: 3px solid #3b82f6;
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .typing-indicator span {
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        /* Styles pour les toasts */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        
        .dark .toast {
            background: #1f2937;
            color: white;
        }

        .toast-success { border-left-color: #10b981; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-error { border-left-color: #ef4444; }
        
        /* Indicateur de nouveau message */
        .new-message-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('coach') }}
{% endblock %}

{% block body %}
{{ stream_notifications(['/notifications/' ~ app.user.uuid]) }}

<div x-data="coachCommunication()" 
     x-init="init()" 
     data-initial-client="{{ app.request.get('openConversationWith') }}"
     data-initial-conversation="{{ app.request.get('conversation') }}"
     class="min-h-screen bg-gray-50 dark:bg-gray-900">
    
    <!-- Conteneur de toasts -->
    <div class="fixed bottom-4 right-4 z-50 w-80 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-y-2 opacity-0"
                 x-transition:enter-end="translate-y-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border-l-4 p-4"
                 :class="{
                     'border-wellcare-500': !toast.type,
                     'border-green-500': toast.type === 'success',
                     'border-yellow-500': toast.type === 'warning',
                     'border-red-500': toast.type === 'error'
                 }">
                
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 dark:text-white" x-text="toast.title"></h4>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1" x-text="toast.message"></p>
                        <p class="text-xs text-gray-400 mt-1" x-text="toast.time"></p>
                    </div>
                    <button @click="toast.visible = false" class="ml-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm dark:bg-gray-800 dark:border-gray-700">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{{ path('coach_dashboard') }}" class="p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="text-gray-600 fas fa-arrow-left dark:text-gray-400"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="mr-2 fas fa-comments text-wellcare-500"></i>
                            Communication Hub
                        </h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            Stay connected with your clients
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                   

                    <div class="relative">
                        <button @click="showNotifications = !showNotifications" class="relative p-2 text-gray-600 transition-colors rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                            <i class="fas fa-bell"></i>
                            <span x-show="totalUnread > 0" 
                                  x-text="totalUnread"
                                  class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 text-xs text-white bg-red-500 rounded-full"></span>
                        </button>
                        
                        <!-- Panneau de notifications -->
                        <div x-show="showNotifications" 
                             @click.away="showNotifications = false"
                             x-transition
                             class="absolute right-0 z-50 mt-2 bg-white rounded-lg shadow-lg w-80 dark:bg-gray-800">
                            
                            <div class="p-3 font-medium border-b dark:border-gray-700 flex justify-between">
                                <span>Notifications</span>
                                <span x-show="notifications.length > 0" 
                                      class="text-xs text-wellcare-500" 
                                      x-text="notifications.length + ' nouvelle(s)'"></span>
                            </div>
                            
                            <div class="max-h-96 overflow-y-auto">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div @click="if(notif.conversationId) { selectConversation(conversations.find(c => c.id === notif.conversationId)); } showNotifications = false; notif.read = true" 
                                         class="p-3 border-b cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-700"
                                         :class="{'bg-wellcare-50 dark:bg-wellcare-900/20': !notif.read}">
                                        
                                        <div class="flex gap-3">
                                            <div class="flex-shrink-0">
                                                <div class="flex items-center justify-center w-10 h-10 rounded-full"
                                                     :class="notif.read ? 'bg-gray-200 dark:bg-gray-600' : 'bg-wellcare-100 dark:bg-wellcare-900/30'">
                                                    <i class="fas fa-comment" 
                                                       :class="notif.read ? 'text-gray-500' : 'text-wellcare-500'"></i>
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-sm font-medium" 
                                                   :class="notif.read ? 'text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-white'" 
                                                   x-text="notif.title"></p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="notif.message"></p>
                                                <p class="text-xs text-gray-400 mt-1" x-text="notif.time"></p>
                                            </div>
                                            <div x-show="!notif.read" class="w-2 h-2 bg-wellcare-500 rounded-full"></div>
                                        </div>
                                    </div>
                                </template>
                                
                                <template x-if="notifications.length === 0">
                                    <div class="p-4 text-center text-gray-500">
                                        <i class="mb-2 text-4xl fas fa-bell-slash"></i>
                                        <p>Aucune notification</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="p-6">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
            <!-- Conversations List -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-100 shadow-sm rounded-xl dark:bg-gray-800 dark:border-gray-700">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <div class="relative">
                            <i class="absolute left-3 top-3 text-gray-400 fas fa-search"></i>
                            <input 
                                type="text" 
                                x-model="searchQuery"
                                @input="filterConversations()"
                                placeholder="Search conversations..."
                                class="w-full px-4 py-2 pl-10 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500">
                        </div>
                    </div>
                    
                    <div class="divide-y divide-gray-100 dark:divide-gray-700 max-h-[600px] overflow-y-auto">
                        <template x-for="conversation in filteredConversations" :key="conversation.id">
                            <button 
                                @click="selectConversation(conversation)"
                                :class="{
                                    'active': selectedConversation?.id === conversation.id,
                                    'bg-wellcare-50 dark:bg-wellcare-900/20': selectedConversation?.id === conversation.id,
                                    'hover:bg-gray-50 dark:hover:bg-gray-700': true
                                }"
                                class="flex items-center w-full gap-3 p-4 transition-colors">
                                <div class="relative">
                                    <div class="flex items-center justify-center w-12 h-12 rounded-full"
                                         :class="conversation.unread > 0 ? 'ring-2 ring-wellcare-500 new-message-indicator' : 'bg-wellcare-100 dark:bg-wellcare-900/30'">
                                        <span class="font-medium" 
                                              :class="conversation.unread > 0 ? 'text-wellcare-500' : 'text-wellcare-600 dark:text-wellcare-400'"
                                              x-text="conversation.avatar"></span>
                                    </div>
                                    <span x-show="conversation.online" 
                                          class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full dark:border-gray-800"></span>
                                </div>
                                <div class="flex-1 min-w-0 text-left">
                                    <div class="flex items-center justify-between">
                                        <p class="font-medium text-gray-900 truncate dark:text-white" 
                                           :class="{'font-bold': conversation.unread > 0}"
                                           x-text="conversation.client"></p>
                                        <span class="text-xs text-gray-500 dark:text-gray-400" x-text="conversation.time"></span>
                                    </div>
                                    <p class="text-sm text-gray-500 truncate dark:text-gray-400" 
                                       :class="{'font-semibold text-gray-900 dark:text-white': conversation.unread > 0}"
                                       x-text="conversation.lastMessage"></p>
                                    <div x-show="conversation.goalTitle" class="flex items-center gap-1 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-800': conversation.goalStatus === 'completed',
                                                  'bg-blue-100 text-blue-800': conversation.goalStatus === 'in progress',
                                                  'bg-yellow-100 text-yellow-800': conversation.goalStatus === 'PENDING'
                                              }">
                                            <i class="mr-1 fas fa-flag-checkered"></i>
                                            <span x-text="conversation.goalTitle"></span>
                                        </span>
                                    </div>
                                </div>
                                <span x-show="conversation.unread > 0" 
                                      class="flex items-center justify-center w-5 h-5 text-xs text-white rounded-full bg-wellcare-500" 
                                      x-text="conversation.unread"></span>
                            </button>
                        </template>
                        
                        <template x-if="filteredConversations.length === 0">
                            <div class="p-8 text-center text-gray-500">
                                <i class="mb-2 text-4xl fas fa-comment-slash"></i>
                                <p>No conversations found</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="mt-6 bg-white border border-gray-100 shadow-sm rounded-xl dark:bg-gray-800 dark:border-gray-700">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                            <i class="mr-2 fas fa-chart-bar text-wellcare-500"></i>
                            Message Stats
                        </h2>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Unread Messages</span>
                            <span class="font-semibold text-wellcare-500" x-text="totalUnread"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Online Clients</span>
                            <span class="font-semibold text-green-500" x-text="onlineCount"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Total Conversations</span>
                            <span class="font-semibold text-gray-900 dark:text-white" x-text="conversations.length"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-[calc(100vh-200px)] flex flex-col">
                    <!-- Chat Header -->
                    <template x-if="selectedConversation">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                        <span class="font-medium text-wellcare-600 dark:text-wellcare-400" x-text="selectedConversation.avatar"></span>
                                    </div>
                                    <span x-show="selectedConversation.online" 
                                          class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full dark:border-gray-800"></span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900 dark:text-white" x-text="selectedConversation.client"></p>
                                    <div class="flex items-center gap-2">
                                        <p class="text-xs" 
                                           :class="selectedConversation.online ? 'text-green-500' : 'text-gray-400'" 
                                           x-text="selectedConversation.online ? 'Online' : 'Offline'"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span x-show="selectedConversation.goalTitle" 
                                      class="px-3 py-1 text-sm text-wellcare-700 bg-wellcare-100 rounded-full">
                                    <i class="mr-1 fas fa-flag-checkered"></i>
                                    <span x-text="selectedConversation.goalTitle"></span>
                                </span>
                            </div>
                        </div>
                    </template>

                    <!-- Messages Container -->
                    <div id="messages-container" class="flex-1 p-4 space-y-4 overflow-y-auto chat-messages">
                        <template x-if="!selectedConversation">
                            <div class="flex items-center justify-center h-full">
                                <div class="text-center">
                                    <i class="mb-4 text-6xl fas fa-comment-dots text-gray-300 dark:text-gray-600"></i>
                                    <p class="text-gray-500 dark:text-gray-400">Select a conversation to start chatting</p>
                                </div>
                            </div>
                        </template>
                        
                        <template x-if="messages.length === 0 && selectedConversation">
                            <div class="flex items-center justify-center h-full">
                                <p class="text-gray-500 dark:text-gray-400">No messages yet. Start the conversation!</p>
                            </div>
                        </template>
                        
                        <template x-for="(message, index) in messages" :key="message.id">
                            <div>
                                <div x-show="index === 0 || messages[index-1].date !== message.date" 
                                     class="flex items-center justify-center my-4">
                                    <span class="px-3 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-400" 
                                          x-text="message.date === new Date().toISOString().split('T')[0] ? 'Today' : message.date"></span>
                                </div>
                                
                                <div :class="{'flex justify-end': message.sender === 'me', 'flex justify-start': message.sender !== 'me'}" 
                                     class="mb-4 message-enter">
                                    
                                    <template x-if="message.sender !== 'me'">
                                        <div class="flex items-start gap-3 max-w-[70%]">
                                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30 flex-shrink-0">
                                                <span class="text-xs font-medium text-wellcare-600 dark:text-wellcare-400" x-text="selectedConversation?.avatar"></span>
                                            </div>
                                            <div>
                                                <div class="p-3 bg-gray-100 rounded-lg dark:bg-gray-700">
                                                    <p class="text-sm text-gray-900 dark:text-white" x-text="message.content"></p>
                                                </div>
                                                <p class="mt-1 text-xs text-gray-400" x-text="message.time"></p>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <template x-if="message.sender === 'me'">
                                        <div class="flex items-start justify-end gap-3 max-w-[70%] ml-auto">
                                            <div class="text-right">
                                                <div class="p-3 text-white rounded-lg bg-wellcare-500">
                                                    <p class="text-sm" x-text="message.content"></p>
                                                </div>
                                                <p class="mt-1 text-xs text-gray-400" x-text="message.time"></p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Indicateur de frappe -->
                        <div x-show="typingIn[selectedConversation?.id]" class="flex justify-start">
                            <div class="flex items-center gap-2 p-3 bg-gray-100 rounded-lg dark:bg-gray-700">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="text-sm text-gray-500">typing...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <template x-if="selectedConversation">
                        <div class="p-4 border-t border-gray-100 dark:border-gray-700">
                            <form @submit.prevent="sendMessage()" class="flex items-end gap-3">
                                <div class="flex-1">
                                    <textarea 
                                        x-model="newMessage"
                                        @keydown.enter.prevent="sendMessage()"
                                        @input="handleTyping()"
                                        placeholder="Type your message... (Enter to send)"
                                        rows="1"
                                        class="w-full px-4 py-2 text-gray-900 border border-gray-300 resize-none dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500"></textarea>
                                </div>
                                <button type="submit" 
                                        :disabled="!newMessage.trim()"
                                        class="p-3 text-white transition-colors rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                        :class="newMessage.trim() ? 'bg-wellcare-500 hover:bg-wellcare-600' : 'bg-gray-400'">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function coachCommunication() {
    return {
        // Donn√©es
        conversations: {{ conversations|json_encode|raw }},
        filteredConversations: [],
        selectedConversation: null,
        messages: [],
        searchQuery: '',
        newMessage: '',
        showNotifications: false,
        totalUnread: 0,
        onlineCount: 0,
        typingIn: {},
        typingTimeout: null,
        pollingInterval: null,
        messageCheckInterval: null,
        unreadCheckInterval: null,
        notifications: [],
        toasts: [],
        lastMessageIds: {}, // Pour suivre les derniers messages par conversation
        
        // Initialisation
        init() {
            console.log('üöÄ Initialisation du chat coach...');
            this.filteredConversations = this.conversations;
            
            // Initialiser les IDs des derniers messages
            this.conversations.forEach(conv => {
                this.lastMessageIds[conv.id] = null;
            });
            
            this.calculateStats();
            
            // √âcouter les notifications Mercure
            this.setupMercureListener();
            
            // D√©marrer le polling intensif (toutes les 2 secondes)
            this.startPolling();
            
            // V√©rification des messages pour la conversation active
            this.startMessageCheck();
            
            // V√©rification des messages non lus
            this.startUnreadCheck();
            
            // Afficher un toast de bienvenue
            setTimeout(() => {
                this.showToast({
                    title: 'Bienvenue',
                    message: 'Communication Hub est pr√™t',
                    type: 'success'
                });
            }, 1000);
        },
        
        // Configuration de l'√©couteur Mercure
        setupMercureListener() {
            document.addEventListener('mercure:message', (event) => {
                const data = event.detail;
                console.log('üì© Message Mercure re√ßu:', data);
                
                if (data && data.type === 'new_message') {
                    this.handleNewMessage(data);
                }
            });
            
            // Tester la connexion Mercure
            fetch('http://localhost:61619/.well-known/mercure', { mode: 'no-cors' })
                .then(() => console.log('‚úÖ Serveur Mercure accessible'))
                .catch(err => console.log('‚ö†Ô∏è Serveur Mercure inaccessible (mode polling activ√©)'));
        },
        
        // G√©rer un nouveau message
        handleNewMessage(data) {
            const conversationId = data.conversationId;
            const messageContent = data.message?.content || data.notification?.message || 'Message re√ßu';
            const senderName = data.notification?.sender || 'Patient';
            
            // Trouver la conversation
            const conversation = this.conversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            // Mettre √† jour le compteur de messages non lus
            if (!this.selectedConversation || this.selectedConversation.id !== conversationId) {
                conversation.unread = (conversation.unread || 0) + 1;
                
                // Afficher le toast
                this.showToast({
                    title: `Nouveau message de ${conversation.client}`,
                    message: messageContent.substring(0, 100) + (messageContent.length > 100 ? '...' : ''),
                    conversationId: conversationId,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    type: 'info'
                });
                
                // Ajouter √† l'historique
                this.addToHistory({
                    title: `Message de ${conversation.client}`,
                    message: messageContent.substring(0, 100) + (messageContent.length > 100 ? '...' : ''),
                    sender: conversation.client,
                    conversationId: conversationId,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
            }
            
            // Mettre √† jour le dernier message dans la liste
            conversation.lastMessage = messageContent.substring(0, 50) + (messageContent.length > 50 ? '...' : '');
            conversation.time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Recharger les messages si c'est la conversation active
            if (this.selectedConversation && this.selectedConversation.id === conversationId) {
                this.loadMessages(conversationId, true);
            }
            
            this.calculateStats();
            this.filterConversations();
        },
        
        // D√©marrer le polling de secours
        startPolling() {
            // V√©rifier les nouveaux messages toutes les 2 secondes
            this.pollingInterval = setInterval(() => {
                this.checkForNewMessages();
            }, 2000);
        },
        
        // D√©marrer la v√©rification des messages pour la conversation active
        startMessageCheck() {
            this.messageCheckInterval = setInterval(() => {
                if (this.selectedConversation) {
                    this.checkConversationMessages();
                }
            }, 2000);
        },
        
        // D√©marrer la v√©rification des messages non lus
        startUnreadCheck() {
            this.unreadCheckInterval = setInterval(() => {
                this.refreshUnreadCount();
            }, 3000);
        },
        
        // V√©rifier les nouveaux messages dans une conversation sp√©cifique
        async checkConversationMessages() {
            if (!this.selectedConversation) return;
            
            try {
                const response = await fetch(`/chat/conversation/${this.selectedConversation.id}`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                if (data.messages && data.messages.length > 0) {
                    // Comparer avec les messages actuels
                    const lastMessageId = this.messages.length > 0 ? this.messages[this.messages.length - 1].id : null;
                    const newLastMessageId = data.messages[data.messages.length - 1].id;
                    
                    if (newLastMessageId !== lastMessageId) {
                        console.log('üì® Nouveaux messages d√©tect√©s dans la conversation active');
                        
                        // Pr√©server le statut 'me' pour nos propres messages
                        const processedMessages = data.messages.map(msg => {
                            if (msg.sender === 'coach') return { ...msg, sender: 'me' };
                            return msg;
                        });
                        
                        const oldLength = this.messages.length;
                        this.messages = processedMessages;
                        
                        // Jouer un son si c'est un nouveau message de l'autre personne
                        if (processedMessages.length > oldLength) {
                            const newMessages = processedMessages.slice(oldLength);
                            if (newMessages.some(m => m.sender !== 'me')) {
                                this.playNotificationSound();
                            }
                        }
                        
                        // Scroll automatique si on √©tait en bas
                        const container = document.getElementById('messages-container');
                        if (container) {
                            const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100;
                            if (isScrolledToBottom) {
                                this.$nextTick(() => this.scrollToBottom());
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur v√©rification conversation:', error);
            }
        },
        
        // V√©rifier les nouveaux messages dans toutes les conversations
        async checkForNewMessages() {
            try {
                // Pour chaque conversation, v√©rifier si elle a de nouveaux messages
                for (let conv of this.conversations) {
                    // Ignorer la conversation active (d√©j√† v√©rifi√©e)
                    if (this.selectedConversation && this.selectedConversation.id === conv.id) {
                        continue;
                    }
                    
                    try {
                        const response = await fetch(`/chat/conversation/${conv.id}/last-message`);
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        
                        // V√©rifier si c'est un nouveau message
                        if (data.id && this.lastMessageIds[conv.id] !== data.id) {
                            console.log(`üì® Nouveau message dans conversation ${conv.id}:`, data);
                            
                            // Mettre √† jour le dernier message connu
                            this.lastMessageIds[conv.id] = data.id;
                            
                            // Incr√©menter le compteur de messages non lus
                            conv.unread = (conv.unread || 0) + 1;
                            
                            // Mettre √† jour le dernier message affich√©
                            conv.lastMessage = data.content.substring(0, 50) + (data.content.length > 50 ? '...' : '');
                            conv.time = data.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            
                            // Afficher le toast
                            this.showToast({
                                title: `Nouveau message de ${conv.client}`,
                                message: data.content.substring(0, 100) + (data.content.length > 100 ? '...' : ''),
                                conversationId: conv.id,
                                time: data.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                type: 'info'
                            });
                            
                            // Ajouter √† l'historique
                            this.addToHistory({
                                title: `Message de ${conv.client}`,
                                message: data.content.substring(0, 100) + (data.content.length > 100 ? '...' : ''),
                                sender: conv.client,
                                conversationId: conv.id,
                                time: data.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                            });
                            
                            // Jouer le son
                            this.playNotificationSound();
                        }
                    } catch (e) {
                        // Ignorer les erreurs pour cette conversation
                    }
                }
                
                this.calculateStats();
                this.filterConversations();
                
            } catch (error) {
                console.error('Erreur lors de la v√©rification des messages:', error);
            }
        },
        
        // Calculer les statistiques
        calculateStats() {
            this.totalUnread = this.conversations.reduce((sum, conv) => sum + (conv.unread || 0), 0);
            this.onlineCount = this.conversations.filter(conv => conv.online).length;
        },
        
        // Filtrer les conversations
        filterConversations() {
            if (!this.searchQuery) {
                this.filteredConversations = [...this.conversations].sort((a, b) => {
                    // Trier par date du dernier message (plus r√©cent d'abord)
                    if (a.time && b.time) {
                        return b.time.localeCompare(a.time);
                    }
                    return b.time ? 1 : -1;
                });
                return;
            }
            const query = this.searchQuery.toLowerCase();
            this.filteredConversations = this.conversations.filter(conv => 
                conv.client.toLowerCase().includes(query) ||
                (conv.goalTitle && conv.goalTitle.toLowerCase().includes(query))
            );
        },
        
        // S√©lectionner une conversation
        async selectConversation(conversation) {
            if (!conversation) return;
            
            this.selectedConversation = conversation;
            await this.loadMessages(conversation.id);
            
            // Marquer comme lu
            const oldUnread = conversation.unread;
            conversation.unread = 0;
            this.calculateStats();
            
            // Mettre √† jour le dernier message connu
            if (this.messages.length > 0) {
                this.lastMessageIds[conversation.id] = this.messages[this.messages.length - 1].id;
            }
            
            // Marquer les notifications comme lues
            this.notifications = this.notifications.map(n => {
                if (n.conversationId === conversation.id) {
                    return { ...n, read: true };
                }
                return n;
            });
            
            // Si c'√©tait un message non lu, jouer un son
            if (oldUnread > 0) {
                this.playNotificationSound();
            }
        },
        
        // Charger les messages
        async loadMessages(conversationId, preserveScroll = false) {
            try {
                const response = await fetch(`/chat/conversation/${conversationId}`);
                if (!response.ok) {
                    throw new Error('Erreur lors du chargement');
                }
                const data = await response.json();
                
                // Pr√©server le statut 'me' pour nos propres messages
                const processedMessages = data.messages.map(msg => {
                    if (msg.sender === 'coach') return { ...msg, sender: 'me' };
                    return msg;
                });
                
                const wasAtBottom = preserveScroll ? false : true;
                const oldLength = this.messages.length;
                
                this.messages = processedMessages;
                
                // Mettre √† jour le dernier message connu
                if (this.messages.length > 0) {
                    this.lastMessageIds[conversationId] = this.messages[this.messages.length - 1].id;
                }
                
                // Jouer un son si de nouveaux messages sont arriv√©s
                if (preserveScroll && processedMessages.length > oldLength) {
                    const newMessages = processedMessages.slice(oldLength);
                    if (newMessages.some(m => m.sender !== 'me')) {
                        this.playNotificationSound();
                    }
                }
                
                this.$nextTick(() => {
                    if (!preserveScroll) {
                        this.scrollToBottom();
                    }
                });
                
            } catch (error) {
                console.error('Erreur chargement messages:', error);
                this.showToast({
                    title: 'Erreur',
                    message: 'Impossible de charger les messages',
                    type: 'error'
                });
            }
        },
        
        // Envoyer un message
        async sendMessage() {
            if (!this.newMessage.trim() || !this.selectedConversation) return;
            
            const content = this.newMessage;
            this.newMessage = '';
            
            // Message temporaire
            const tempMessage = {
                id: 'temp-' + Date.now(),
                sender: 'me',
                content: content,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                date: new Date().toISOString().split('T')[0]
            };
            this.messages.push(tempMessage);
            this.scrollToBottom();
            
            try {
                const response = await fetch(`/chat/send/${this.selectedConversation.id}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'content=' + encodeURIComponent(content)
                });
                
                if (!response.ok) {
                    throw new Error('Erreur envoi');
                }
                
                const data = await response.json();
                data.date = new Date().toISOString().split('T')[0];
                
                // Remplacer le message temporaire
                const index = this.messages.findIndex(m => m.id === tempMessage.id);
                if (index !== -1) {
                    this.messages[index] = data;
                }
                
                // Mettre √† jour le dernier message connu
                this.lastMessageIds[this.selectedConversation.id] = data.id;
                
                // Mettre √† jour la derni√®re conversation
                const convIndex = this.conversations.findIndex(c => c.id === this.selectedConversation.id);
                if (convIndex !== -1) {
                    this.conversations[convIndex].lastMessage = content.substring(0, 50) + (content.length > 50 ? '...' : '');
                    this.conversations[convIndex].time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
            } catch (error) {
                console.error('Erreur envoi message:', error);
                // Supprimer le message temporaire
                this.messages = this.messages.filter(m => m.id !== tempMessage.id);
                this.showToast({
                    title: 'Erreur',
                    message: '√âchec de l\'envoi du message',
                    type: 'error'
                });
            }
        },
        
        // G√©rer la frappe
        handleTyping() {
            if (!this.selectedConversation) return;
            
            // Ici vous pourriez envoyer un signal "typing" au serveur
            // Pour l'instant, on se contente de clear le timeout
            clearTimeout(this.typingTimeout);
            
            this.typingTimeout = setTimeout(() => {
                // Fin de la frappe
            }, 1000);
        },
        
        // Rafra√Æchir le compteur de messages non lus
        async refreshUnreadCount() {
            try {
                const response = await fetch('/chat/unread/count');
                if (!response.ok) return;
                
                const data = await response.json();
                
                let hasChanges = false;
                for (let conv of this.conversations) {
                    const newUnread = data.byConversation[conv.id] || 0;
                    if (conv.unread !== newUnread) {
                        conv.unread = newUnread;
                        hasChanges = true;
                    }
                }
                
                if (hasChanges) {
                    this.calculateStats();
                    this.filterConversations();
                }
                
            } catch (error) {
                console.error('Erreur rafra√Æchissement compteur:', error);
            }
        },
        
        // Ajouter √† l'historique des notifications
        addToHistory(data) {
            if (!data || !data.message) return;
            
            // √âviter les doublons (dans les 5 secondes)
            const exists = this.notifications.some(n => 
                n.conversationId === data.conversationId && 
                n.message === data.message &&
                Math.abs(new Date() - new Date(n.time || Date.now())) < 5000
            );
            
            if (!exists) {
                this.notifications.unshift({
                    id: 'notif-' + Date.now() + '-' + Math.random(),
                    title: data.title || 'Nouveau message',
                    message: data.message,
                    sender: data.sender || 'Quelqu\'un',
                    conversationId: data.conversationId,
                    time: data.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    read: false
                });
                
                // Limiter √† 50 notifications
                if (this.notifications.length > 50) {
                    this.notifications = this.notifications.slice(0, 50);
                }
                
                // Mettre √† jour le compteur
                this.totalUnread = this.notifications.filter(n => !n.read).length;
            }
        },
        
        // Afficher un toast
        showToast(data) {
            if (!data) return;
            
            console.log('üçû Affichage toast:', data);
            
            const id = 'toast-' + Date.now() + '-' + Math.random();
            
            this.toasts.push({
                id: id,
                title: data.title || 'Notification',
                message: data.message || 'Nouvelle notification',
                time: data.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                type: data.type || 'info',
                conversationId: data.conversationId,
                visible: true
            });
            
            // Dispara√Æt apr√®s 5 secondes
            setTimeout(() => {
                const toast = this.toasts.find(t => t.id === id);
                if (toast) toast.visible = false;
                
                // Supprimer compl√®tement apr√®s l'animation
                setTimeout(() => {
                    this.toasts = this.toasts.filter(t => t.id !== id);
                }, 300);
                
            }, 5000);
        },
        
        // Tester les notifications
        testNotification() {
            this.showToast({
                title: 'Test de notification',
                message: 'Ceci est un message de test - ' + new Date().toLocaleTimeString(),
                type: 'success'
            });
            
            this.addToHistory({
                title: 'Test de notification',
                message: 'Ceci est un message de test',
                sender: 'Syst√®me',
                conversationId: null,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            
            // Ajouter aussi une notification de test
            this.notifications.unshift({
                id: 'test-' + Date.now(),
                title: 'Test de notification',
                message: 'Ceci est une notification de test',
                sender: 'Syst√®me',
                conversationId: null,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                read: false
            });
            
            this.playNotificationSound();
        },
        
        // Jouer un son de notification
        playNotificationSound() {
            try {
                const audio = new Audio('/sounds/notification.mp3');
                audio.volume = 0.3;
                audio.play().catch(err => console.log('üîá Son bloqu√©:', err));
            } catch (error) {
                console.log('üîá Erreur son:', error);
            }
        },
        
        // Scroll vers le bas
        scrollToBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }
        },
        
        // Nettoyage
        destroy() {
            if (this.pollingInterval) clearInterval(this.pollingInterval);
            if (this.messageCheckInterval) clearInterval(this.messageCheckInterval);
            if (this.unreadCheckInterval) clearInterval(this.unreadCheckInterval);
        }
    }
}
</script>
{% endblock %}