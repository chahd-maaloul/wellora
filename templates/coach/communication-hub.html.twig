{% extends 'layouts/app.html.twig' %}

{% block title %}{{ pageTitle }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('coach') }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('coach') }}
{% endblock %}

{% block body %}
<div x-data="communicationHub()" class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm dark:bg-gray-800 dark:border-gray-700">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="{{ path('coach_dashboard') }}" class="p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="text-gray-600 fas fa-arrow-left dark:text-gray-400"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="mr-2 fas fa-comments text-wellcare-500"></i>
                            {{ 'Communication Hub' }}
                        </h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ 'Stay connected with your clients' }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="openBroadcastModal()" class="flex items-center gap-2 px-4 py-2 font-medium text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                        <i class="fas fa-bullhorn"></i>
                        {{ 'Broadcast Message' }}
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="p-6">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
            <!-- Conversations List -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-100 shadow-sm rounded-xl dark:bg-gray-800 dark:border-gray-700">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <input 
                            type="text" 
                            x-model="searchQuery"
                            placeholder="{{ 'Search conversations...' }}"
                            class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500">
                    </div>
                    
                    <div class="divide-y divide-gray-100 dark:divide-gray-700 max-h-[600px] overflow-y-auto">
                        {% for conversation in conversations %}
                        <button 
                            @click="selectConversation({{ conversation.id }})"
                            :class="{'bg-wellcare-50 dark:bg-wellcare-900/20': selectedConversationId === {{ conversation.id }}}"
                            class="flex items-center w-full gap-3 p-4 transition-colors hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="relative">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                    <span class="font-medium text-wellcare-600 dark:text-wellcare-400">{{ conversation.avatar }}</span>
                                </div>
                                {% if conversation.online %}
                                <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full dark:border-gray-800"></span>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0 text-left">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate dark:text-white">{{ conversation.client }}</p>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ conversation.time }}</span>
                                </div>
                                <p class="text-sm text-gray-500 truncate dark:text-gray-400">{{ conversation.lastMessage }}</p>
                            </div>
                            {% if conversation.unread > 0 %}
                            <span class="flex items-center justify-center w-5 h-5 text-xs text-white rounded-full bg-wellcare-500">{{ conversation.unread }}</span>
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="mt-6 bg-white border border-gray-100 shadow-sm rounded-xl dark:bg-gray-800 dark:border-gray-700">
                    <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                            <i class="mr-2 fas fa-chart-bar text-wellcare-500"></i>
                            {{ 'Message Stats' }}
                        </h2>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">{{ 'Unread Messages' }}</span>
                            <span class="font-semibold text-wellcare-500">
                                {% set totalUnread = 0 %}
                                {% for conv in conversations %}
                                    {% set totalUnread = totalUnread + conv.unread %}
                                {% endfor %}
                                {{ totalUnread }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">{{ 'Online Clients' }}</span>
                            <span class="font-semibold text-green-500">
                                {% set onlineCount = 0 %}
                                {% for conv in conversations %}
                                    {% if conv.online %}
                                        {% set onlineCount = onlineCount + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ onlineCount }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">{{ 'Total Conversations' }}</span>
                            <span class="font-semibold text-gray-900 dark:text-white">{{ conversations|length }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-[calc(100vh-200px)] flex flex-col">
                    <!-- Chat Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                    <span class="font-medium text-wellcare-600 dark:text-wellcare-400">{{ conversations[0].avatar }}</span>
                                </div>
                                {% if conversations[0].online %}
                                <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full dark:border-gray-800"></span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">{{ conversations[0].client }}</p>
                                <p class="text-xs text-green-500">{% if conversations[0].online %}{{ 'Online' }}{% else %}{{ 'Offline' }}{% endif %}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="flex-1 p-4 space-y-4 overflow-y-auto">
                        <!-- Date separator -->
                        <div class="flex items-center justify-center">
                            <span class="px-3 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-400">{{ 'Today' }}</span>
                        </div>

                        <!-- Coach message (right) -->
                        <div class="flex items-start justify-end gap-3">
                            <div class="max-w-md">
                                <div class="p-3 text-white rounded-lg bg-wellcare-500">
                                    <p class="text-sm">Hi! I've reviewed your workout log from yesterday. Great job on the form for those squats!</p>
                                </div>
                                <p class="mt-1 text-xs text-right text-gray-400">10:30 AM</p>
                            </div>
                        </div>

                        <!-- Client message (left) -->
                        <div class="flex items-start gap-3">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                <span class="text-xs font-medium text-wellcare-600 dark:text-wellcare-400">{{ conversations[0].avatar }}</span>
                            </div>
                            <div class="max-w-md">
                                <div class="p-3 bg-gray-100 rounded-lg dark:bg-gray-700">
                                    <p class="text-sm text-gray-900 dark:text-white">Thank you! I really focused on keeping my chest up during the descent.</p>
                                </div>
                                <p class="mt-1 text-xs text-gray-400">10:35 AM</p>
                            </div>
                        </div>

                        <!-- Coach message (right) -->
                        <div class="flex items-start justify-end gap-3">
                            <div class="max-w-md">
                                <div class="p-3 text-white rounded-lg bg-wellcare-500">
                                    <p class="text-sm">That's exactly what we want to see! For today's session, let's add some progressive overload. I've updated your program with a slight increase in weight.</p>
                                </div>
                                <p class="mt-1 text-xs text-right text-gray-400">10:40 AM</p>
                            </div>
                        </div>

                        <!-- Client message with attachment (left) -->
                        <div class="flex items-start gap-3">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-wellcare-100 dark:bg-wellcare-900/30">
                                <span class="text-xs font-medium text-wellcare-600 dark:text-wellcare-400">{{ conversations[0].avatar }}</span>
                            </div>
                            <div class="max-w-md">
                                <div class="p-3 bg-gray-100 rounded-lg dark:bg-gray-700">
                                    <p class="text-sm text-gray-900 dark:text-white">Sounds great! Also, I wanted to ask - is it normal to feel some mild soreness in my shoulders after the pressing movements?</p>
                                </div>
                                <p class="mt-1 text-xs text-gray-400">10:45 AM</p>
                            </div>
                        </div>

                        <!-- Coach message (right) -->
                        <div class="flex items-start justify-end gap-3">
                            <div class="max-w-md">
                                <div class="p-3 text-white rounded-lg bg-wellcare-500">
                                    <p class="text-sm">Mild soreness is normal, especially when introducing new exercises. However, if it persists or becomes sharp pain, please let me know immediately. Keep the foam rolling we discussed after each session.</p>
                                </div>
                                <p class="mt-1 text-xs text-right text-gray-400">10:50 AM</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="p-4 border-t border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <button class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="p-2 text-gray-400 transition-colors hover:text-wellcare-500">
                                <i class="fas fa-image"></i>
                            </button>
                            <input 
                                type="text" 
                                x-model="newMessage"
                                placeholder="{{ 'Type your message...' }}"
                                class="flex-1 px-4 py-2 text-gray-900 border border-gray-300 rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-wellcare-500 focus:border-wellcare-500"
                                @keydown.enter="sendMessage()">
                            <button @click="sendMessage()" class="flex items-center justify-center w-10 h-10 text-white transition-colors rounded-lg bg-wellcare-500 hover:bg-wellcare-600">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function communicationHub() {
    return {
        conversations: {{ conversations|json_encode|raw }},
        selectedConversationId: {{ conversations[0].id }},
        searchQuery: '',
        newMessage: '',
        
        selectConversation(id) {
            this.selectedConversationId = id;
        },
        
        sendMessage() {
            if (this.newMessage.trim()) {
                console.log('Sending message:', this.newMessage);
                this.newMessage = '';
            }
        },
        
        openBroadcastModal() {
            console.log('Open broadcast modal');
        }
    }
}
</script>
{% endblock %}
