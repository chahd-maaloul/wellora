{# templates/health/analytics/patient-view.html.twig #}
{# Patient Analytics Dashboard - Complete Health Metrics & Risk Assessment #}

{% extends 'layouts/app.html.twig' %}

{% block title %}{{ 'Mon Analyse Sant√©'|trans }} - WellCare Connect{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/analytics.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block body %}
<div class="min-h-full bg-gray-50 dark:bg-gray-950" x-data="healthAnalytics()" x-init="init()">
    {# Header Section #}
    <div class="bg-white border-b border-gray-200 dark:bg-gray-900 dark:border-gray-800">
        <div class="px-4 py-6 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                        <i class="mr-2 fa-solid fa-chart-line text-wellcare-500"></i>
                        {{ 'Mon Analyse Sant√©'|trans }}
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        {{ '√âvaluez vos risques de sant√© et suivez votre progression'|trans }}
                    </p>
                    {% if start_date and end_date %}
                    <p class="mt-2 text-sm text-wellcare-600 dark:text-wellcare-400">
                        <i class="fa-solid fa-calendar-range mr-1"></i>
                        {{ 'P√©riode:'|trans }} {{ start_date|date('d/m/Y') }} - {{ end_date|date('d/m/Y') }}
                    </p>
                    {% endif %}
                </div>
                
                {# Journal Selector #}
                <div class="flex items-center gap-3">
                    {% if journals|length > 0 %}
                    <div class="relative w-64">
                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">{{ 'S√©lectionner le journal'|trans }}</label>
                        <select x-model="selectedJournalId" @change="updateJournal" class="w-full input">
                            <option value="">{{ 'Tous les journaux'|trans }}</option>
                            {% for journal in journals %}
                            <option value="{{ journal.id }}">{{ journal.datedebut|date('d/m/Y') }} - {{ journal.datefin|date('d/m/Y') }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
            </div>
        </div>
    </div>

    <div class="px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8">
        {# Global Health Score #}
        <div class="p-6 mb-8 text-white shadow-lg bg-gradient-to-r from-wellcare-500 to-wellcare-light-500 rounded-2xl">
            <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
                <div class="flex items-center gap-4 md:col-span-1">
                    <div class="relative">
                        <svg class="w-28 h-28 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="8"/>
                            <circle cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="8"
                                    :stroke-dasharray="283" :stroke-dashoffset="283 - (283 * globalScore / 100)"
                                    stroke-linecap="round" class="transition-all duration-1000"/>
                        </svg>
                        <div class="absolute transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 text-center">
                            <span class="text-4xl font-bold" x-text="globalScore"></span>
                            <span class="text-xs block" x-text="globalScoreLabel"></span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-medium opacity-90">{{ 'Score Sant√© Global'|trans }}</p>
                        <p class="text-xs opacity-75" x-text="globalScoreDescription"></p>
                    </div>
                </div>
                
                {# Score Breakdown #}
                <div class="grid grid-cols-5 gap-2 md:col-span-3">
                    <template x-for="(metric, index) in scoreBreakdown" :key="index">
                        <div class="p-3 bg-white/10 rounded-xl text-center">
                            <div class="flex items-center justify-center mb-1">
                                <i :class="metric.icon + ' text-lg'" :style="'color: ' + metric.color"></i>
                            </div>
                            <p class="text-xs opacity-75" x-text="metric.name"></p>
                            <p class="text-lg font-bold" :style="'color: ' + getScoreColor(metric.score)" x-text="metric.score"></p>
                            <p class="text-xs opacity-75" x-text="metric.weight + '%'"></p>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        {# Risk Metrics Grid #}
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fa-solid fa-heart-pulse mr-2 text-wellcare-500"></i>
            {{ 'M√©triques de Risque'|trans }}
        </h2>
        
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
            {# 1. Glycemic Risk #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-droplet text-red-500 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ 'Risque Glyc√©mique'|trans }}</h3>
                            <p class="text-xs text-gray-500">{{ 'Glyc√©mie (g/L)'|trans }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          :class="glycemicStatus.class" x-text="glycemicStatus.text"></span>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Moyenne'|trans }}</p>
                        <p class="text-xl font-bold" :class="glycemicStatus.class" x-text="avgGlycemia.toFixed(2)"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Min'|trans }}</p>
                        <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="minGlycemia.toFixed(2)"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Max'|trans }}</p>
                        <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="maxGlycemia.toFixed(2)"></p>
                    </div>
                </div>
                
                {# Score Bar #}
                <div class="mb-2">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-600 dark:text-gray-400">{{ 'Score Glyc√©mique'|trans }}</span>
                        <span class="text-sm font-bold" :style="'color: ' + getScoreColor(glycemicScore)" x-text="glycemicScore"></span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div class="h-3 rounded-full transition-all duration-500"
                             :style="'width: ' + glycemicScore + '%; background-color: ' + getScoreColor(glycemicScore)"></div>
                    </div>
                </div>
                
                <div class="flex justify-between text-xs text-gray-500">
                    <span>40 (üî¥ Risque √©lev√©)</span>
                    <span>70</span>
                    <span>100 (üü¢ Normal)</span>
                </div>
                
                <div class="h-48 mt-4">
                    <canvas id="glycemiaChart"></canvas>
                </div>
            </div>

            {# 2. Cardiovascular Risk #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-heart text-red-500 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ 'Risque Cardiovasculaire'|trans }}</h3>
                            <p class="text-xs text-gray-500">{{ 'Tension (mmHg)'|trans }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          :class="bpStatus.class" x-text="bpStatus.text"></span>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Systolique'|trans }}</p>
                        <p class="text-xl font-bold" :class="bpStatus.class" x-text="avgSystolic"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Diastolique'|trans }}</p>
                        <p class="text-xl font-bold" :class="bpStatus.class" x-text="avgDiastolic"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Score'|trans }}</p>
                        <p class="text-xl font-bold" :style="'color: ' + getScoreColor(bpScore)" x-text="bpScore"></p>
                    </div>
                </div>
                
                {# BP Zones #}
                <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-green-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">< 120/80 - {{ 'Normal'|trans }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-orange-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">120-139/80-89 - {{ 'Pr√©-hypertension'|trans }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-red-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">‚â• 140/90 - {{ 'Hypertension'|trans }}</span>
                    </div>
                </div>
                
                <div class="h-48 mt-4">
                    <canvas id="bpChart"></canvas>
                </div>
            </div>

            {# 3. Sleep/Fatigue Risk #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-bed text-indigo-500 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ 'Risque Fatigue/Burnout'|trans }}</h3>
                            <p class="text-xs text-gray-500">{{ 'Sommeil'|trans }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          :class="sleepStatus.class" x-text="sleepStatus.text"></span>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Heures moy.'|trans }}</p>
                        <p class="text-xl font-bold" :class="sleepStatus.class" x-text="avgSleep.toFixed(1) + 'h'"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Qualit√© moy.'|trans }}</p>
                        <p class="text-xl font-bold" :class="sleepStatus.class" x-text="avgSleepQuality + '/5'"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Score'|trans }}</p>
                        <p class="text-xl font-bold" :style="'color: ' + getScoreColor(sleepScore)" x-text="sleepScore"></p>
                    </div>
                </div>
                
                {# Sleep Score Formula #}
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg mb-4">
                    <p class="text-xs text-gray-500 mb-2">{{ 'Calcul du score'|trans }}:</p>
                    <div class="flex justify-between text-sm">
                        <span>8h + qualit√© 5 = 100</span>
                        <span>6h + qualit√© 3 = 60</span>
                        <span><5h = 30</span>
                    </div>
                </div>
                
                <div class="h-48 mt-4">
                    <canvas id="sleepChart"></canvas>
                </div>
            </div>

            {# 4. Symptomatic Risk #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-face-frown text-orange-500 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ 'Risque Symptomatique'|trans }}</h3>
                            <p class="text-xs text-gray-500">{{ 'Intensit√© des sympt√¥mes'|trans }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          :class="symptomStatus.class" x-text="symptomStatus.text"></span>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Nb sympt√¥mes'|trans }}</p>
                        <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="totalSymptoms"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Intensit√© moy.'|trans }}</p>
                        <p class="text-xl font-bold" :class="symptomStatus.class" x-text="avgIntensity.toFixed(1)"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Score'|trans }}</p>
                        <p class="text-xl font-bold" :style="'color: ' + getScoreColor(symptomScore)" x-text="symptomScore"></p>
                    </div>
                </div>
                
                {# Intensity Zones #}
                <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-green-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">‚â§ 3 - {{ 'Normal'|trans }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-orange-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">4-6 - {{ 'Pr√©-alerte'|trans }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-red-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400">‚â• 7 + 3 jours - {{ 'Alerte'|trans }}</span>
                    </div>
                </div>
                
                <div class="h-48 mt-4">
                    <canvas id="symptomChart"></canvas>
                </div>
            </div>
        </div>

        {# 5. Weight Risk & Combined Charts #}
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fa-solid fa-scale-balanced mr-2 text-wellcare-500"></i>
            {{ 'Poids & Variations'|trans }}
        </h2>
        
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3 mb-8">
            {# Weight Risk Card #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-weight-scale text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ 'Risque Li√© au Poids'|trans }}</h3>
                            <p class="text-xs text-gray-500">{{ 'Variation et IMC'|trans }}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          :class="weightStatus.class" x-text="weightStatus.text"></span>
                </div>
                
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Poids actuel'|trans }}</p>
                        <p class="text-xl font-bold text-gray-900 dark:text-white" x-text="currentWeight + ' kg'"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Variation'|trans }}</p>
                        <p class="text-xl font-bold" :class="weightVariation > 2 || weightVariation < -2 ? 'text-red-500' : 'text-green-500'" 
                           x-text="(weightVariation >= 0 ? '+' : '') + weightVariation.toFixed(1) + ' kg'"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'IMC'|trans }}</p>
                        <p class="text-xl font-bold" :style="'color: ' + getScoreColor(weightScore)" x-text="bmi.toFixed(1)"></p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500">{{ 'Score'|trans }}</p>
                        <p class="text-xl font-bold" :style="'color: ' + getScoreColor(weightScore)" x-text="weightScore"></p>
                    </div>
                </div>
                
                {# Weight Chart #}
                <div class="h-64">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            {# Alertes #}
            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i>
                    {{ 'Alertes Actives'|trans }}
                </h3>
                
                <div class="space-y-3">
                    <template x-for="alert in activeAlerts" :key="alert.id">
                        <div class="p-3 rounded-lg border"
                             :class="alert.severity === 'critical' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : 
                                     alert.severity === 'warning' ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800' :
                                     'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'">
                            <div class="flex items-start gap-3">
                                <i :class="alert.icon + ' text-lg mt-0.5'" 
                                   :class="alert.severity === 'critical' ? 'text-red-500' : 
                                           alert.severity === 'warning' ? 'text-orange-500' : 'text-green-500'"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="alert.title"></p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400" x-text="alert.description"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="activeAlerts.length === 0" class="p-4 text-center text-gray-500">
                        <i class="fa-solid fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p>{{ 'Aucune alerte active'|trans }}</p>
                    </div>
                </div>
            </div>
        </div>

        {# Combined Trends #}
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fa-solid fa-chart-line mr-2 text-wellcare-500"></i>
            {{ 'Tendances Combin√©es'|trans }}
        </h2>
        
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 mb-8">
            <div class="h-80">
                <canvas id="combinedChart"></canvas>
            </div>
        </div>

        {# Recommendations #}
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
            <i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>
            {{ 'Recommandations'|trans }}
        </h2>
        
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
            <template x-for="rec in recommendations" :key="rec.id">
                <div class="p-4 rounded-xl border transition-all duration-300 hover:shadow-md"
                     :class="rec.priority === 'high' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : 
                             rec.priority === 'medium' ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800' :
                             'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center"
                             :class="rec.priority === 'high' ? 'bg-red-100 dark:bg-red-900/50' : 
                                     rec.priority === 'medium' ? 'bg-orange-100 dark:bg-orange-900/50' :
                                     'bg-green-100 dark:bg-green-900/50'">
                            <i :class="rec.icon + ' text-lg'" 
                               :class="rec.priority === 'high' ? 'text-red-500' : 
                                       rec.priority === 'medium' ? 'text-orange-500' : 'text-green-500'"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white" x-text="rec.title"></h4>
                            <p class="mt-1 text-xs text-gray-600 dark:text-gray-400" x-text="rec.description"></p>
                            <span class="inline-block mt-2 text-xs px-2 py-0.5 rounded"
                                  :class="rec.priority === 'high' ? 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300' : 
                                          rec.priority === 'medium' ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300' :
                                          'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300'"
                                  x-text="rec.priorityLabel"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('healthAnalytics', () => ({
        selectedJournalId: '{{ selected_journal_id|default('')|e('js') }}',
        startDate: '{{ start_date|default('')|e('js') }}',
        endDate: '{{ end_date|default('')|e('js') }}',
        
        // Real data from controller
        glycemicData: {{ glycemic_data|default([0.95, 1.02, 0.88, 1.08, 0.92, 1.15, 0.98])|json_encode|raw }},
        bpSystolic: {{ bp_systolic|default([118, 122, 120, 125, 119, 128, 121])|json_encode|raw }},
        bpDiastolic: {{ bp_diastolic|default([78, 80, 76, 82, 77, 84, 79])|json_encode|raw }},
        sleepData: {{ sleep_data|default([7.5, 6.5, 8.0, 7.0, 6.0, 7.5, 8.5])|json_encode|raw }},
        sleepQuality: [4, 3, 5, 4, 2, 4, 5], // Default quality values
        weightData: {{ weight_data|default([72.5, 72.0, 71.8, 72.2, 71.5, 71.0, 70.8])|json_encode|raw }},
        symptomIntensity: {{ symptom_intensity|default([3, 4, 2, 5, 3, 6, 2])|json_encode|raw }},
        chartLabels: {{ dates|default(['Jour 1', 'Jour 2', 'Jour 3', 'Jour 4', 'Jour 5', 'Jour 6', 'Jour 7'])|json_encode|raw }},
        
        // Calculated averages from real data
        avgGlycemia: {{ avg_glycemia|default(0.98) }},
        minGlycemia: {{ min_glycemia|default(0.88) }},
        maxGlycemia: {{ max_glycemia|default(1.15) }},
        avgSystolic: {{ avg_systolic|default(122) }},
        avgDiastolic: {{ avg_diastolic|default(79) }},
        avgSleep: {{ avg_sleep|default(7.2) }},
        avgSleepQuality: 3.9,
        currentWeight: {{ current_weight|default(70.8) }},
        weightVariation: {{ weight_variation|default(-1.7) }},
        bmi: 23.2,
        avgIntensity: {{ avg_intensity|default(3.6) }},
        totalSymptoms: {{ total_symptoms|default(7) }},
        
        // Scores (0-100)
        glycemicScore: 85,
        bpScore: 78,
        sleepScore: 72,
        symptomScore: 80,
        weightScore: 88,
        globalScore: 80,
        
        // Charts
        charts: {},
        
        init() {
            this.calculateMetrics();
            this.initCharts();
        },
        
        calculateMetrics() {
            // Calculate glycemic score
            if (this.avgGlycemia < 0.70) {
                this.glycemicScore = 40;
            } else if (this.avgGlycemia <= 1.10) {
                this.glycemicScore = 100;
            } else if (this.avgGlycemia <= 1.25) {
                this.glycemicScore = 70;
            } else {
                this.glycemicScore = 40;
            }
            
            // Calculate BP score
            if (this.avgSystolic >= 140 || this.avgDiastolic >= 90) {
                this.bpScore = 40;
            } else if (this.avgSystolic >= 120 || this.avgDiastolic >= 80) {
                this.bpScore = 70;
            } else {
                this.bpScore = 100;
            }
            
            // Calculate sleep score
            if (this.avgSleep < 5) {
                this.sleepScore = 30;
            } else if (this.avgSleep < 6 || this.avgSleepQuality <= 2) {
                this.sleepScore = 60;
            } else {
                this.sleepScore = Math.min(100, Math.round(this.avgSleep * 10 + this.avgSleepQuality * 5));
            }
            
            // Calculate symptom score
            const highIntensityDays = this.symptomIntensity.filter(i => i >= 7).length;
            if (highIntensityDays >= 3) {
                this.symptomScore = 40;
            } else if (this.avgIntensity >= 7) {
                this.symptomScore = 60;
            } else if (this.avgIntensity >= 4) {
                this.symptomScore = 70;
            } else {
                this.symptomScore = 100 - (this.avgIntensity * 5);
            }
            
            // Calculate weight score
            if (Math.abs(this.weightVariation) > 2) {
                this.weightScore = 60;
            } else if (this.bmi > 30) {
                this.weightScore = 50;
            } else {
                this.weightScore = 88;
            }
            
            // Calculate global score (weighted average)
            this.globalScore = Math.round(
                this.glycemicScore * 0.30 +
                this.bpScore * 0.25 +
                this.sleepScore * 0.20 +
                this.weightScore * 0.15 +
                this.symptomScore * 0.10
            );
        },
        
        get glycemicStatus() {
            if (this.avgGlycemia < 0.70) return { text: 'Hypoglyc√©mie üî¥', class: 'text-red-500' };
            if (this.avgGlycemia <= 1.10) return { text: 'Normal üü¢', class: 'text-green-500' };
            if (this.avgGlycemia <= 1.25) return { text: 'Pr√©-alerte üü†', class: 'text-orange-500' };
            return { text: 'Hyperglyc√©mie üî¥', class: 'text-red-500' };
        },
        
        get bpStatus() {
            if (this.avgSystolic >= 140 || this.avgDiastolic >= 90) return { text: 'Hypertension üî¥', class: 'text-red-500' };
            if (this.avgSystolic >= 120 || this.avgDiastolic >= 80) return { text: 'Pr√©-hypertension üü†', class: 'text-orange-500' };
            return { text: 'Normal üü¢', class: 'text-green-500' };
        },
        
        get sleepStatus() {
            if (this.avgSleep < 5) return { text: 'Risque √©lev√© üî¥', class: 'text-red-500' };
            if (this.avgSleep < 6 || this.avgSleepQuality <= 2) return { text: 'Attention üü†', class: 'text-orange-500' };
            return { text: 'Normal üü¢', class: 'text-green-500' };
        },
        
        get symptomStatus() {
            const highDays = this.symptomIntensity.filter(i => i >= 7).length;
            if (highDays >= 3 || this.avgIntensity >= 7) return { text: 'Alerte üî¥', class: 'text-red-500' };
            if (this.avgIntensity >= 4) return { text: 'Pr√©-alerte üü†', class: 'text-orange-500' };
            return { text: 'Normal üü¢', class: 'text-green-500' };
        },
        
        get weightStatus() {
            if (Math.abs(this.weightVariation) > 2) return { text: 'Variation anormale üî¥', class: 'text-red-500' };
            if (this.bmi > 30) return { text: 'IMC √©lev√© üü†', class: 'text-orange-500' };
            return { text: 'Normal üü¢', class: 'text-green-500' };
        },
        
        get globalScoreLabel() {
            if (this.globalScore >= 80) return 'Bon √©quilibre üü¢';
            if (this.globalScore >= 60) return '√Ä surveiller üü†';
            return 'Risque √©lev√© üî¥';
        },
        
        get globalScoreDescription() {
            if (this.globalScore >= 80) return '{{ 'Excellent √©tat de sant√©'|trans }}';
            if (this.globalScore >= 60) return '{{ 'Beberapa indicateurs √† surveiller'|trans }}';
            return '{{ 'Consultation recommand√©e'|trans }}';
        },
        
        get scoreBreakdown() {
            return [
                { name: '{{ 'Glyc√©mie'|trans }}', score: this.glycemicScore, weight: 30, icon: 'fa-droplet', color: '#ef4444' },
                { name: '{{ 'Tension'|trans }}', score: this.bpScore, weight: 25, icon: 'fa-heart', color: '#f97316' },
                { name: '{{ 'Sommeil'|trans }}', score: this.sleepScore, weight: 20, icon: 'fa-bed', color: '#8b5cf6' },
                { name: '{{ 'Poids'|trans }}', score: this.weightScore, weight: 15, icon: 'fa-weight-scale', color: '#3b82f6' },
                { name: '{{ 'Sympt√¥mes'|trans }}', score: this.symptomScore, weight: 10, icon: 'fa-face-frown', color: '#22c55e' }
            ];
        },
        
        get activeAlerts() {
            const alerts = [];
            if (this.glycemicScore < 70) {
                alerts.push({
                    id: 1,
                    title: '{{ 'Risque glyc√©mique'|trans }}',
                    description: '{{ 'Glyc√©mie en dehors de la plage normale'|trans }}',
                    severity: this.glycemicScore < 50 ? 'critical' : 'warning',
                    icon: 'fa-droplet'
                });
            }
            if (this.bpScore < 70) {
                alerts.push({
                    id: 2,
                    title: '{{ 'Tension √©lev√©e'|trans }}',
                    description: '{{ 'Risque d\'hypertension d√©tect√©'|trans }}',
                    severity: this.bpScore < 50 ? 'critical' : 'warning',
                    icon: 'fa-heart-pulse'
                });
            }
            if (this.sleepScore < 70) {
                alerts.push({
                    id: 3,
                    title: '{{ 'Sommeil insuffisant'|trans }}',
                    description: '{{ 'Moins de 6h de sommeil par nuit'|trans }}',
                    severity: 'warning',
                    icon: 'fa-bed'
                });
            }
            if (Math.abs(this.weightVariation) > 2) {
                alerts.push({
                    id: 4,
                    title: '{{ 'Variation de poids'|trans }}',
                    description: '{{ 'Variation de plus de 2kg en une semaine'|trans }}',
                    severity: 'warning',
                    icon: 'fa-scale-balanced'
                });
            }
            return alerts;
        },
        
        get recommendations() {
            const recs = [];
            
            if (this.globalScore < 60) {
                recs.push({
                    id: 1,
                    title: '{{ 'Consultation m√©dicale'|trans }}',
                    description: '{{ 'Votre score de sant√© global est bas. Consultez un professionnel de sant√©.'|trans }}',
                    priority: 'high',
                    priorityLabel: '{{ 'Priorit√© haute'|trans }}',
                    icon: 'fa-user-doctor'
                });
            }
            
            if (this.glycemicScore < 80) {
                recs.push({
                    id: 2,
                    title: '{{ 'Contr√¥le glyc√©mique'|trans }}',
                    description: '{{ 'Surveillez votre glyc√©mie et adoptez une alimentation √©quilibr√©e.'|trans }}',
                    priority: this.glycemicScore < 60 ? 'high' : 'medium',
                    priorityLabel: '{{ 'Surveillance'|trans }}',
                    icon: 'fa-utensils'
                });
            }
            
            if (this.bpScore < 80) {
                recs.push({
                    id: 3,
                    title: '{{ 'Gestion de la tension'|trans }}',
                    description: '{{ 'R√©duisez le sel, faites de l\'exercice r√©guli√®rement.'|trans }}',
                    priority: this.bpScore < 60 ? 'high' : 'medium',
                    priorityLabel: '{{ 'Mode de vie'|trans }}',
                    icon: 'fa-person-running'
                });
            }
            
            if (this.sleepScore < 80) {
                recs.push({
                    id: 4,
                    title: '{{ 'Am√©liorer le sommeil'|trans }}',
                    description: '{{ 'Ciblez 7-8h de sommeil par nuit avec une routine r√©guli√®re.'|trans }}',
                    priority: 'medium',
                    priorityLabel: '{{ 'Bien-√™tre'|trans }}',
                    icon: 'fa-moon'
                });
            }
            
            if (recs.length === 0) {
                recs.push({
                    id: 5,
                    title: '{{ 'Excellent travail !'|trans }}',
                    description: '{{ 'Tous vos indicateurs sont dans les normes. Continuez ainsi.'|trans }}',
                    priority: 'low',
                    priorityLabel: '{{ 'F√©licitations'|trans }}',
                    icon: 'fa-trophy'
                });
            }
            
            return recs;
        },
        
        getScoreColor(score) {
            if (score >= 80) return '#22c55e'; // green
            if (score >= 60) return '#f97316'; // orange
            return '#ef4444'; // red
        },
        
        initCharts() {
            const labels = this.chartLabels;
            
            // Glycemia Chart
            this.charts.glycemia = new Chart(document.getElementById('glycemiaChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '{{ 'Glyc√©mie (g/L)'|trans }}',
                        data: this.glycemicData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: this.glycemicData.map(v => v >= 0.70 && v <= 1.10 ? '#22c55e' : v > 1.10 ? '#ef4444' : '#f97316')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0.5, max: 1.5 } }
                }
            });
            
            // BP Chart
            this.charts.bp = new Chart(document.getElementById('bpChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '{{ 'Systolique'|trans }}',
                            data: this.bpSystolic,
                            borderColor: '#ef4444',
                            tension: 0.4
                        },
                        {
                            label: '{{ 'Diastolique'|trans }}',
                            data: this.bpDiastolic,
                            borderColor: '#3b82f6',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            
            // Sleep Chart
            this.charts.sleep = new Chart(document.getElementById('sleepChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '{{ 'Heures'|trans }}',
                        data: this.sleepData,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '{{ 'Qualit√©'|trans }}',
                        data: this.sleepQuality,
                        type: 'line',
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, max: 12 },
                        y1: { beginAtZero: true, max: 5, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
            
            // Symptom Chart
            this.charts.symptom = new Chart(document.getElementById('symptomChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '{{ 'Intensit√©'|trans }}',
                        data: this.symptomIntensity,
                        backgroundColor: this.symptomIntensity.map(v => v <= 3 ? '#22c55e' : v <= 6 ? '#f97316' : '#ef4444'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });
            
            // Weight Chart
            this.charts.weight = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '{{ 'Poids (kg)'|trans }}',
                        data: this.weightData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Combined Chart
            this.charts.combined = new Chart(document.getElementById('combinedChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '{{ 'Glyc√©mie'|trans }}',
                            data: this.glycemicData.map(v => v * 100),
                            borderColor: '#ef4444',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: '{{ 'Tension syst.'|trans }}',
                            data: this.bpSystolic,
                            borderColor: '#f97316',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: '{{ 'Sommeil'|trans }}',
                            data: this.sleepData,
                            borderColor: '#8b5cf6',
                            tension: 0.4,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { position: 'left', title: { display: true, text: '{{ 'Glyc√©mie'|trans }}' } },
                        y1: { position: 'right', title: { display: true, text: '{{ 'Tension'|trans }}' }, grid: { drawOnChartArea: false } },
                        y2: { display: false }
                    }
                }
            });
        }
    }));
});
</script>
{% endblock %}
